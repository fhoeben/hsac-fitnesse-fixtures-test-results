<html><head><script>var inDapIF=true;</script></head><body leftmargin="0" topmargin="0" marginwidth="0" marginheight="0"><script>var viewReq = new Array();function vu(u) {var i=new Image();i.src=u.replace("&amp;","&");viewReq.push(i);}</script><script>vu("https://securepubads.g.doubleclick.net/pcs/view?xai\x3dAKAOjssllwdtizHBw5yXR0mpWBAHv-8khOOtugw5HHSoLLqiW2FB6Qw9koiv2BulYUnBejv2KSge_W5gqp3XRRJTF77DZUVoqfl9733UGl0nahihlVPYMJhGDeiFsWHj1NrrGuC9s1I03dlUYoyNYw8JLwRqYdJ9DwlHTzyubosNm6oqd4nysl5UHkEnEi6edzQqRgCr801cz4fY9Sxo42_l70dNRKaozwiVPuksXx5kjSpkrv1iHF-2R2sCLc-iy8ox9AuxCdLnSbWQ\x26sig\x3dCg0ArKJSzAoLLPVdgjTcEAE\x26urlfix\x3d1\x26adurl\x3d")</script>



<meta charset="utf-8">
<title>JWPlayer</title>
<style>
@font-face{
  font-family: "autoplay-font";
  src: url('//synacor.autoplay-plugins.static-origin.syn-cdn.com/fonts/autoplay-font.eot');
  src: url('//synacor.autoplay-plugins.static-origin.syn-cdn.com/fonts/autoplay-font.woff') format('woff'),
       url('//synacor.autoplay-plugins.static-origin.syn-cdn.com/fonts/autoplay-font.ttf') format('truetype'),
       url('//synacor.autoplay-plugins.static-origin.syn-cdn.com/fonts/autoplay-font.svg#autoplay-font') format('svg'),
       url('//synacor.autoplay-plugins.static-origin.syn-cdn.com/fonts/autoplay-font.eot?#iefix') format('embedded-opentype');
  font-weight: normal;
  font-style: normal
}
html, body {
  font-family: HelveticaNeue, Arial, sans-serif;
  margin: 0;
  padding: 0;
  border: 0;
  overflow: hidden;
  background: white;
}
h1, h3 {
  font-weight: normal;
}
.icon {
  font-family: "autoplay-font", sans-serif;
  font-size: 17px;
  color: #999;
  width: 20px;
  height: 20px;
  display: inline-block;
  text-align: center;
  margin: 0 2px;
  cursor: pointer;
  vertical-align: middle;
}
.expanded .icon {
  margin-bottom: 5px;
}
.icon:active, .icon:hover, .icon:focus {
  border-radius: 2px;
  color: #009ede;
}
.iconPlay:after {
  content: "\25b6";
}
.iconPause:after {
  content: "\258C\258C";
  letter-spacing: -0.6em;
}
.iconPause {
  text-align: left;
  text-indent: -0.07em;
}
.iconMute:after {
  content: "\1F507";
}
.iconUnmute:after {
  content: "\1F50A";
}
.iconPrevious:after {
  content: "\27E8";
}
.iconNext:after {
  content: "\27E9";
}
.iconAssetIcon:after {
  content: "\27A2";
}
.iconClose:after {
  content: "\2A09";
}
.iconHD {
  font-size: 14px;
  width: 34px;
  margin-top: -6px;
  height: 16px;
  padding-top: 2px;
}
.iconHD.active {
  color: white;
  background-color: #aaa;
  border-radius: 2px;
}
.iconHD:active, .iconHD:hover, .iconHD:focus  {
  color: white;
  background-color: #009ede;
  border-radius: 2px;
}
.iconHD:after {
  content: "HD";
}
.counter {
  color: #999;
  font-size: 11px;
  display: none;
  vertical-align: super;
}
.adColor {
  position: absolute;
  background-color: black;
  width: 1px;
  height: 1px;
  z-index: 2;
}
#adColorLeft {
  top: 0;
  left: 0;
}
#adColorRight {
  top: 0;
  right: 0;
}
#nowPlayingBackground {
  top: 1px;
  background: white;
  opacity: 0.8;
  width: 100%;
  height: 32px;
  position: absolute;
  z-index: 2;
}
#nowPlayingContainer.expanded #nowPlayingBackground {
  opacity: 1;
}
#nowPlayingContainer {
  position: absolute;
  color: black;
  font-size: 11px;
  text-align: left;
  visibility: hidden;
  overflow: hidden;
}
#nowPlayingContainer h1 {
  font-weight: bold;
  font-size: 11px;
  margin: 0;
  padding: 0 7px 0 0;
  display: inline;
  color: #009fdb;
  white-space: nowrap;
  font-style: normal;
  font-stretch: normal;
  line-height: 1.64em;
  letter-spacing: normal;
  vertical-align: middle;
}
#nowPlayingContainer.expanded .counter {
  display: inline;
}
#nowPlayingContainer.expanded #nowPlayingDiv span.title {
  font-size: 11px;
  display: block;
  clear: both;
}
#nowPlayingContainer #upNextDiv h1,
#nowPlayingContainer #upNextDiv span.title {
  line-height: 1.45em;
}

#upNextDiv {
  position: relative;
  z-index: 2;
  padding: 6px 11px 1px 11px;
  border-top: 1px solid #ddd;
  visibility: hidden;
}

#nowPlayingContainer span.title {
  line-height: 1.64em;
  padding-left: 4px;
  font-size: 11px;
  display: block;
  text-align: left;
  margin: 0;
  padding: 0;
  text-overflow: ellipsis;
  color: #555555;
  vertical-align: middle;
  white-space: nowrap;
  overflow: hidden;
}
#nowPlayingContainer #upNextDiv {
  display: none;
}
#nowPlayingContainer.expanded #upNextDiv {
  display: block;
}

#nowPlayingContainer h1 {
  float: left;
}

#nowPlayingControls {
  float: right;
  height: 14px;
  margin: 0 -6px 0 0;
  white-space: nowrap;
}
#nowPlayingDiv {
  margin-top: 1px;
  padding: 6px 11px 6px 11px;
  overflow: hidden;
  position: relative;
  z-index: 2;
  line-height: 11px;
}
#comingUpPlaylist {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: white;
  color: black;
  padding: 0;
  text-align: center;
  z-index: 2;
  overflow: hidden;
  opacity: 0.98;
}
#comingUpPlaylist h1 {
  font-weigth: bold;
  font-size: .9em;
  color: #009fdb;
}
#comingUpPlaylist h3 {
  font-size: .8em;
  text-align: left;
  padding: .6em;
  margin: 2px;
  color: gray;
  border: 2px solid white;
}
#comingUpPlaylist h3.active {
  -moz-border-radius: 8px;
  border-radius: 8px;
  color: white;
  border: 2px solid white;
  background-color: #009fdb;
}
#comingUpPlaylist h3 span {
  display: table-cell;
  vertical-align: middle;
  padding: 0 10px;
}
.comingupThumbnail, .comingupThumbnailContainer {
  display: block;
  height: 3em;
  width: 5.34em;
}
.comingupThumbnailPlayIcon {
  font-family: "autoplay-font";
  text-align: center;
  position: absolute;
  top: 0;
  font-size: 2em;
  color: white;
  font-weight: normal;
  opacity: .7;
  width: 100%;
  height: 100%;
  line-height: 1.5em;
}
.comingupThumbnailContainer {
  position: relative;
  margin: 0 10px;
  display: table-cell;
  vertical-align: middle;
}
.comingupThumbnailCenter {
  position: relative;
}
.comingupThumbnailContainer img {
  background-color: #333;
  border: 1px solid #eee;
}
.active .comingupThumbnailContainer img {
  border: 1px solid #009fdb;
}
#assetPreview {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  color: white;
  padding: 0;
  text-align: left;
  z-index: 2;
  overflow: hidden;
  opacity: 0.98;
  background-size: cover;
  background-position: center;
}
#assetPreview .dimmer {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.65);
  opacity: 0.98;
  z-index: 3;
}
#assetPreview .assetPreviewText {
  position: absolute;
  transform: translate(0, -50%);
  top: 50%;
}
#assetPreview h1 {
  font-size: 3.5vw;
  letter-spacing: 0.5px;
  padding: 0 21px;
}
#assetPreview h2 {
  font-size: 5.2vw;
  padding: 0 21px;
  font-weight: bold;
}
#assetPreview h3 {
  font-size: 3.8vw;
  margin-top: -0.5em;
  padding: 0 21px;
  font-weight: bold;
}
.watchNowIcon {
  font-family: "autoplay-font";
  font-size: 1.5em;
  padding-right: 10px;
  vertical-align: bottom;
}
#comingupGradient {
  height: 40px;
  bottom: 0;
  width: 100%;
  position: absolute;
  background: -webkit-linear-gradient(270deg, rgba(255,255,255,0), rgba(255,255,255,1)); /* For Safari 5.1 to 6.0 */
  background: -o-linear-gradient(270deg, rgba(255,255,255,0), rgba(255,255,255,1)); /* For Opera 11.1 to 12.0 */
  background: -moz-linear-gradient(270deg, rgba(255,255,255,0), rgba(255,255,255,1)); /* For Firefox 3.6 to 15 */
  background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,1)); /* Standard syntax */
}
#loadingCover {
  background-color: #EFEFEF;
  width: 100%;
  height: 100%;
  position: absolute;
  top: 0;
  left: 0;
  z-index: 2;
  color: #aaa;
}
#staticAdModal {
  position: absolute;
  top: 0;
  left: 0;
  z-index: 999;
  background-color: #EFEFEF;
  visibility: hidden;
  color: #aaa;
}
#loadingCover h1, #staticAdModal h1 {
  text-transform: uppercase;
  text-align: center;
  font-size: 1em;
  position: relative;
  top: 50%;
  margin: 0;
}
#playerContainer {
  position: relative;
  overflow: hidden;
}
.playerFrame {
  border: none;
  margin: 0;
  padding: 0;
  overflow: hidden;
  position: absolute;
  top: 0;
  left: 0;
}
#topBorder {
  z-index: 1000;
  position: absolute;
  top: 0;
  height: 1px;
  width: 100%;
}
#botBorder {
  z-index: 1000;
  position: absolute;
  bottom: 0;
  height: 1px;
  width: 100%;
}
#lftBorder {
  z-index: 1000;
  position: absolute;
  left: 0;
  height: 100%;
  width: 1px;
}
#rgtBorder {
  z-index: 1000;
  position: absolute;
  right: 0;
  height: 100%;
  width: 1px;
}
</style>




<div id="playerContainer" style="width: 300px; height: 250px;">
<iframe class="playerFrame" width="300" height="250" style="width: 300px; height: 250px; z-index: 0;" cd_frame_id_="a1eed7d016224ef1fe269f1877ec336c" src="/files/pagesources/van-morrison-mn0000307461_9.HTML"></iframe><iframe class="playerFrame" width="300" height="250" style="width: 300px; height: 250px; z-index: 1;" cd_frame_id_="62ec0679a05eb29a010ce0e4edd592f8" src="/files/pagesources/van-morrison-mn0000307461_12.HTML"></iframe><div id="nowPlayingContainer" class="" style="width: 300px; visibility: visible; height: 30px; top: 220px;"><div class="adColor" id="adColorLeft" style="display: block; background-color: rgb(6, 14, 14);"></div><div class="adColor" id="adColorRight" style="display: block; background-color: black;"></div><div id="nowPlayingBackground" style="height: 30px;"></div><div id="nowPlayingDiv"><div id="nowPlayingControls"><a id="unmuteVideo" class="icon iconMute"></a></div><h1>NEXT</h1><span class="title">Don't Miss! - 12/1 Preview</span></div><div id="upNextDiv"><h1>NEXT</h1><span class="title">Don't Miss! - 12/1</span></div></div><iframe class="playerFrame" width="300" height="250" style="width: 300px; height: 250px; z-index: 0;" cd_frame_id_="7ec9f0c5b7f541c1ca97733f5fcd584a" src="/files/pagesources/van-morrison-mn0000307461_14.HTML"></iframe><iframe class="playerFrame" width="300" height="250" style="width: 300px; height: 250px; z-index: 0;" cd_frame_id_="fc4e49deb075d3b886ec67c8db2ae893" src="/files/pagesources/van-morrison-mn0000307461_16.HTML"></iframe><iframe class="playerFrame" width="300" height="250" style="width: 300px; height: 250px; z-index: 0;" cd_frame_id_="564882a307039549dd36ebff8739d54d" src="/files/pagesources/van-morrison-mn0000307461_18.HTML"></iframe><iframe class="playerFrame" width="300" height="250" style="width: 300px; height: 250px; z-index: 0;" cd_frame_id_="06ee79805845b5aed9ec7f9617ff0ed9" src="/files/pagesources/van-morrison-mn0000307461_29.HTML"></iframe></div>

<!--
  code html build timestamp: 2017-12-01 16:05:59 EST
  code blob: $Id: 9d66ed01ab30cb5ccdfb7928f321ecdd12fb27cf $

  html build timestamp: 2017-12-01 16:05:59 EST
  newest content timestamp: 2017-12-01 13:46:00 EST

  eaid: 4441804982
  ecid: 56494945772
  blob: $Id: 9d66ed01ab30cb5ccdfb7928f321ecdd12fb27cf $

  adtags: b=0;id=google_adex_syndication;t=18, b=0;id=springserve_syndication;t=40, b=2;id=spotxchange_synacorsyndication;t=38, b=18;id=google_adex_syndication_backfill;t=22
  large adtags: 
  prefix: a, db, a, d
  tail: a, b
  loop mode: forever
  stop after minutes: 0
  prefetching: off
  audio mode: malamute
  explicit unmute: on
  disable flash: off
  log throttle: 0.005
  log url: garnet-static
  stream source: edgecast
  timed ad break: 15s
  order mode: fs
  seen at end: off
  dynamic content: on
  bitrate on resize: on
  ad play max time: r+60s
  ad-free on click: on
  anti-refresh: off
  border color: none
  show now playing: on
  show nav buttons: on
  autoplay mode: always
  adload splash: comingup
  background ads: on
  background run restricted tags: off
  background only viewable: off
  inactive scroll seconds: off
  static ad source: contango__syndicationdfptemplate
  static ad size match: off
  static ad visible min: 5
  static ad rotation min: 60
  static ad in DCC: off
  static fallback source: n/a
  ad scheduling: simultaneous
  replace dcc: off
  fill window: on
  log aceview: off
  content restrictions: 
-->

<script type="text/javascript">
// config
var cfg = {
   "ad_scheduling": "simultaneous",
   "ad_tags": [
      {
         "b": 0,
         "id": "google_adex_syndication",
         "t": 18,
         "url": {
            "default": "//pubads.g.doubleclick.net/gampad/ads?sz=640x383&iu=/5284/syn.synacorsyndication/video_adex&ciu_szs=300x250&impl=s&gdfp_req=1&env=vp&output=xml_vast3&unviewed_position_start=1&url=__domain__&description_url=__page-url__&correlator=__timestamp__&cust_params=dfpcid%3D__dfpcid__%26dfpadunit%3D__dfpadunit__%26sizebucket%3D__item-sizebucket__%26dfpclient%3D__dfpclient__%26autoplaydomain%3D__domain__%26browserclass%3D__browser__%26autoplaybucket%3D__item-bucket__"
         }
      },
      {
         "b": 0,
         "id": "springserve_syndication",
         "t": 40,
         "tracking": {
            "start": "//vid-io.springserve.com/vd/i?event=player_start&id=89320&w=__player-width__&h=__player-height__&cb=__random-number__&url=__domain__"
         },
         "url": "//vid.springserve.com/vast/89320?w=__player-width__&h=__player-height__&cb=__random-number__&mute=1&ap=1&vid=__item-id__&vt=__item-title__&kwds=__item-keywords__&zid=__dfpcid__&sid=__dfpadunit__&url=__page-url__&v_url=__item-srcurl__&prefetch=__item-isprefetch__&browser=__browser__&flash=__flash__&vpaid=__item-vpaid__&autoplay=__item-flashautoplay__&adunit=__dfpadunit__&flashok=__item-flashok__&crossdomain=__crossdomain__&client=__dfpclient__&dur=__item-realduration__&sizebucket=__item-sizebucket__&dfpcid=__dfpcid__&testbucket=__item-bucket__&inview=__item-viewable__"
      },
      {
         "b": 2,
         "id": "spotxchange_synacorsyndication",
         "t": 38,
         "url": {
            "default": "//search.spotxchange.com/vast/2.00/177135?VPAID=1&content_type=video&content_page_url=__page-url__&cb=__random-number__&player_width=__player-width__&player_height=__player-height__&vid_duration=__item-realduration__&ad_mute=1&content_id=__dfpcid__&custom[cid]=__domain__&custom[dfpadunit]=__dfpadunit__&custom[flash]=__item-allowflashonly__&custom[prefetch]=__item-isprefetch__"
         }
      },
      {
         "b": 18,
         "id": "google_adex_syndication_backfill",
         "t": 22,
         "url": {
            "default": "//pubads.g.doubleclick.net/gampad/ads?sz=640x383&iu=/5284/syn.synacorsyndication/video_adex_backfill&ciu_szs=300x250&impl=s&gdfp_req=1&env=vp&output=xml_vast3&unviewed_position_start=1&url=__domain__&description_url=__page-url__&correlator=__timestamp__&cust_params=dfpcid%3D__dfpcid__%26dfpadunit%3D__dfpadunit__%26sizebucket%3D__item-sizebucket__%26dfpclient%3D__dfpclient__%26autoplaydomain%3D__domain__%26browserclass%3D__browser__%26autoplaybucket%3D__item-bucket__"
         }
      }
   ],
   "ad_text": false,
   "adfree_interaction": true,
   "adload_splash": "comingup",
   "adplaytimer_maxsecs": "r+60",
   "after_stopping": "ctp",
   "anti_refresh": false,
   "audio_mode": "malamute",
   "autoplay_mode": "always",
   "autoplay_mode_chaff": "0",
   "autoplay_mode_delay": "60",
   "background_ads": true,
   "background_only_viewable": false,
   "background_run_restricts": false,
   "border_color": "none",
   "dcc_again_after_close": false,
   "dcc_bitrate": "maintain",
   "dcc_immediate_inc": false,
   "dcc_rotations_gen2": "1",
   "dcc_rotations_gen4": "3",
   "disable_flash": false,
   "dynamiccontent": true,
   "explicit_unmute": true,
   "fill_window": true,
   "inactive_scroll_inview": "65",
   "inactive_scroll_return": false,
   "inactive_scroll_secs": 0,
   "large_ad_tags": [],
   "log_aceview": false,
   "logthrottle": 0.005,
   "logurl": "//static.garnet.synacor.com/small/blank.gif",
   "loop_mode": true,
   "minimum_bitrate": 100,
   "no_first_ad_chain": true,
   "no_first_ad_chain_inc0_only": true,
   "order_mode": "fs",
   "player_reload_attempts": "1",
   "playlists": {
      "b": [
         {
            "aspect": 1.77777777777778,
            "duration": 45,
            "id": "201481108",
            "image": "//da4pli3l5vc0d.cloudfront.net/37/97/379734dd319a2efe49a4cb3b22c39c3b4da91d2b",
            "keywords": "California, Instagram, New York, Orlando , Paris, Tokyo, business, news, social media",
            "media": [
               {
                  "bitrate": 100,
                  "file": "//hdsvam-vh.akamaihd.net/z/72/b3/buzz60/2484325471991534356_100k_32k_302x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               },
               {
                  "bitrate": 200,
                  "file": "//hdsvam-vh.akamaihd.net/z/1e/fb/buzz60/2484325471991534356_200k_32k_480x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               },
               {
                  "bitrate": 600,
                  "file": "//hdsvam-vh.akamaihd.net/z/f4/59/buzz60/2484325471991534356_600k_96k_722x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               }
            ],
            "title": "The Most Instagrammed Places on Earth"
         },
         {
            "aspect": 1.77777777777778,
            "duration": 58,
            "id": "201444113",
            "image": "//da4pli3l5vc0d.cloudfront.net/46/92/46920485d69bf6d25b581ae6b3ef794c12efdb59",
            "keywords": "bootleg baubles, buzz60, christmas stocking, ikea, ikea bag, ikea bag stocking, ikea chairs, ikea christmas, ikea stocking, ikea tote, ikea tote bag, ikea tote bag stocking, ikea tote stocking, nathan rousseau smith",
            "media": [
               {
                  "bitrate": 100,
                  "file": "//hdsvam-vh.akamaihd.net/z/b7/12/buzz60/6475498442967239148_100k_32k_302x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               },
               {
                  "bitrate": 200,
                  "file": "//hdsvam-vh.akamaihd.net/z/59/b7/buzz60/6475498442967239148_200k_32k_480x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               },
               {
                  "bitrate": 600,
                  "file": "//hdsvam-vh.akamaihd.net/z/c1/e0/buzz60/6475498442967239148_600k_96k_722x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               }
            ],
            "title": "IKEA Tote Bag Stockings Now Exist, No Assembly Required"
         },
         {
            "aspect": 1.77777777777778,
            "duration": 66,
            "id": "201433703",
            "image": "//da4pli3l5vc0d.cloudfront.net/31/81/3181456f90ac8975b8321c658b352e43f758f865",
            "keywords": "Buzz60, Dr. Danielle Forshee, TC Newman, break ups, dating, dopamine, feel good hormones, hormones, how long to be single after a break up, how to cope with a break up, marriage, psychologist, rebounds, relationships, single",
            "media": [
               {
                  "bitrate": 100,
                  "file": "//hdsvam-vh.akamaihd.net/z/ca/f9/buzz60/4717526261569456494_100k_32k_302x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               },
               {
                  "bitrate": 200,
                  "file": "//hdsvam-vh.akamaihd.net/z/5f/2e/buzz60/4717526261569456494_200k_32k_480x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               },
               {
                  "bitrate": 600,
                  "file": "//hdsvam-vh.akamaihd.net/z/0c/fa/buzz60/4717526261569456494_600k_96k_722x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               }
            ],
            "title": "There's A Scientific Reason Why You Should Be Single For A While After A Break Up"
         },
         {
            "aspect": 1.77777777777778,
            "duration": 65,
            "id": "201416925",
            "image": "//da4pli3l5vc0d.cloudfront.net/0b/55/0b558b8ceb0724e835fe1d78d037e873a789143f",
            "keywords": "binge watch a show, buzz60, commitment rings, digital streaming cheating, keri lumm, netflix, netflix binging, netflix cheating, netflix digital streaming",
            "media": [
               {
                  "bitrate": 100,
                  "file": "//hdsvam-vh.akamaihd.net/z/03/09/buzz60/8843373995297254389_100k_32k_302x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               },
               {
                  "bitrate": 200,
                  "file": "//hdsvam-vh.akamaihd.net/z/88/4d/buzz60/8843373995297254389_200k_32k_480x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               },
               {
                  "bitrate": 600,
                  "file": "//hdsvam-vh.akamaihd.net/z/55/db/buzz60/8843373995297254389_600k_96k_722x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               }
            ],
            "title": "Study: Is Cheating on Netflix Worse Than Real Cheating?"
         },
         {
            "aspect": 1.77777777777778,
            "duration": 57,
            "id": "201424197",
            "image": "//da4pli3l5vc0d.cloudfront.net/93/b1/93b17c5d896900f33ef70ba126879698a2ab5a2c",
            "keywords": "Buzz60, Canada, TC Newman, THC, bong, cannabis, drug test, marijuana, pot, second hand smoke, smoking, university of Calgary",
            "media": [
               {
                  "bitrate": 100,
                  "file": "//hdsvam-vh.akamaihd.net/z/73/2b/buzz60/4993745487578191631_100k_32k_302x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               },
               {
                  "bitrate": 200,
                  "file": "//hdsvam-vh.akamaihd.net/z/0c/fe/buzz60/4993745487578191631_200k_32k_480x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               },
               {
                  "bitrate": 600,
                  "file": "//hdsvam-vh.akamaihd.net/z/e1/41/buzz60/4993745487578191631_600k_96k_722x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               }
            ],
            "title": "Study: You Could Fail A Drug Test From Second Hand Marijuana Smoke"
         },
         {
            "aspect": 1.77777777777778,
            "duration": 74,
            "id": "201407189",
            "image": "//da4pli3l5vc0d.cloudfront.net/23/58/2358df4b5d21790acdd84dd76a82f5b0fe7dcf2e",
            "keywords": "Buzz60, TC Newman, chocolate, dating, food, foodie, fried chicken, guacamole, ice cream, nachos, online dating, online profiles, pasta, pizza, potatoes, relationships, salad, studies, study, technology, weird news, yams, zoos",
            "media": [
               {
                  "bitrate": 100,
                  "file": "//hdsvam-vh.akamaihd.net/z/66/5f/buzz60/1379193818311453544_100k_32k_302x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               },
               {
                  "bitrate": 200,
                  "file": "//hdsvam-vh.akamaihd.net/z/80/12/buzz60/1379193818311453544_200k_32k_480x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               },
               {
                  "bitrate": 600,
                  "file": "//hdsvam-vh.akamaihd.net/z/3b/36/buzz60/1379193818311453544_600k_96k_722x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               }
            ],
            "title": "Study: Foodies Have Better Luck At Online Dating"
         },
         {
            "aspect": 1.77777777777778,
            "duration": 56,
            "id": "201271490",
            "image": "//da4pli3l5vc0d.cloudfront.net/3a/df/3adfd4a7628f4e0b8b6105f1ec9bf69f52220c8e",
            "keywords": "Bacon, Big, Bigfoot, Buzz60, Comments, Donuts, Elusive, Facebook, Field, Foot, Nebraska, People, Photo, Rare, Sam Berman, Sasquatch, State, Super, Trolling, Troopers, Viral",
            "media": [
               {
                  "bitrate": 100,
                  "file": "//hdsvam-vh.akamaihd.net/z/0d/f0/buzz60/8454448315159238664_100k_32k_302x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               },
               {
                  "bitrate": 200,
                  "file": "//hdsvam-vh.akamaihd.net/z/f5/7b/buzz60/8454448315159238664_200k_32k_480x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               },
               {
                  "bitrate": 600,
                  "file": "//hdsvam-vh.akamaihd.net/z/99/ea/buzz60/8454448315159238664_600k_96k_722x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               }
            ],
            "title": "State Troopers Troll 'Bigfoot Spotters'"
         },
         {
            "aspect": 1.77777777777778,
            "duration": 68,
            "id": "201227600",
            "image": "//da4pli3l5vc0d.cloudfront.net/19/e5/19e52eb1ebdfe65e720c6b28c22af90cf3d28519",
            "keywords": "buzz60, christmas, christmas gifts, freak hat, huffington post weird christmas, keri lumm, pillow hat, tipsy elves, weird christmas, weird holiday gifts, wine sweater",
            "media": [
               {
                  "bitrate": 100,
                  "file": "//hdsvam-vh.akamaihd.net/z/10/59/buzz60/1168358484389325412_100k_32k_302x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               },
               {
                  "bitrate": 200,
                  "file": "//hdsvam-vh.akamaihd.net/z/7a/03/buzz60/1168358484389325412_200k_32k_480x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               },
               {
                  "bitrate": 600,
                  "file": "//hdsvam-vh.akamaihd.net/z/03/1d/buzz60/1168358484389325412_600k_96k_722x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               }
            ],
            "title": "Weirdest Christmas Gifts for 2017"
         },
         {
            "aspect": 1.77777777777778,
            "duration": 53,
            "id": "201227607",
            "image": "//da4pli3l5vc0d.cloudfront.net/59/d3/59d3fa0e26aac9e9dafaa9bf0f45068289bacc46",
            "keywords": "Maria Mercedes Galuppo, animals, brainier, buzz60, capacity, cat, debate, dog, neurons, science, smart, smarter, study",
            "media": [
               {
                  "bitrate": 100,
                  "file": "//hdsvam-vh.akamaihd.net/z/65/6c/buzz60/2698455553799177743_100k_32k_302x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               },
               {
                  "bitrate": 200,
                  "file": "//hdsvam-vh.akamaihd.net/z/0f/cf/buzz60/2698455553799177743_200k_32k_480x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               },
               {
                  "bitrate": 600,
                  "file": "//hdsvam-vh.akamaihd.net/z/90/15/buzz60/2698455553799177743_600k_96k_722x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               }
            ],
            "title": "Science Has Proven Dogs are Smarter Than Cats"
         },
         {
            "aspect": 1.77777777777778,
            "duration": 89,
            "id": "201211092",
            "image": "//da4pli3l5vc0d.cloudfront.net/6b/08/6b08ffea078dfc9710524df16d6fb885299b74a7",
            "keywords": "2018, Maria Mercedes Galuppo, bucket list, china, cuba, destinations, fodor's travel, great wall, havana, india, national geographic, news, taj mahal, travel, visit",
            "media": [
               {
                  "bitrate": 100,
                  "file": "//hdsvam-vh.akamaihd.net/z/cc/95/buzz60/8149426682227652635_100k_32k_302x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               },
               {
                  "bitrate": 200,
                  "file": "//hdsvam-vh.akamaihd.net/z/1f/15/buzz60/8149426682227652635_200k_32k_480x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               },
               {
                  "bitrate": 600,
                  "file": "//hdsvam-vh.akamaihd.net/z/9c/66/buzz60/8149426682227652635_600k_96k_722x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               }
            ],
            "title": "The Top 3 Places You Shouldn't Visit in 2018"
         },
         {
            "aspect": 1.77777777777778,
            "duration": 42,
            "id": "201069083",
            "image": "//da4pli3l5vc0d.cloudfront.net/44/c6/44c670066fe2326ecdadd89cd0948134e82c9876",
            "keywords": "California, Facebook, Roo, business, chicken, news, social media , wheelchair",
            "media": [
               {
                  "bitrate": 100,
                  "file": "//hdsvam-vh.akamaihd.net/z/03/cd/buzz60/3783989816862267554_100k_32k_302x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               },
               {
                  "bitrate": 200,
                  "file": "//hdsvam-vh.akamaihd.net/z/b6/cf/buzz60/3783989816862267554_200k_32k_480x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               },
               {
                  "bitrate": 600,
                  "file": "//hdsvam-vh.akamaihd.net/z/00/a2/buzz60/3783989816862267554_600k_96k_722x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               }
            ],
            "title": "Injured Chicken Will Learn to Walk Again with Wheelchair"
         },
         {
            "aspect": 1.77777777777778,
            "duration": 59,
            "id": "201053523",
            "image": "//da4pli3l5vc0d.cloudfront.net/8f/e4/8fe408da81167d577ad9c340667ffece27da7aba",
            "keywords": "Ugly Sweater Sweater, Ugly Sweaters, buzz60, nathan rousseau smith, sweat stains, sweater sweat stains, ugly christmas sweater, ugly sweater parties, ugly sweater sweat",
            "media": [
               {
                  "bitrate": 100,
                  "file": "//hdsvam-vh.akamaihd.net/z/af/76/buzz60/3686726918925168447_100k_32k_302x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               },
               {
                  "bitrate": 200,
                  "file": "//hdsvam-vh.akamaihd.net/z/ed/26/buzz60/3686726918925168447_200k_32k_480x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               },
               {
                  "bitrate": 600,
                  "file": "//hdsvam-vh.akamaihd.net/z/64/44/buzz60/3686726918925168447_600k_96k_722x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               }
            ],
            "title": "These 'Ugly Sweaters' Come with Sweat Stains in Festive Christmas Shapes"
         },
         {
            "aspect": 1.77777777777778,
            "duration": 52,
            "id": "201053530",
            "image": "//da4pli3l5vc0d.cloudfront.net/02/0e/020e3c6aace2240b3268e1acbd3088ce7974be2b",
            "keywords": "bed bath and beyond, buzz60, dominos, dominos baby registry, dominos gugu guru, dominos registry, gugu guru, josh king, pizza",
            "media": [
               {
                  "bitrate": 100,
                  "file": "//hdsvam-vh.akamaihd.net/z/25/bd/buzz60/2636369178145243474_100k_32k_302x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               },
               {
                  "bitrate": 200,
                  "file": "//hdsvam-vh.akamaihd.net/z/61/a9/buzz60/2636369178145243474_200k_32k_480x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               },
               {
                  "bitrate": 600,
                  "file": "//hdsvam-vh.akamaihd.net/z/33/cd/buzz60/2636369178145243474_600k_96k_722x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               }
            ],
            "title": "Domino's Has a Baby Registry Now Because Why Not"
         },
         {
            "aspect": 1.77777777777778,
            "duration": 78,
            "id": "201040083",
            "image": "//da4pli3l5vc0d.cloudfront.net/b7/50/b750f929ba8aab66a3c3de8b87b1cd4eca5f1c5b",
            "keywords": "5 Signs Your Coworker is a Psycho, Buzz60, business, coworker, coworker psychopath, how to tell if coworker is psychopath, narcissist, narcissistic, news, pathological liar, psycho, psychology, psychopath, weird news",
            "media": [
               {
                  "bitrate": 100,
                  "file": "//hdsvam-vh.akamaihd.net/z/ea/49/buzz60/3852313697543386186_100k_32k_302x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               },
               {
                  "bitrate": 200,
                  "file": "//hdsvam-vh.akamaihd.net/z/4b/cf/buzz60/3852313697543386186_200k_32k_480x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               },
               {
                  "bitrate": 600,
                  "file": "//hdsvam-vh.akamaihd.net/z/48/be/buzz60/3852313697543386186_600k_96k_722x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               }
            ],
            "title": "5 Signs Your Coworker is a Psycho"
         },
         {
            "aspect": 1.77777777777778,
            "duration": 51,
            "id": "201024408",
            "image": "//da4pli3l5vc0d.cloudfront.net/37/1f/371fef43e5a1cb7035b8c580fd173b2da10747fa",
            "keywords": "Buzz60, FitRated, Some Gym Equipment You Touch is Dirtier Than a Toilet Seat, bacteria, catch disease, clean, dirty gym equipment, exercise bike, free weights, germs, gym equipment, gym equipment more germs toilet seat, gym germs, news, research, study, treadmill, wash hands, weird news",
            "media": [
               {
                  "bitrate": 100,
                  "file": "//hdsvam-vh.akamaihd.net/z/15/5c/buzz60/5617341152698353766_100k_32k_302x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               },
               {
                  "bitrate": 200,
                  "file": "//hdsvam-vh.akamaihd.net/z/33/29/buzz60/5617341152698353766_200k_32k_480x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               },
               {
                  "bitrate": 600,
                  "file": "//hdsvam-vh.akamaihd.net/z/09/3f/buzz60/5617341152698353766_600k_96k_722x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               }
            ],
            "title": "Some Gym Equipment You Touch is Dirtier Than a Toilet Seat"
         },
         {
            "aspect": 1.77777777777778,
            "duration": 61,
            "id": "200996666",
            "image": "//da4pli3l5vc0d.cloudfront.net/b7/8b/b78b8168892dba3ec7525b1059cbf33dd990305e",
            "keywords": "Buzz60, Male Dolphins Use Wingmen and Charm Females With Gifts, The University of Western Australia, animal video, animals, dolphin, dolphins give gifts, gift, gift-giving, male dolphins charm females with gifts, male dolphins gifts, male dolphins wingmen, news, present, research, study, weird animal news",
            "media": [
               {
                  "bitrate": 100,
                  "file": "//hdsvam-vh.akamaihd.net/z/de/b1/buzz60/2675658577976766676_100k_32k_302x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               },
               {
                  "bitrate": 200,
                  "file": "//hdsvam-vh.akamaihd.net/z/e2/42/buzz60/2675658577976766676_200k_32k_480x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               },
               {
                  "bitrate": 600,
                  "file": "//hdsvam-vh.akamaihd.net/z/3f/ab/buzz60/2675658577976766676_600k_96k_722x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               }
            ],
            "title": "Male Dolphins Use Wingmen and Charm Females With Gifts"
         },
         {
            "aspect": 1.77777777777778,
            "duration": 47,
            "id": "200858130",
            "image": "//da4pli3l5vc0d.cloudfront.net/46/56/4656a0bce1d7975cb381c4de248a3b73e18d7612",
            "keywords": "Maria Mercedes Galuppo, buzz60, car, christmas, facebook, gigantic, huge, large, massachusetts, news, photo, police, responsibly, sudbury, swallow, tree, weird",
            "media": [
               {
                  "bitrate": 100,
                  "file": "//hdsvam-vh.akamaihd.net/z/6a/46/buzz60/1727157651955229758_100k_32k_302x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               },
               {
                  "bitrate": 200,
                  "file": "//hdsvam-vh.akamaihd.net/z/3e/c3/buzz60/1727157651955229758_200k_32k_480x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               },
               {
                  "bitrate": 600,
                  "file": "//hdsvam-vh.akamaihd.net/z/8a/c3/buzz60/1727157651955229758_600k_96k_722x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               }
            ],
            "title": "Police Stops Car With Gigantic Christmas Tree Swallowing Car"
         },
         {
            "aspect": 1.77777777777778,
            "duration": 46,
            "id": "200841027",
            "image": "//da4pli3l5vc0d.cloudfront.net/26/fd/26fdf3f5871d84c53ae06b27022d248c76c06a67",
            "keywords": "Jackson Hole, Las Vegas, Nevada, Park City, Utah, Wyoming , business, news, season, weekend, winter",
            "media": [
               {
                  "bitrate": 100,
                  "file": "//hdsvam-vh.akamaihd.net/z/6b/30/buzz60/1467568113193958585_100k_32k_302x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               },
               {
                  "bitrate": 200,
                  "file": "//hdsvam-vh.akamaihd.net/z/10/44/buzz60/1467568113193958585_200k_32k_480x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               },
               {
                  "bitrate": 600,
                  "file": "//hdsvam-vh.akamaihd.net/z/b2/85/buzz60/1467568113193958585_600k_96k_722x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               }
            ],
            "title": "Best Winter Weekend Getaways"
         },
         {
            "aspect": 1.77777777777778,
            "duration": 74,
            "id": "200810322",
            "image": "//da4pli3l5vc0d.cloudfront.net/4e/e4/4ee4d609e0e2ee22df05f30b5ba8463100ecae3e",
            "keywords": "Buzz60, Diagnosing Your Health Problems Online Can Make You Paranoid, Imperial College London, cough, cyberchondria, cyberchondria health problems online, diagnosing health problems online, doctor, fitness, flu season, flu shot, health, patient, sickness, the big sick, weird news",
            "media": [
               {
                  "bitrate": 100,
                  "file": "//hdsvam-vh.akamaihd.net/z/59/64/buzz60/3786177933215313827_100k_32k_302x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               },
               {
                  "bitrate": 200,
                  "file": "//hdsvam-vh.akamaihd.net/z/40/fc/buzz60/3786177933215313827_200k_32k_480x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               },
               {
                  "bitrate": 600,
                  "file": "//hdsvam-vh.akamaihd.net/z/83/01/buzz60/3786177933215313827_600k_96k_722x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               }
            ],
            "title": "Always Diagnosing Your Health Problems Online? You May Have 'Cyberchondria'"
         },
         {
            "aspect": 1.77777777777778,
            "duration": 48,
            "id": "200810329",
            "image": "//da4pli3l5vc0d.cloudfront.net/0c/0e/0c0e9572054f6b74f7e4cea970a9621b902ed7cf",
            "keywords": "amy cuddy, brain, cortisol, harvard university, physiology., posture, power pose, psychology, testosterone",
            "media": [
               {
                  "bitrate": 100,
                  "file": "//hdsvam-vh.akamaihd.net/z/af/8e/buzz60/2236775648719866442_100k_32k_302x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               },
               {
                  "bitrate": 200,
                  "file": "//hdsvam-vh.akamaihd.net/z/fb/f5/buzz60/2236775648719866442_200k_32k_480x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               },
               {
                  "bitrate": 600,
                  "file": "//hdsvam-vh.akamaihd.net/z/d2/7f/buzz60/2236775648719866442_600k_96k_722x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               }
            ],
            "title": "How Your Body Language Can Make Your Day Better"
         },
         {
            "aspect": 1.77777777777778,
            "duration": 63,
            "id": "200801743",
            "image": "//da4pli3l5vc0d.cloudfront.net/fb/35/fb358177c3eebfbbd3e66929ec17d30e01ebf956",
            "keywords": "Buzz60, Doing This One Thing In Your Dating Profile Could Lead to More Messages, Zoosk, chocolate, dating app, divorce, food news, guacamole, guacamole dating profile, lifestyle, love, marriage, mentioning guacamole dating profile, news, online dating, potato, relationships, restaurant, sex, sexy, spicy, weird food news",
            "media": [
               {
                  "bitrate": 100,
                  "file": "//hdsvam-vh.akamaihd.net/z/98/47/buzz60/1584683849476527755_100k_32k_302x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               },
               {
                  "bitrate": 200,
                  "file": "//hdsvam-vh.akamaihd.net/z/54/8a/buzz60/1584683849476527755_200k_32k_480x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               },
               {
                  "bitrate": 600,
                  "file": "//hdsvam-vh.akamaihd.net/z/3b/d4/buzz60/1584683849476527755_600k_96k_722x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               }
            ],
            "title": "Doing This in Your Dating Profile Could Lead to More Messages"
         },
         {
            "aspect": 1.77777777777778,
            "duration": 51,
            "id": "200666962",
            "image": "//da4pli3l5vc0d.cloudfront.net/b9/92/b992a512c20c123aa919678b0cc4f3c29017cff2",
            "keywords": "buzz60, christmas, claridge's, decoration, holidays, home depot, hotel, karl lagerfeld, kohls, news, target, tradition, trees, upside down, walmart",
            "media": [
               {
                  "bitrate": 100,
                  "file": "//hdsvam-vh.akamaihd.net/z/e2/19/buzz60/7992217456477861729_100k_32k_302x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               },
               {
                  "bitrate": 200,
                  "file": "//hdsvam-vh.akamaihd.net/z/3f/a2/buzz60/7992217456477861729_200k_32k_480x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               },
               {
                  "bitrate": 600,
                  "file": "//hdsvam-vh.akamaihd.net/z/79/87/buzz60/7992217456477861729_600k_96k_722x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               }
            ],
            "title": "Apparently Upside Down Christmas Trees Are All The Rage This Year"
         },
         {
            "aspect": 1.77777777777778,
            "duration": 55,
            "id": "200653413",
            "image": "//da4pli3l5vc0d.cloudfront.net/c6/1f/c61f34aa6065485e4431155060d54025a835c906",
            "keywords": "bobcat, bobcat car, bobcat car grill, bobcat grill, bobcat prius, bobcat racc, bobcat richmond, buzz60, josh king",
            "media": [
               {
                  "bitrate": 100,
                  "file": "//hdsvam-vh.akamaihd.net/z/13/96/buzz60/2858353871566248863_100k_32k_302x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               },
               {
                  "bitrate": 200,
                  "file": "//hdsvam-vh.akamaihd.net/z/ed/b6/buzz60/2858353871566248863_200k_32k_480x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               },
               {
                  "bitrate": 600,
                  "file": "//hdsvam-vh.akamaihd.net/z/3a/50/buzz60/2858353871566248863_600k_96k_722x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               }
            ],
            "title": "Bobcat Gets Stuck in Car Grill for 50 Miles"
         },
         {
            "aspect": 1.77777777777778,
            "duration": 54,
            "id": "200641298",
            "image": "//da4pli3l5vc0d.cloudfront.net/21/a7/21a7786689ce5ce082921450ea6e6010abafd4f0",
            "keywords": "flat earth, flat earthers, hoax, mad mike hughes, nasa, neil degrasse tyson, rocket, science, space",
            "media": [
               {
                  "bitrate": 100,
                  "file": "//hdsvam-vh.akamaihd.net/z/06/62/buzz60/8472788355258379898_100k_32k_302x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               },
               {
                  "bitrate": 200,
                  "file": "//hdsvam-vh.akamaihd.net/z/d5/e2/buzz60/8472788355258379898_200k_32k_480x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               },
               {
                  "bitrate": 600,
                  "file": "//hdsvam-vh.akamaihd.net/z/94/11/buzz60/8472788355258379898_600k_96k_722x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               }
            ],
            "title": "Neil deGrasse Tyson Fires a Tweet at Flat-Earthers"
         }
      ],
      "d": [
         {
            "aspect": 1.77777777777778,
            "duration": 111,
            "id": "201372379",
            "image": "//da4pli3l5vc0d.cloudfront.net/7c/96/7c96625373318daeaef097911b5299b494791f8d",
            "keywords": "Don't Miss",
            "media": [
               {
                  "bitrate": 100,
                  "file": "//hdsvam-vh.akamaihd.net/z/7e/30/dontmiss/2642989873754681743_100k_32k_302x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               },
               {
                  "bitrate": 200,
                  "file": "//hdsvam-vh.akamaihd.net/z/c0/2d/dontmiss/2642989873754681743_200k_32k_302x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               },
               {
                  "bitrate": 500,
                  "file": "//hdsvam-vh.akamaihd.net/z/89/82/dontmiss/2642989873754681743_500k_96k_722x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               }
            ],
            "title": "Don't Miss -12/1"
         }
      ],
      "db": [
         {
            "aspect": 1.77777777777778,
            "duration": 16,
            "id": "201372385",
            "image": "//da4pli3l5vc0d.cloudfront.net/e8/0e/e80e0d52becdc1e09bc4adfdc8eca27055d160a8",
            "keywords": "Don't Miss",
            "media": [
               {
                  "bitrate": 100,
                  "file": "//hdsvam-vh.akamaihd.net/z/e5/e9/dontmiss/1811279697747111217_100k_32k_302x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               },
               {
                  "bitrate": 200,
                  "file": "//hdsvam-vh.akamaihd.net/z/6c/7d/dontmiss/1811279697747111217_200k_32k_302x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               },
               {
                  "bitrate": 500,
                  "file": "//hdsvam-vh.akamaihd.net/z/d2/1f/dontmiss/1811279697747111217_500k_96k_722x0.mp4/manifest.f4m",
                  "media_scheme": "mp4"
               }
            ],
            "title": "Don't Miss -12/1"
         }
      ]
   },
   "prefetching": false,
   "prefix": [
      "a",
      "db",
      "a",
      "d"
   ],
   "replace_dcc": false,
   "resize_bitrate": true,
   "resize_gpt": false,
   "restricted_content": {},
   "seen_at_end": false,
   "show_comingup": false,
   "show_navbuttons": true,
   "show_nowplaying": true,
   "static_ad_rotation_secs": "60",
   "static_ad_size_match": false,
   "static_ad_source": "contango__syndicationdfptemplate",
   "static_ad_tag": "<!-- BEGIN TECHNORATI MEDIA TAG FOR contango_tag_name_300x250, Ad Size: Medium Rectangle (300x250) -->\n<script type='text/javascript'>\n   document.write('<scri' + 'pt type=\"text/javascript\" src=\"'\n   + (document.location.protocol == 'https:' ? 'https://uat-secure.technoratimedia.com' : ('http:' + '//ad-cdn.technoratimedia.com'))\n   + 'contango_tag_path.js?ad_size=300x250&pub_code=56494945772\"></scri' + 'pt>');\n</scr" + "ipt>\n<!-- END TECHNORATI MEDIA TAG FOR contango_tag_name_300x250, Ad Size: Medium Rectangle (300x250) -->\n",
   "static_ad_visible_secs": "5",
   "static_fallback_secs": "20",
   "static_fallback_slots": "2",
   "static_fallback_source": "",
   "static_fallback_tag": null,
   "stop_after_mins": 0,
   "streamsource": "edgecast",
   "tail": [
      "a",
      "b"
   ],
   "timed_ad_break_secs": "15",
   "vamurls": {
      "b": "//syn.am4.syn-api.com/api/6/asset/list/client/showcase/vendor/Buzz60/expand/list/rows/25/language/en",
      "d": "//syn.am4.syn-api.com/api/6/asset/list/client/showcase/vendor/Don%27t%20Miss!/genres/entertainment/expand/list/rows/1/language/en",
      "db": "//syn.am4.syn-api.com/api/6/asset/list/client/showcase/vendor/Don%27t%20Miss!/genres/bumper/expand/list/rows/1/language/en"
   }
};

var bitrate_limit_kbps = 800;

var strings = {
  COMINGUP: {
    "en-US": "Coming Up",
    "es-US": "Siguente"
  },
  WATCHNOW: {
    "en-US": "Watch Now",
    "es-US": "Ver Ahora"
  },
  LOADING: {
    "en-US": "Loading",
    "es-US": "Cargando"
  },
  ADVERTISEMENT: {
    "en-US": "Advertisement",
    "es-US": "Anuncio"
  },
  NEXT: {
    "en-US": "Next",
    "es-US": "Siguente"
  },
  SHORTLY: {
    "en-US": "Shortly",
    "es-US": "En un momento"
  },
  NOWPLAYING: {
    "en-US": "Now Playing",
    "es-US": "Disponible Ahora"
  },
  XOFY: {
    "en-US": "of",
    "es-US": "de"
  }
};

// init
var debug = false;
var debug_stacktrace = false;

var language = "".replace(/[%][%]PATTERN:lang[%][%]/, "") || "en-US";
var flash_version = navigator && navigator.plugins && navigator.plugins["Shockwave Flash"] ? navigator.plugins["Shockwave Flash"].version : "unknown";
var audiomode_starts_muted = {muted:true, volume0:true, malamute:true, audible:false};
var ad_players = [];
var html5_failover = false;
var content_player = null;
var overlay_player = null;
var staticad_player = null;
var staticfallback_player = null;
var has_started = false;
var focus_wait = false;
var players_remaining = 0;
var is_inc0 = !location.search.substr(1).match(/(^|\&)inc\=/);
var autoplay_chaff = Math.random() < (cfg.autoplay_mode_chaff || 0) / 100;
var autoplay =
    cookie_get("synapm") === 'disable'    ? false
  : cfg.autoplay_mode    === 'always'     ? true
  : cfg.autoplay_mode    === 'inc0'       ? is_inc0
  : cfg.autoplay_mode    === 'onfocus'    ? (apunit_hasfocus() || autoplay_chaff)
  : cfg.autoplay_mode    === 'inviewport' ? (apunit_isinviewport(0.5) || autoplay_chaff)
  : false;
var ad_spots_remaining = 0;
var ad_loading_mutex = false, ad_playing_mutex = false;
var ad_playing_break_type = null;
var ads_start_time = null;
var ads_start_timeout = null;
var min_adslot_time_secs = 15; // how long min between starting each adslot (prevents spamming)
var total_ad_slots_attempted = 0;
var adbreak_timer_timeout = null;
var background_ad = false;
var topdomad_shown = false;
var should_adlog = Math.random() < cfg.logthrottle;
var load_time = timestamp();
var instance_id = String(load_time)+"-"+String(Math.random()).substr(2);
var apunit_inited = false;
var unmute_logged = !audiomode_starts_muted[cfg.audio_mode];
var user_interacted = false;
var disable_ads = false;
var vam_jsonp_failsafe = null;
var vam_jsonp_requests_pending = 0;
var tail_start = 0;
var pre_ads = [];
var playlist_spec = [];
var pread_num = 0;
var playlist = [];
var retry_timeouts = [];
var current_playlist_item = 0;
var loaded_playlist_item = null;
var current_ad_chain = [];
var attempt_timeout = null;
var simultaneous_ad_loader_timeout = null;
var staticad_refresh_timeout = null;
var ads_start_retry_timeout = null;
var delay_timeout = null;
var master_pause = false;
var unloaders = [];
var is_in_crossdomain_frame = false;
var crossdomain_url = null;
var show_static_ad = true;
var browser_features = {};
var browser_class = null;
browser_detect();
var flash_autoplay = true;
var webaudio_context = null;
var webaudio_gain = null;
var topmost_window = window;
var dfp_adunit = "/5284/syn.rhythmone/allmusic".replace(/%{2}ADUNIT%{2}/, "");
var dfp_client = dfp_adunit.replace(/\/[0-9]+\/(.*?)\/.*$/, "$1");
var is_sandboxed = false;
var can_load_flash = null;
var pii_detected = false;
var non_adx_tags_present = false;
var stop_after_mode = false;
var dcc_handler_installed = false;
var dcc_handler_install_count = 0;
var dcc_mode = false;
var saved_dcc_bitrate = null;
var thumbnailurl_strip_prefix = /^(https?:)?\/\/(image\.vam\.synacor\.com\.edgesuite\.net|da4pli3l5vc0d\.cloudfront\.net)\//;
var streamurl_strip_prefix = /^(https?:)?\/\/hdsvam\-vh\.akamaihd\.net\/z\//;
var streamurl_strip_suffix = /\/manifest\.f4m$/;
var first_onplay_of_asset = true;
var nowplaying_min_height = 57;
var state = null;
var state_time = null;
var log_aceview = false;
var origin = null; try {
  origin = window.top.location.href;
  try {
    if (window.top.document.referrer.match(/\w+(?:@|%40|%2540)[a-zA-Z_]+?\.[a-zA-Z]{2,3}/) || window.top.document.referrer.match(/(?:username|password|sessionid)=/)) {
      track_always("piireferrer", {"referrer": window.top.document.referrer});
      pii_detected = true;
    }
  } catch (e) {}
} catch(e) {
  is_in_crossdomain_frame = true;
  origin = "${REFERER_URL_ENC}".match(/^http/) ? decodeURIComponent("${REFERER_URL_ENC}") : null; // AppNexus macro
  if (origin === null) {
    var limit = 20;
    var cur_window = window;
    while (limit > 0 && cur_window !== window.top) {
      try {
        // traverse to the top-most iframe we can access to to pull correct referrer.
        origin = cur_window.document.referrer;
        if (origin.match(/\w+(?:@|%40|%2540)[a-zA-Z_]+?\.[a-zA-Z]{2,3}/) || origin.match(/(?:username|password|sessionid)=/)) {
          track_always("piiframe", {"frame": origin});
          pii_detected = true;
        }
        crossdomain_url = cur_window.location.href;
        topmost_window = cur_window;
      } catch (e) {
        // Do nothing
      }
      cur_window = cur_window.parent;
      limit--;
    }
  }
  // Uses ancestorOrigins method as backup only since it doesn't report full page URL. 
  if (window.location.ancestorOrigins && window.location.ancestorOrigins.length) {
    var ancestorOrigin = window.location.ancestorOrigins[window.location.ancestorOrigins.length-1];
    if (origin === null || origin.substr(0,ancestorOrigin.length) !== ancestorOrigin) {
      track_throttled("nestedcrossdomain", {"frameurl": crossdomain_url, "parenturl": origin, "topurl": ancestorOrigin});
      origin = ancestorOrigin;
    }
  }
}
if (origin === null) {
  origin = protocol_get() + "//unknown/";
  track_throttled("unknownorigin");
} else {
  if (origin.match(/\w+(?:@|%40|%2540)[a-zA-Z_]+?\.[a-zA-Z]{2,3}/) || origin.match(/(?:username|password|sessionid)=/)) {
    track_always("pii");
    pii_detected = true;
  }
  if (origin.length > 500) {
    origin = origin.replace(/\?.*$/, '');
  }
}
iterate_selfandparents(window, function() {
  var iframe = iframe_findfromwindow(this);
  if (iframe !== null && iframe.hasAttribute("sandbox")) {
    is_sandboxed = true;
    return true;
  }
});
if (is_in_crossdomain_frame) {
  if (!document.domain) is_sandboxed = true;
}

var domain = origin.match(/^https?:\/\/(?:[^\@\/]*\@)?([^\/\:]+)/)[1];
var skip_chaining = cfg.no_first_ad_chain && (!cfg.no_first_ad_chain_inc0_only || is_inc0); // Flag to support a separate initial ad load timeout and disable chaining on it too.


function blacklisted() {
  if (window.navigator.userAgent.match(/^Mozilla\/5\.0 \(Windows .*; rv:41\.0\) Gecko\/20100101 Firefox\/41\.0(?: |$)/)
   && window.navigator.buildID === "20150917150946") return true; // Firefox v41.0 Windows Flash crashing. Fixed in v41.0.1
  return false;
}

if (!blacklisted()) {
  apunit_resize();
  track_throttled("init");
  state_set("init");
  if (is_in_crossdomain_frame) {
    track_throttled("crossdomain", {"url": crossdomain_url});
  }
  if (is_sandboxed) {
    track_throttled("sandboxed");
  }
}

var playlist_order = {
  random: function (playlist) {
    playlist.sort(function(a,b){ return Math.random()-.5; });
  },

  fs: function (playlist) {
    playlist.sort(function(a,b){ return Math.random()-.5; });

    var duration_total = 0;
    for (var i=0; i<playlist.length; i++) {
      duration_total += playlist[i].duration || 0;
    }
    var average_duration = duration_total/playlist.length;
    var variance_total = 0;
    for (var i=0; i<playlist.length; i++) {
      variance_total += Math.pow((playlist[i].duration || 0) - average_duration, 2);
    }
    var variance = Math.sqrt(variance_total / playlist.length);

    if (variance > 5) playlist.sort(function(a,b) { return (Math.round(((a.duration || 0)/variance) + Math.random())) - (Math.round(((b.duration || 0)/variance) + Math.random())); });
  }
};

var streamurl_build = {
  akamai: function(canonical_url) {
    return "http" + "://hdsvam-vh.akamaihd.net/i/" + canonical_url + "/master.m3u8";
  },
  edgecast: function(canonical_url) {
    return protocol_get() + "//large.edgecast.syn-cdn.com/" + canonical_url + ".m3u8";
  },
  edgecast_mp4: function(canonical_url) {
    return "http" + "://wpc.f93a.edgecastcdn.net/80F93A/am4/video/" + canonical_url;
  }
};

var thumbnailurl_build = {
  akamai: function(canonical_url) {
    return "http" + "://image.vam.synacor.com.edgesuite.net/" + canonical_url;
  },
  edgecast: function(canonical_url) {
    return protocol_get() + "//small.edgecast.syn-cdn.com/" + canonical_url;
  },
  cloudfront: function(canonical_url) {
    return protocol_get() + "//da4pli3l5vc0d.cloudfront.net/" + canonical_url;
  }
};

var title_build = {
  d: function(old_title) {
    var date = old_title.match(/\d{1,2}\/\d{1,2}/);
    return "Don't Miss!" + (date !== null ? " - " + date : "");
  },
  db: function(old_title) {
    var date = old_title.match(/\d{1,2}\/\d{1,2}/);
    return "Don't Miss!" + (date !== null ? " - " + date : "") + " Preview";
  }
};

function browser_detect() {
  browser_class = "mozInnerScreenX" in window ? "firefox" :
    navigator.userAgent.match(/\bEdge\//) ? "edge" :
    navigator.userAgent.match(/\bTrident\/.*\brv\:11\./) ? "ie11" :
    navigator.userAgent.match(/\bMSIE 10\b/) ? "ie10" :
    navigator.userAgent.match(/\bMSIE 9\b/) ? "ie9" :
    navigator.userAgent.match(/\bMSIE 8\b/) ? "ie8" :
    navigator.userAgent.match(/\bMSIE 7\b/) ? "ie7" :
    navigator.userAgent.match(/\bMSIE 6\b/) ? "ie6" :
    navigator.userAgent.match(/\bChrome\//) ? "chrome" :
    navigator.userAgent.match(/\bFirefox\//) ? "firefox" :
    navigator.userAgent.match(/\bSafari\//) ? "safari" : "other";
  browser_features.ie = browser_class.match(/^ie/);
  browser_features.supportsWebAudio = !!(window.AudioContext || window.webkitAudioContext);
}
function vam_jsonp_recv(vamid, data) {
  if (apunit_inited) return; //too late

  if (data.status === "OK" && data.results.length) {
    cfg.playlists[vamid] = [];

    for (var i=0; i<data.results.length; i++) {
      var asset = data.results[i];

      // Remove Buzz60 Entertainment category
      if (vamid === 'b' && asset.genres) {
        var exclude_me = false;
        for (var j=0; j<asset.genres.length; j++) {
          if (asset.genres[j].toLowerCase() === 'entertainment') {
            exclude_me = true;
            break;
          }
        }
        if (exclude_me) continue;
      }

      if (!asset.media || !asset.media.videos || !asset.media.videos.length) continue;

      var videos = asset.media.videos;
      var media = [];
      for (var j = videos.length-1; j>=0; j--) {
        if (!videos[j].content || !videos[j].content[0] || !videos[j].content[0].match(/^http\:\/\//)) continue;
        if ((videos[j].bitrate === null && videos.length !== 1) || videos[j].bitrate > bitrate_limit_kbps) continue;
        media.push({
          file: videos[j].content[0].replace(/^https?:/, ''),
          bitrate: videos[j].bitrate,
          media_scheme: videos[j].media_scheme
        });
      }
      media.sort(function (a,b) { return a.bitrate-b.bitrate; });

      var item = {
        id:    asset.id,
        media: media,
        title: asset.title,
        description: asset.description,
        keywords: asset.keywords,
        duration: asset.duration
      };

      if (asset.images && asset.images.length && asset.images[0].url) {
        item.image = asset.images[0].url.replace(/^https?:/, '');
        if (asset.images[0].height && asset.images[0].width) {
          item.aspect = asset.images[0].width / asset.images[0].height;
        }
      }

      cfg.playlists[vamid].push(item);
    }

    track_throttled("vamdata");
  }

  vam_jsonp_requests_pending--;
  if (!vam_jsonp_requests_pending) {
    if (vam_jsonp_failsafe) {
      clearTimeout(vam_jsonp_failsafe);
      vam_jsonp_failsafe = null;
    }
    apunit_init();
  }
}

var DisplayFrame;
(DisplayFrame = function DisplayFrame(width, height) {
  this.loaded = false;
  this.frame = null;
  this.visible = true;
  this.width  = width;
  this.height = height;
  this.content = "";
}).prototype = {
  constructor: DisplayFrame,
  setUp: function setUp(container) {
    debug_report("setUp: " + (this.id || "content") + " instance " + (this.instance || 0));
    this.frame = document.createElement("iframe");
    //this.frame.src = "about:blank";
    this.frame.className = "playerFrame";
    this.frame.width  = container_clientWidth();
    this.frame.height = container_clientHeight();
    this.frame.style.width  = this.frame.width  + "px";
    this.frame.style.height = this.frame.height + "px";
    this.frame.style.zIndex = 0;
    container.appendChild(this.frame);
    container = null;

    var that = this;

    var load_method = function load_method(){
      that.frameLoaded();
      listener_remove(that.frame, "load", load_method);
      load_method = that = null;
    }
    listener_attach(this.frame, "load", load_method);

    try {
      //if (browser_class === "edge" || browser_features.ie) {
      //  this.frame.contentWindow.contents = this.getContent();
      //  this.frame.src='javascript:window["contents"]';
      //} else {
        this.frame.contentWindow.document.open("text/html", "replace");
        this.frame.contentWindow.document.write(this.getContent());
        this.frame.contentWindow.document.close();
      //}
    } catch (e) {
      if (browser_class === "edge" && e.message === "Unspecified error.") {
        track_always("edgebug", {"message": e.message});
        try {
          window.top.location.reload();
        } catch (ex) {
          track_always("noreload");
        }
      } else {
        track_always("framebug", {"message": e.message});
      }
      return;
    }

    var frame_window = this.frame.contentWindow;
    var closure_cleanup = function closure_cleanup() {
      iterate_selfandparents(window, function() {
        var window_to_clean = this;
        references_clean(window_to_clean, frame_window);
        references_clean(window_to_clean.document, frame_window);
        // remove all references to child frames of this window
        // TODO: really need to watch DOM for frame creation, then add
        // unload method that scrapes parents for their own stuff.
        // Otherwise a subframe could be removed before this parent
        // and leave behind garbage.
        iterate_childframes(frame_window, function() {
          references_clean(window_to_clean, this);
          references_clean(window_to_clean.document, this);
        });
      });
      listener_remove(frame_window, "unload", closure_cleanup);
      closure_cleanup = container = null;
    };
    listener_attach(frame_window, "unload", closure_cleanup);

    return this;
  },
  frameLoaded: function frameLoaded() {
    debug_report("frameLoaded: " + (this.id || "content") + " instance " + (this.instance || 0));

    this.loaded = true;
    try { this.frame.contentWindow.document.body.style.minHeight = this.height + "px"; } catch (e) {}
    frame_neuter(this.frame.contentWindow);
  },
  tearDown: function tearDown() {
    debug_report("tearDown: " + (this.id || "content") + " instance " + (this.instance || 0));
    this.loaded = false;
    if (this.frame) this.frame.parentNode.removeChild(this.frame);
    this.frame = null;
  },
  destroy: function destroy() {
    this.tearDown();
  },
  reload: function reload() {
    debug_report("reload: " + (this.id || "content") + " instance " + (this.instance || 0));
    var container = this.frame.parentNode;
    this.tearDown();
    this.setUp(container);
  },
  hide: function hide() {
    this.visible = false;
    if (this.frame) this.frame.style.zIndex = 0;
  },
  show: function show() {
    this.visible = true;
    this.frame.style.zIndex = 1;
  },
  resize: function resize(width, height) {
    width = Math.max(0,width);
    height = Math.max(0,height);
    this.width  = width;
    this.height = height;
    if (this.frame) {
      this.frame.style.width  = width  + "px";
      this.frame.style.height = height + "px";
      this.frame.width  = width;
      this.frame.height = height;
      try { this.frame.contentWindow.document.body.style.minHeight = this.height + "px"; } catch (e) {}
    }
  },
  getHeight: function getHeight() {
    return this.height;
  },
  getWidth: function getWidth() {
    return this.width;
  },
  getContent: function getContent() {
    return this.content;
  },
  setContent: function setContent(content) {
    this.content = content;
    return this.content;
  }
};

var StaticAdFrame;
(StaticAdFrame = function StaticAdFrame(width, height) {
  DisplayFrame.prototype.constructor.call(this, width, height);
  this.id = "static";
  this._loadBegin = null;
  this._loadedAt = null;
  this._shownAt = null;
  this._totalVisibleTime = 0;
  this._detectTimeout = null;
  this._detectCount = 0;
  this._loadTimeout = null;
}).prototype = new DisplayFrame(null, null);
StaticAdFrame.prototype.constructor = StaticAdFrame;
StaticAdFrame.prototype.setUp = function setUp(container) {
  DisplayFrame.prototype.setUp.call(this, container);
  var that = this;
  this._loadBegin = timestamp();
  this._loadTimeout = window.setTimeout(function() {
    track_throttled("staticfail", {"duration_ms": 20000});
    that.reload()
  }, 20000);
};
StaticAdFrame.prototype.frameLoaded = function frameLoaded() {
  DisplayFrame.prototype.frameLoaded.call(this);
  if (this._loadTimeout !== null) window.clearTimeout(this._loadTimeout);
  this._loadTimeout = null;
  this._loadedAt = timestamp();
  this.resize(this.width, this.height);
  track_throttled("staticload", {"duration_ms": this._loadedAt - this._loadBegin});
  if (this.visible) this.show();
  this._detectBadAds();
};
StaticAdFrame.prototype.tearDown = function tearDown() {
  DisplayFrame.prototype.tearDown.call(this);
  if (this._loadTimeout !== null) window.clearTimeout(this._loadTimeout);
  this._loadTimeout = null;
  if (this._detectTimeout !== null) window.clearTimeout(this._detectTimeout);
  this._detectTimeout = null;
  this._detectCount = 0;
  this._loadBegin = this._loadedAt = this._shownAt = null;
  this._totalVisibleTime = 0;
};
StaticAdFrame.prototype._detectBadAds = function _detectBadAds() {
  if (this._detectTimeout !== null) window.clearTimeout(this._detectTimeout);
  this._detectTimeout = null;
  try {
    if (this.frame && this.frame.contentWindow) {
      var ad_window = this.frame.contentWindow;
      // obfuscated in case some scanner mistakes us as providing this instead of detecting this
      var ibv_detected = false;
      var videos = ad_window.document.getElementsByTagName("video");
      if (videos.length > 0) ibv_detected = "videotag";
      if (ad_window.document.getElementById("__ced" + "ato_ro" + "ot_container")) ibv_detected = "ced" + "ato";
      var scripts = ad_window.document.getElementsByTagName("script");
      for (var i=0;i<scripts.length;i++) {
        if (scripts[i].src && scripts[i].src.match(/meme[v]ideoad\.com/)) {
          ibv_detected = "meme" + "videoad";
          break;
        }
      }
      if (ibv_detected !== false) {
        var has_log_info = false;
        var log_info = {"type": ibv_detected};
        var tag_names = ["script","img"];
        for (var k=0;k<tag_names.length;k++) {
          var tags = ad_window.document.getElementsByTagName(tag_names[k]);
          for (var i=0;i<tags.length;i++) {
            if (tags[i].src && tags[i].src.match(/.technoratimedia\.com\/pixel/)) {
              var matches = tags[i].src.match(/rid=(\d+)/);
              if (matches[1]) log_info["rid"] = matches[1];
              if (tags[i].id) log_info["id"] = tags[i].id;
              has_log_info = true;
              for(var j=0;j< tags[i].attributes.length;j++){
                if(tags[i].attributes[j].name.match(/^data-/)) {
                  log_info[tags[i].attributes[j].name] = tags[i].attributes[j].value;
                }
              }
            }
          }
        }
        var ad_frame = ad_window.document.getElementById("adFrame");
        if (ad_frame) {
          for (var k=0;k<ad_frame.childNodes.length;k++) {
            if (ad_frame.childNodes[k].nodeType == Node.COMMENT_NODE && ad_frame.childNodes[k].nodeValue.match(/Creative .*? served by Member .*? via .*?\./)) {
              //has_log_info = true;
              log_info["comment"] = ad_frame.childNodes[k].nodeValue.replace(/(^ +| +$)/, "");
              break;
            }
          }
        }
        if ("id" in log_info && log_info["id"].match(/-PM$/)) {
          var tags = ad_window.document.getElementsByTagName("script");
          for (var i=0;i<tags.length;i++) {
            if (tags[i].src && tags[i].src.match(/aktrack\.pubmatic\.com/)) {
              log_info["aktrack"] = tags[i].src;
              has_log_info = true;
              break;
            }
          }
        }
        if (!has_log_info
          || ("id" in log_info && !log_info["id"].match(/-PM$/))
          || ("comment" in log_info && log_info["comment"].match(/Member 310/))) {
          var tag_names = ["script","iframe","img", "video"];
          for (var k=0;k<tag_names.length;k++) {
            var srcs = [];
            var tags = ad_window.document.getElementsByTagName(tag_names[k]);
            for (var i=0;i<tags.length;i++) {
              if (tags[i].src && tags[i].src.length > 0 && !tags[i].src.match(/^(data:|about:|javascript:|https?:\/\/(?:(?:ad-cdn|uat-net|uat-secure).technoratimedia.com|sync.1rx.io\/usersync2\/technorati|match\.adsrvr\.org\/track\/cmf\/generic\?ttd_pid=technoratimedia|imasdk\.googleapis\.com\/js\/core\/bridge))/)) srcs.push(tags[i].src);
            }
            log_info[tag_names[k]] = srcs.join("\t");
          }
        }
        track_always("ibv", log_info);
        this.reload();
        return;
      }
    }
  } catch(e) {}
  var that = this;
  if (this._loadedAt !== null && this._detectCount++ > 5) return;
  this._detectTimeout = window.setTimeout(function() {that._detectBadAds()}, 1000);
};
StaticAdFrame.prototype.show = function show() {
  DisplayFrame.prototype.show.call(this);
  if (this._shownAt === null) this._shownAt = timestamp();
  this.frame.style.zIndex = 1000;
  this.frame.style.visibility =  "visible";
};
StaticAdFrame.prototype.hide = function hide() {
  DisplayFrame.prototype.hide.call(this);
  if (this._shownAt !== null) {
    this._totalVisibleTime += timestamp() - this._shownAt;
    this._shownAt = null;
  }
  this.frame.style.visibility =  "hidden";
};
StaticAdFrame.prototype.getContent = function getContent() {
  var content =
    '<!DOCTYPE html>' +
    '<html>' +
    '  <head>' +
    '    <meta charset="UTF-8">' +
    '      <style>' +
    '        html, body { padding: 0; margin: 0;overflow: hidden; }' +
    '        #adFrame { padding: 0;margin: auto;position: absolute;top: 0;bottom: 0;left: 0;right: 0;width: 300px; height: 250px;}' +
    '      </style>' +
    '  </head>' +
    '  <body>' +
    '    <div id="adFrame">' +
    DisplayFrame.prototype.getContent.call(this) +
    '    </div>' +
    '  </body>' +
    '</html>';
  return content;
}
StaticAdFrame.prototype.getVisibleTime = function getVisibleTime() {
  return (this._shownAt !== null ? timestamp() - this._shownAt : 0) + this._totalVisibleTime;
};
StaticAdFrame.prototype.getRotationTime = function getRotationTime() {
  return this._loadedAt !== null ? timestamp() - this._loadedAt : 0;
};

var NativeFramePlayer;
(NativeFramePlayer = function NativeFramePlayer(width, height, options) {
  DisplayFrame.prototype.constructor.call(this, width, height);
  this.muted = ("muted" in options ? options.muted : true);
  this.ready = false;
  this.failed = false;
  this._readyCallback = null;
  this._failureCallback = null;
  this._videoElement = null;
  this._hlsObject = null;
  this.isHd = false;
  this._eventHandlers = {};
  this._currentBitrate = null;
  this._options = options;
  this.eventMapping = {
    onPlay: 'playing',
    onComplete: 'ended',
    onPause: 'pause',
    onReady: 'loadedmetadata'
  };
}).prototype = new DisplayFrame(null, null);
NativeFramePlayer.prototype.constructor = NativeFramePlayer;
NativeFramePlayer.prototype.getContent = function getContent() {
  var content =
    '<!DOCTYPE html>' +
    '<html>' +
      '<head>' +
        '<meta charset="UTF-8">' +
        '<style>' +
        'html, body { margin: 0; padding: 0; overflow: hidden; }' +
        '</style>' +
        '<script type="text/javascript" src="https://cdn.jsdelivr.net/hls.js/latest/hls.light.min.js"></scr'+'ipt>' +
      '</head>' +
      '<body></body>' +
    '</html>';
  return content;
};
NativeFramePlayer.prototype.setUp = function setUp(container, readyCallback, failureCallback) {
  DisplayFrame.prototype.setUp.call(this, container);
  this._readyCallback = readyCallback || null;
  this._failureCallback = failureCallback || null;
};
NativeFramePlayer.prototype.frameLoaded = function frameLoaded() {
  DisplayFrame.prototype.frameLoaded.call(this);
  this._videoElement = this.frame.contentWindow.document.createElement("video");
  this._videoElement.width = this.width;
  this._videoElement.height = this.height;
  this._videoElement.controls = browser_class === "safari" ? false : this._options.controls;
  this._videoElement.muted = this.muted;
  this._videoElement.preload = "metadata";
  this.frame.contentWindow.document.body.appendChild(this._videoElement);

  var that = this;
  this._videoElement.addEventListener("volumechange", function (e) {
    if (that.muted !== that._videoElement.muted) apunit_setmute(that._videoElement.muted);
  });

  this.ready = true;
  if (this._readyCallback) this._readyCallback.call(this);
};
NativeFramePlayer.prototype.tearDown = function tearDown() {
  DisplayFrame.prototype.tearDown.call(this);
  if (this._hlsObject) {
    try { // In edge, calling destroy fails.
      this._hlsObject.destroy();
    } catch (e) {}
    this._hlsObject = null;
  }
  this.removeEventHandlers();
};
NativeFramePlayer.prototype.reload = function reload() {
  this.tearDown();
  this.setUp(this.frame.parentNode, this.readyCallback, this.failureCallback);
};
NativeFramePlayer.prototype.destroy = function destroy() {
  this.tearDown();
  this.readyCallback = null;
  this.failureCallback = null;
};
NativeFramePlayer.prototype.resize = function resize(width, height) {
  DisplayFrame.prototype.resize.call(this, width, height);
  if (!this._videoElement) return;
  this._videoElement.width = width;
  this._videoElement.height = height;
};
NativeFramePlayer.prototype.getPosition = function getPosition() {
  return this._videoElement.currentTime;
};
NativeFramePlayer.prototype.getDuration = function getDuration() {
  return this._videoElement.duration;
};
NativeFramePlayer.prototype.isPaused = function isPaused() {
  return this._videoElement.paused || this._videoElement.ended;
};
NativeFramePlayer.prototype.pause = function pause(state) {
  if ((state === undefined && this._videoElement.playing) || state) {
    this._videoElement.pause();
  } else {
    this._videoElement.play();
  }
};
NativeFramePlayer.prototype.seek = function seek(location) {
  return this._videoElement.currentTime = location;
};
NativeFramePlayer.prototype.isMuted = function isMuted() {
  return this.muted;
};
NativeFramePlayer.prototype.mute = function mute() {
  this.muted = true;
  return this._videoElement.muted = true;
};
NativeFramePlayer.prototype.unmute = function unmute() {
  this.muted = false;
  return this._videoElement.muted = false;
};
NativeFramePlayer.prototype.setControls = function setControls(val) {
  if (!this._videoElement) return;
  this._videoElement.controls = val;
};
NativeFramePlayer.prototype.play = function play(asset, startPosition, bitrate, autoplay) {
  var that = this;
  this._currentBitrate = bitrate;

  this.resize(this.width, cfg.show_nowplaying && asset.aspect ? Math.min(Math.round(this.width / asset.aspect), container_clientHeight()) : container_clientHeight());

  var asset_copy = clone_into_scope(asset, window, window);
  var media_file = mediafile_fetchbitrate(asset_copy, bitrate);
  if (asset.thumbnail) {
    this._videoElement.poster = asset.thumbnail;
  } else {
    delete this._videoElement.poster;
  }
  if (this._hlsObject) {
    this._hlsObject.destroy();
    this._hlsObject = null;
  }
  if (autoplay && this.frame.contentWindow.Hls && this.frame.contentWindow.Hls.isSupported()) {
    var options = {"autoStartLoad": true};
    if (startPosition) options.startPosition = startPosition;
    this._hlsObject = new this.frame.contentWindow.Hls(options);
    this._hlsObject.attachMedia(this._videoElement);
    this._hlsObject.on(this.frame.contentWindow.Hls.Events.MEDIA_ATTACHED, function() {
      if (startPosition) that._hlsObject.startPosition(startPosition);
      that._hlsObject.loadSource(media_file.sources[0].file);
      if (startPosition) that.seek(startPosition);
      if (autoplay) that._videoElement.play();
    });
  } else {
    this._videoElement.src = media_file.sources[1].file;
    if (startPosition) that.seek(startPosition);
    if (autoplay) this._videoElement.play();
  }
};
NativeFramePlayer.prototype.setBitrate = function setBitrate(bitrate) {
  if (this.isHd) bitrate = Math.max(201, bitrate);
  if (!this.ready || bitrate == this._currentBitrate) return;
  this.play(playlist[current_playlist_item], this.getPosition(), bitrate, !this.isPaused());
};
NativeFramePlayer.prototype.toggleHd = function toggleHd() {
  this.isHd = !this.isHd;
  return this.isHd;
};
NativeFramePlayer.prototype.addEventHandler = function addEventHandler(method, f, options) {
  if (!(method in this.eventMapping)) return;
  if (!(method in this._eventHandlers)) this._eventHandlers[method] = [];
  var installedmethod = f;
  if (options && options.fireOnce) {
    var that = this;
    installedmethod = function(e) {
      f.call(this, e);
      that.removeEventHandler(method, f);
    }
  }
  this._eventHandlers[method].push({
    callback: f,
    installedmethod: installedmethod,
    options: options
  });
  this._videoElement.addEventListener(this.eventMapping[method], installedmethod);
};
NativeFramePlayer.prototype.fireEventHandler = function fireEventHandler(method, e) {
  if (method in this.eventMapping) {
    this._videoElement.fireEventListener(this.eventMapping[method]);
  }
};
NativeFramePlayer.prototype.removeEventHandler = function removeEventHandler(method, f) {
  if (!(method in this._eventHandlers)) return;
  for (var i=0;i<this._eventHandlers[method].length;i++) {
    if (this._eventHandlers[method][i].callback === f) {
      this._videoElement.removeEventListener(this.eventMapping[method], this._eventHandlers[method][i].installedmethod);
      this._eventHandlers[method].splice(i, 1);
      return;
    }
  }
};
NativeFramePlayer.prototype.removeEventHandlers = function removeEventHandlers(method_or_options) {
  if (arguments.length === 0) {
    for (var m in this._eventHandlers) {
      for (var i=0;i<this._eventHandlers[m].length;i++) {
        this._videoElement.removeEventListener(this.eventMapping[m], this._eventHandlers[m][i].installedmethod);
      }
    }
    this._eventHandlers = {};
  } else if (typeof method_or_options === "string" && method_or_options in this._eventHandlers) {
    for (var i=0;i<this._eventHandlers[method_or_options].length;i++) {
      this._videoElement.removeEventListener(this.eventMapping[method_or_options], this._eventHandlers[method_or_options][i].installedmethod);
    }
    that._installedJWPCallbacks[method_or_options] = [];
  } else if (typeof method_or_options === "object") {
    for (var m in this._eventHandlers) {
      for (var i=this._eventHandlers[m].length-1;i>=0;i--) {
        if (this._eventHandlers[m][i] !== null && this._eventHandlers[m][i].options) {
          var found = true;
          for (var n in method_or_options) {
            if (!n in this._eventHandlers[m][i].options || this._eventHandlers[m][i].options[n] !== method_or_options[n]) {
              found = false;
              break;
            }
          }
          if (found) {
            this._videoElement.removeEventListener(this.eventMapping[m], this._eventHandlers[m][i].installedmethod);
            this._eventHandlers[m].splice(i, 1);
          }
        }
      }
    }
  }
};

var AdIMAPlayer;
(AdIMAPlayer = function AdIMAPlayer(width, height, options, tag, id, instance) {
  DisplayFrame.prototype.constructor.apply(this, [width, height]);
  this.tag = tag;
  this.id = id;
  this.instance = instance;
  this.busy = false;
  this.muted = "muted" in options ? options.muted : true;
  this.adLoaded = false;
  this.maxSecondsLoading = 0;
  this.maxSecondsPlaying = 0;
  this.initted = false;
  this._loadingTimeout = null;
  this._playingTimeout = null;
  this._finishedTimeout = null;
  this._startedAt = null;
  this._cleanupTimeout = null;
  this._hasImpression = false;
  this._throttleWindowStart = null;
  this._throttleWindowCount = 0;
  this.adLoadStartTime = null;
  this.adPlayStartTime = null;
  this.adReportedLengthMs = null;
  this.attempts = 0;
  this.notag = false;
  this._options = options;
  this._adsLoader = null;
  this._adsManager = null;
  this.isPrefetching = false;
  this.playingAd = true;
  this._prefetchTimeout = null;
}).prototype = new DisplayFrame(null, null);
AdIMAPlayer.prototype.constructor = AdIMAPlayer;
AdIMAPlayer.prototype.getContent = function getContent() {
  var content =
    '<!DOCTYPE html>' +
    '<html>' +
      '<head>' +
        '<meta charset="UTF-8">' +
        '<style>' +
        'html, body { margin: 0; padding: 0; overflow: hidden; background-color: black; }' +
        '#content, #adContainer { position: absolute; top: 0; width: 100%; height: 100%; }' +
        '</style>' +
        '<script type="text/javascript" src="//imasdk.googleapis.com/js/sdkloader/ima3.js"></scr'+'ipt>' +
      '</head>' +
      '<body>' +
        '<div id="content"><video id="contentElement"></video></div>' +
        '<div id="adContainer"></div>' +
      '</body>' +
    '</html>';
  return content;
};
AdIMAPlayer.prototype.resize = function resize(width, height) {
  DisplayFrame.prototype.resize.call(this, width, height);
  if (this._adsManager) this._adsManager.resize(width, height, this.frame.contentWindow.google.ima.ViewMode.NORMAL);
};
AdIMAPlayer.prototype.isMuted = function isMuted() {
  return this.muted;
};
AdIMAPlayer.prototype.mute = function mute() {
  if (this._adsManager) this._adsManager.setVolume(0);
  var player = this.frame.contentWindow.document.getElementById('contentElement');
  if (!player) return;
  this.muted = player.muted = true;
};
AdIMAPlayer.prototype.unmute = function unmute() {
  if (this._adsManager) this._adsManager.setVolume(1);
  var player = this.frame.contentWindow.document.getElementById('contentElement');
  if (!player) return;
  this.muted = player.muted = false;
};
AdIMAPlayer.prototype.setControls = function setControls(val) {
  var player = this.frame.contentWindow.document.getElementById('contentElement');
  if (!player) return;
  player.controls = this._options.controls && val;
};
AdIMAPlayer.prototype.frameLoaded = function frameLoaded() {
  DisplayFrame.prototype.frameLoaded.call(this);
  var that = this;
  this.notag = false;

  var videoContent = this.frame.contentWindow.document.getElementById('contentElement');
  videoContent.defaultMuted = this.muted;
  videoContent.muted = this.muted;
  videoContent.style.width = "100%";
  videoContent.style.height = "100%";

  if (this.muted && webaudio_context !== null && webaudio_gain !== null) {
    try {
      var node = webaudio_context.createMediaElementSource(videoContent);
      node.connect(webaudio_gain);
    } catch (e) {}
  }

  // This needs to be called before creating the display container to initially set audio to 0 on video element created by IMA.
  this.frame.contentWindow.google.ima.AdsLoader.prototype.getSettings().setRestrictToCustomPlayback(true);

  var adDisplayContainer = new this.frame.contentWindow.google.ima.AdDisplayContainer(
    this.frame.contentWindow.document.getElementById('adContainer'),
    videoContent
  );
  // Must be done as the result of a user action on mobile
  adDisplayContainer.initialize();

  // Re-use this AdsLoader instance for the entire lifecycle of your page.
  this._adsLoader = new this.frame.contentWindow.google.ima.AdsLoader(adDisplayContainer);

  // Add event listeners
  var error_handler = function (e) {
    debug_report("ERROR: " + that.id + " instance " + (that.instance || 0));
    var error = "getError" in e ? e.getError() : {};
    if ("getErrorCode" in error && error.getErrorCode() == 901 && "getInnerError" in error) error = error.getInnerError();
    that.clearTimeouts("all");
    that._hasImpression = false;
    if (that._adsManager) that._adsManager.destroy();
    if (that.isPrefetching || ads_handlestate("error", that)) {//short-circuit
      track_throttled("aderror", {"adtag_id": that.id, "type": "getType" in error ? error.getType() : "", "message": "getMessage" in error ? error.getMessage() : e.message});
    }
    that.finishAd();
  }
  // VAST errors or only unplayable creatives in VAST
  this._adsLoader.addEventListener(
    this.frame.contentWindow.google.ima.AdErrorEvent.Type.AD_ERROR,
    error_handler,
    false
  );
  this._adsLoader.addEventListener(
    this.frame.contentWindow.google.ima.AdsManagerLoadedEvent.Type.ADS_MANAGER_LOADED,
    function (adsManagerLoadedEvent) {
      // Get the ads manager.
      that._adsManager = adsManagerLoadedEvent.getAdsManager(videoContent, {
        enablePreloading: true,
        loadVideoTimeout: that.maxSecondsLoading * 1000
      });

      // Error while playing Ad
      that._adsManager.addEventListener(
        that.frame.contentWindow.google.ima.AdErrorEvent.Type.AD_ERROR,
        error_handler
      );
      that._adsManager.addEventListener(
        that.frame.contentWindow.google.ima.AdErrorEvent.Type.CLICK,
        function () {
          track_always("click", {"player_id": that.id});
          user_interaction_event();
        }
      );

      that._adsManager.addEventListener(
        that.frame.contentWindow.google.ima.AdEvent.Type.LOADED,
        function () {
          debug_report("LOADED: " + that.id + " instance " + (that.instance || 0));
          that._adsManager.setVolume(that.muted ? 0 : 1);
          that._adsManager.resize(that.width, that.height, that.frame.contentWindow.google.ima.ViewMode.NORMAL);
          that.adLoaded = true;
          that.clearTimeouts("loading");
          if (!that.isPrefetching && !ad_playing_mutex) {
            that.startAd();
          } else {
            that.busy = false;
          }
        }
      );

      that._adsManager.addEventListener(
        that.frame.contentWindow.google.ima.AdEvent.Type.IMPRESSION,
        function () {
          debug_report("IMPRESSION: " + that.id + " instance " + (that.instance || 0));
          that._adsManager.setVolume(that.muted ? 0 : 1);
          that._adsManager.resize(that.width, that.height, that.frame.contentWindow.google.ima.ViewMode.NORMAL);
          track_throttled("imaimpression", {"adtag_id": that.id });
        }
      );
      that._adsManager.addEventListener(
        that.frame.contentWindow.google.ima.AdEvent.Type.STARTED,
        function (adEvent) {
          debug_report("STARTED: " + that.id + " instance " + (that.instance || 0));
          that._adsManager.setVolume(that.muted ? 0 : 1);
          that._adsManager.resize(that.width, that.height, that.frame.contentWindow.google.ima.ViewMode.NORMAL);
          that.adLoaded = false;
          that.clearTimeouts("playing");
          that.adPlayStartTime = timestamp();
          var duration = -1;
          try {
            duration = adEvent.getAd().getDuration();
          } catch (e) {};
          that.startFinishedTimer(duration);
          that.adReportedLengthMs = duration * 1000;
          track_throttled("adreportedtime", {"adtag_id": that.id, "duration_ms": that.adReportedLengthMs ? Math.floor(that.adReportedLengthMs) : "unknown"});
          that.impressionEvent();
        }
      );
      that._adsManager.addEventListener(
        that.frame.contentWindow.google.ima.AdEvent.Type.ALL_ADS_COMPLETED,
        function () {
          debug_report("ALL_ADS_COMPLETED: " + that.id + " instance " + (that.instance || 0));
          that.clearTimeouts("all");
          if (!that._hasImpression) {
            track_throttled("adstop", {"adtag_id": that.id, "message": e.message});
          } else {
            that._hasImpression = false;
            // create temp variables for logging since values get wiped in ads_handlestate(complete)
            var playstarttime = that.adPlayStartTime;
            var reportedlength = that.adReportedLengthMs;
            if (ads_handlestate("complete", that)) {
              track_throttled("adplaytime", {"adtag_id": that.id, "duration_ms": playstarttime ? Math.floor(timestamp() - playstarttime) : "unknown", "reported_ms": reportedlength ? Math.floor(reportedlength) : "unknown"});
            }
          }
          that.finishAd();
        }
      );

      try {
        // Initialize the ads manager. Ad rules playlist will start at this time.
        that._adsManager.init(that.width, that.height, that.frame.contentWindow.google.ima.ViewMode.NORMAL);
      } catch (adError) {
        // general error?
        error_handler(adError);
      }
    },
    false
  );

  this._adsLoader.getSettings().setVpaidMode(this.frame.contentWindow.google.ima.ImaSdkSettings.VpaidMode.INSECURE);
  this._adsLoader.getSettings().setNumRedirects(4);
  this._adsLoader.getSettings().setAutoPlayAdBreaks(false);
  this.ready = true;
  if (!disable_ads && cfg.prefetching && this.id.match(/^(?:google|adx)/) && !this.id.match(/_backfill$/)) {
    this._prefetchTimeout = window.setTimeout(function () {
      that._prefetchTimeout = null;
      that.loadAd(true, playlist[current_playlist_item], 60, 60);
    }, 5000);
  }
};
AdIMAPlayer.prototype.getImpressionColors = function getImpressionColors() {
  var tag_prefix = (this.id.match(/^(.*?)_/))[1];
  var colors = [("00" + (this.id.charCodeAt(0) - "a".charCodeAt(0)).toString(16)).slice(-2) +
                ("00" + (this.id.charCodeAt(1) - "a".charCodeAt(0)).toString(16)).slice(-2) +
                ("00" + (this.id.charCodeAt(2) - "a".charCodeAt(0)).toString(16)).slice(-2)];
  if (this.id.match(/^springserve_/)) {
    var demand_tag = null;
    try {
      var ad_frames = this.frame.contentWindow.document.getElementById("adContainer").getElementsByTagName("iframe");
      frame_loop: for (var i=0;i<ad_frames.length;i++) {
        try {
          var images = ad_frames[i].contentWindow.document.getElementsByTagName("img");
          var highest_ts = 0;
          var highest_corresponding_demand = null;
          var all_ss_pixels = [];
          for (var j=0;j<images.length;j++) {
            if (images[j].src.match(/^https?:\/\/vid-io\.springserve\.com\/vd\/i/)) {
              all_ss_pixels.push(images[j].src);
              if (images[j].src.match(/(?:\?|&)event=.*?_impression(?:&|$)/) &&
                 (demand_tag = (images[j].src.match(/(?:\?|&)a_cc=s.[0-9]+-d.([0-9]+)/))[1])) {
                 colors.push(color_from_int(parseInt(demand_tag, 10)));
                break frame_loop;
              }
              if (images[j].src.match(/(?:\?|&)event=.*?_demand_(?:opportunity|response)(?:&|$)/)) {
                var ts = (images[j].src.match(/(?:\?|&)timestamp=([0-9]+)/))[1];
                var cur_demand = (images[j].src.match(/(?:\?|&)a_cc=s.[0-9]+-d.([0-9]+)/))[1];
                if (ts && cur_demand && ts > highest_ts) highest_corresponding_demand = cur_demand;
              }
            }
          }
        } catch (e) {}
      }
      if (demand_tag === null) {
        track_throttled("ss_no_imp_pix", {"demand_tag": highest_corresponding_demand, "ss_pixels": all_ss_pixels});
        colors.push(color_from_int(parseInt(highest_corresponding_demand, 10)));
      }
    } catch (e) {}
  }
  return colors;
}

AdIMAPlayer.prototype.getTag = function getTag() {
  // From Springserve:
  // Small <350; Medium 350-500; Large (>500)
  var size_class = this.width < 350
                     ? "small"
                     : (this.width > 500 ? "large" : "medium");

  // From AOL:
  // Small <350; Medium <500; Large >500
  if (this.id.match(/^adaptv(_|$)/) || this.id.match(/^rockyou(_|$)/)) {
    size_class = this.width < 350
                     ? "small"
                     : (this.width >= 500 ? "large" : "medium");
  }

  // From Spotx:
  // Small <=300; Medium 301-600; Large >600
  if (this.id.match(/^spotxchange(_|$)/)) {
    size_class = this.width <= 300
                     ? "small"
                     : (this.width > 600 ? "large" : "medium");
  }

  // From Tremor
  // Small (200 < Width < 400); Medium (400 < Width < 600); Large (600 < Width < 800)
  if (this.id.match(/^tremor(_|$)/)) {
    size_class = this.width < 400
                     ? "small"
                     : (this.width >= 600 ? "large" : "medium");
  }

  var tag = typeof this.tag === "object"
           ? (this.tag[size_class] ? this.tag[size_class] : this.tag["default"] ? this.tag["default"] : null)
           : this.tag;
  if (this.id.match(/^spotxchange_/)) {
    if (protocol_get() === "https:") tag += "&secure_response=1";
    tag = tag.replace(/VPAID=1/, 'VPAID=js');
    if (!flash_autoplay || !can_load_flash) {
      tag += '&vpix[]=VPAID&vpix[]=FLV';
    } else {
      tag += '&allow_flash_creative=1';
    }
  }
  if (tag===null) return null;
  return (tag.match(/^\/\//) ? protocol_get() : "") + tag;
};
AdIMAPlayer.prototype.clearTimeouts = function clearTimeouts(type) {
  if ((type === "progress" || type === "all") && this._progressTimeout !== null) {
    window.clearTimeout(this._progressTimeout);
    this._progressTimeout = null;
  }
  if ((type === "cleanup" || type === "all") && this._cleanupTimeout !== null) {
    window.clearTimeout(this._cleanupTimeout);
    this._cleanupTimeout = null;
  }
  if ((type === "loading" || type === "all") && this._loadingTimeout !== null) {
    window.clearTimeout(this._loadingTimeout);
    this._loadingTimeout = null;
  }
  if ((type === "playing" || type === "all") && this._playingTimeout !== null) {
    window.clearTimeout(this._playingTimeout);
    this._playingTimeout = null;
  }
  if ((type === "finished" || type === "all") && this._finishedTimeout !== null) {
    window.clearTimeout(this._finishedTimeout);
    this._finishedTimeout = null;
  }
};
AdIMAPlayer.prototype.clearForeignTimeouts = function clearForeignTimeouts() {
  debug_report("clearForeignTimeouts");
  if (!this.frame || !this.frame.contentWindow.synap_adframe_timeouts) return;
  for (var method in this.frame.contentWindow.synap_adframe_timeouts) {
    for (var timeout in this.frame.contentWindow.synap_adframe_timeouts[method]) {
      debug_report("clearing foreign timeout: " + method + " #" + timeout);
      this.frame.contentWindow.synap_adframe_timeouts[method][timeout]['clear' + method].call(this.frame.contentWindow.synap_adframe_timeouts[method][timeout], timeout);
    }
  }
  delete this.frame.contentWindow.synap_adframe_timeouts
};
AdIMAPlayer.prototype.startLoadingTimer = function startLoadingTimer() {
  if (!this.maxSecondsLoading || this._loadingTimeout !== null) return;
  var that = this;
  this._startedAt = timestamp();
  this._loadingTimeout = window.setTimeout(function(){
    that.stopAd();
    if (that.isPrefetching || ads_handlestate("loadTimeout", that)) {//short-circuit
      track_throttled("adloadtimealarm", {"adtag_id": that.id, "duration_ms": Math.floor(that.maxSecondsLoading * 1000)});
    }
  }, this.maxSecondsLoading * 1000);
};
AdIMAPlayer.prototype.startPlayingTimer = function startPlayingTimer() {
  if (!this.maxSecondsLoading || this._playingTimeout !== null) return;
  var that = this;

  this._playingTimeout = window.setTimeout(function(){
    that.stopAd();
    if (that.isPrefetching || ads_handlestate("loadTimeout", that)) {//short-circuit
      track_throttled("adstarttimealarm", {"adtag_id": that.id, "duration_ms": Math.floor(that.maxSecondsLoading * 1000)});
    }
  }, this.maxSecondsLoading * 1000);
};
AdIMAPlayer.prototype.startFinishedTimer = function startFinishedTimer(duration) {
  if (!this.maxSecondsPlaying || this._finishedTimeout !== null) return;
  if (duration <= 0) duration = 15;
  var timerLength = 1000 * Math.ceil((this.maxSecondsPlaying.match && this.maxSecondsPlaying.match(/^r\+\d+$/)) ? (duration < 0 ? 1 : duration) + parseInt(this.maxSecondsPlaying.substr(2), 10) : parseInt(this.maxSecondsPlaying, 10));
  if (isNaN(timerLength)) timerLength = 60000;
  var that = this;
  this._finishedTimeout = window.setTimeout(function(){
    that.stopAd();
    if (ads_handlestate("playTimeout", that)) {
      track_throttled("adplaytimealarm", {"adtag_id": that.id, "duration_ms": timerLength || "unknown"})
    }
  }, timerLength);
};
AdIMAPlayer.prototype.tearDown = function tearDown() {
  this.clearTimeouts("all");
  if (this._prefetchTimeout) {
    window.clearTimeout(this._prefetchTimeout);
    this._prefetchTimeout = null;
  }
  this.ready = this.busy = this.initted = this.adLoaded = this.isPrefetching = this.playingAd = this.adLoaded = false;
  this._adsManager = this._adsLoader = this.adLoadStartTime = this.adPlayStartTime = this.adReportedLengthMs = null;
  this.attempts = 0;
  DisplayFrame.prototype.tearDown.call(this);
};
AdIMAPlayer.prototype.impressionEvent = function impressionEvent(e) {
  this.adPlayStartTime = timestamp();
  if (ads_handlestate("impression", this)) {
    impressioncolor_set(this.getImpressionColors());
    this._hasImpression = true;
    state_set("impression-" + this.id);
    track_throttled("impression", {"adtag_id": this.id});
    track_throttled("adloadtime", {"adtag_id": this.id, "duration_ms": this.adLoadStartTime ? Math.floor(timestamp() - this.adLoadStartTime) : "unknown"});
  } else {
    track_throttled("lateimpression", {"adtag_id": this.id});
    debug_report("stopping ad player: " + adplayer.id + " instance " + (adplayer.instance || 0));
    this.stopAd();
  }
};
AdIMAPlayer.prototype.loadAd = function loadAd(isPrefetch, playlistItem, maxSecondsLoading, maxSecondsPlaying) {
  debug_report("loadAd: " + this.id + " instance " + (this.instance || 0));
  if (this._prefetchTimeout) {
    window.clearTimeout(this._prefetchTimeout);
    this._prefetchTimeout = null;
  }
  this.isPrefetching = isPrefetch;
  this.attempts++;
  this.busy = true;
  this.maxSecondsLoading = maxSecondsLoading;
  this.maxSecondsPlaying = maxSecondsPlaying;
  this.adPlayStartTime = this.adReportedLengthMs = null;
  this.adLoadStartTime = timestamp();

  if (this.adLoaded) {
    if (!this.isPrefetching) {
      this.startAd();
    } else {
      this.busy = false;
    }
    return;
  }

  // Tremor throttling ... no more than 4 per minute, per user.
  if (this.id.match(/^tremor(_|$)/)) {
    if (this._throttleWindowStart === null || timestamp() - this._throttleWindowStart > 60000) {
      this._throttleWindowStart = timestamp();
      this._throttleWindowCount = 0;
    }
    this._throttleWindowCount++;
    if (this._throttleWindowCount > 4) {
      track_throttled("throttlead", {"adtag_id": this.id});
      this.fireEventHandler("onAdError", {"message": "throttled"});
      return;
    }
  }

  this.startLoadingTimer();

  // Request video ads.
  var adsRequest = new this.frame.contentWindow.google.ima.AdsRequest();
  var mediafile = mediafile_fetchbitrate(playlistItem, 10000);
  adsRequest.adTagUrl = this.getTag()
    .replace(/__random-number__/g, Math.random())
    .replace(/__item-sizebucket__/g, this.width < 350 ? "small" : this.width > 500 ? "large" : "medium")
    .replace(/__item-playerwidth__/g, this.width)
    .replace(/__item-playerheight__/g, this.height)
    .replace(/__item-realduration__/g, playlistItem.duration || 60)
    .replace(/__item-bucket__/g, Math.floor(Math.random() * 100) + 1)
    .replace(/__item-viewable__/g, apunit_hasfocus() && apunit_isinviewport(0.5) ? "1" : "0")
    .replace(/__item-allowflashonly__/g, can_load_flash && flash_autoplay ? "1" : "0")
    .replace(/__item-flashok__/g, can_load_flash && flash_autoplay ? "1" : "0")
    .replace(/__item-flashstate__/g, can_load_flash === true ? "1" : can_load_flash === false ? "0" : "2")
    .replace(/__item-isprefetch__/g, isPrefetch ? "1" : "0")
    .replace(/__item-description__/g, playlistItem.description || "")
    .replace(/__item-id__/g, playlistItem.id || "")
    .replace(/__item-keywords__/g, playlistItem.keywords || "")
    .replace(/__item-title__/g, playlistItem.title || "")
    .replace(/__item-srcurl__/g, mediafile && mediafile.sources && mediafile.sources[0] && mediafile.sources[0]['file'] ? mediafile.sources[0]['file'] : '')
    .replace(/__timestamp__/g, timestamp())
    .replace(/__item-vpaid__/g, "js")
    .replace(/__item-flashautoplay__/g, flash_autoplay ? "1" : "0");

  // Specify the linear and nonlinear slot sizes. This helps the SDK to
  // select the correct creative if multiple are returned.
  adsRequest.linearAdSlotWidth = this.width;
  adsRequest.linearAdSlotHeight = this.height;
  //adsRequest.nonLinearAdSlotWidth = 300;
  //adsRequest.nonLinearAdSlotHeight = 250;
  adsRequest.setAdWillAutoPlay(true);
  adsRequest.contentDuration = playlistItem.duration || 60;
  adsRequest.vastLoadTimeout = maxSecondsLoading * 1000;
  if (playlistItem.keywords) adsRequest.contentKeywords = playlistItem.keywords;
  if (playlistItem.title) adsRequest.contentTitle = playlistItem.title;

  this._adsLoader.getSettings().setDisableFlashAds(!can_load_flash || !flash_autoplay);
  this._adsLoader.requestAds(adsRequest);

  return true;
};
AdIMAPlayer.prototype.startAd = function startAd() {
  debug_report("startAd: " + this.id + " instance " + (this.instance || 0));
  if (!this._adsManager || !this.adLoaded) return;
  this.playingAd = true;
  this._adsManager.resize(this.width, this.height, this.frame.contentWindow.google.ima.ViewMode.NORMAL);
  this._adsManager.setVolume(this.muted ? 0 : 1);
  // Call start to show ads. Single video and overlay ads will
  // start at this time; this call will be ignored for ad rules, as ad rules
  // ads start when the adsManager is initialized.
  this._adsManager.start();
  this.startPlayingTimer();
};
AdIMAPlayer.prototype.stopAd = function stopAd() {
  debug_report("stopAd: " + this.id + " instance " + (this.instance || 0));
//  this.busy = false;
  this.finishAd();
};
AdIMAPlayer.prototype.finishAd = function finishAd() {
  debug_report("finishAd: " + this.id + " instance " + (this.instance || 0));
  this.hide();
  this.clearTimeouts("all");
  this.clearForeignTimeouts();
  this.reload(); // TODO: reloading every time now
/*
  if (this.busy
    || ((!cfg.player_reload_attempts || (cfg.player_reload_attempts >= 0 && this.attempts >= cfg.player_reload_attempts)) && !(browser_class === "chrome" && !apunit_hasfocus()))) {
    this.reload();
  } else {
    this.busy = this.usingVPAID = false;
  }
*/
};

function frame_neuter(frame_window) {
  try {
    frame_window.alert   = function(msg) { if (console && console.info) console.info("window.alert: " + msg); }
    frame_window.prompt  = function(msg) { if (console && console.info) console.info("window.prompt: " + msg); return null; }
    frame_window.confirm = function(msg) { if (console && console.info) console.info("window.confirm: " + msg); return false; }
    delete frame_window.Element.prototype.scrollIntoView;
    if (frame_window.navigator && frame_window.navigator.geolocation && frame_window.navigator.geolocation.getCurrentPosition) {
      frame_window.navigator.geolocation.getCurrentPosition = function() {};
    }

    for (var prop in frame_window.console) {
      if (frame_window.console[prop] && typeof frame_window.console[prop] === 'function') {
        var old_method = frame_window.console[prop];
        frame_window.console[prop] = function() {
          if (debug) {
            var args = Array.prototype.slice.call(arguments);
            return old_method.apply(this, args);
          }
        }
      }
    }

    timeouts_override(frame_window, "Timeout");
    timeouts_override(frame_window, "Interval");

	var search_nodes = function search_nodes(parent_node) {
	  if (!parent_node || !parent_node.getElementsByTagName) return;
      if (!user_interacted && apunit_ismuted() && webaudio_context !== null && webaudio_gain !== null) {
        var videos = Array.prototype.slice.call(parent_node.getElementsByTagName("video"));
        if (parent_node.nodeName.toLowerCase() === "video") {
          videos.push(parent_node);
        }
        for (var j=0;j<videos.length;j++) {
          try {
            var node = webaudio_context.createMediaElementSource(videos[j]);
            node.connect(webaudio_gain);
          } catch (e) {};
        }
      }
      var iframes = Array.prototype.slice.call(parent_node.getElementsByTagName("iframe"));
      if (parent_node.nodeName.toLowerCase() === "iframe") {
        iframes.push(parent_node);
      }
      for (var j=0;j<iframes.length;j++) {
        var new_frame = iframes[j];
        var closure_cleanup = function closure_cleanup() {
          frame_neuter(this.contentWindow);
          listener_remove(this, "load", closure_cleanup);
          closure_cleanup = null;
        };
        listener_attach(new_frame, "load", closure_cleanup);
        frame_neuter(new_frame.contentWindow);
      }
	}

	search_nodes(frame_window.document);

    if (frame_window.MutationObserver) {
      var observer = new frame_window.MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.addedNodes) {
            for(var i=0;i<mutation.addedNodes.length;i++) {
              search_nodes(mutation.addedNodes[i]);
            }
          }
        });
      });
      observer.observe(frame_window.document.body, { childList: true, subtree: true });
      var closure_cleanup = function closure_cleanup() {
        observer.disconnect();
        listener_remove(frame_window, "unload", closure_cleanup);
        closure_cleanup = observer = frame_window = mutations = null;
      };
      listener_attach(frame_window, "unload", closure_cleanup);
    }
  } catch (e) {}
}

function players_create() {
  apunit_resize();
  //disabled: called on ads before they're loaded and errors... window.setInterval(apunit_resize, 5000);

  var player_finished = function player_finished(e){
    var player_id = this.id || "content";
    track_throttled("ready", {"player_id": player_id});

    // Fired by Malamute stage clicks from "clickcallback".
    // This fires on almost every click... including inside most interactive ads.
    // This also seems to fire every time onDisplayClick normally fires.
    this.addEventHandler("onStageClick", function(e){
      track_always("click", {"player_id": player_id});
      user_interaction_event();
    });

    // Fired by JWPlayer stage clicks of the actual clip (not an ad). Typically when
    // a click would normally toggle a play/pause state.
    this.addEventHandler("onDisplayClick", function(e){user_interaction_event();});

    if (players_remaining > 0) {
      players_remaining--;
      apunit_init();
    }
  };

  var content_player_finished = function content_player_finished(e) {
    this.addEventHandler("onPlay",   function(e){state_set("playing");});
    this.addEventHandler("onPause",  function(e){state_set("paused");});
    this.addEventHandler("onBuffer", function(e){state_set("buffering");});
    this.addEventHandler("onIdle",   function(e){state_set("idle");});
    player_finished.call(this);
    apunit_init();
  };

  var setup_error = function setup_error(type, e){
    track_throttled(type, e);
  };

  if (browser_class !== "ie8") {
    content_player = new NativeFramePlayer(
      container_clientWidth(),
      container_clientHeight(),
      {
        muted: audiomode_starts_muted[cfg.audio_mode],
        controls: false
      }
    );
    content_player.setUp(document.getElementById("playerContainer"), content_player_finished, setup_error);
  }
  players_remaining++;

  var all_tags = {};
  var default_tag_frequency = {};
  var large_tag_frequency = {};
  for (var i=0;i<cfg.ad_tags.length;i++) {
    all_tags[cfg.ad_tags[i].id] = {url: cfg.ad_tags[i].url, type: cfg.ad_tags[i].type ? cfg.ad_tags[i].type : null};
    default_tag_frequency[cfg.ad_tags[i].id] = default_tag_frequency[cfg.ad_tags[i].id] || 0;
    default_tag_frequency[cfg.ad_tags[i].id]++;
  }
  for (var i=0;i<cfg.large_ad_tags.length;i++) {
    all_tags[cfg.large_ad_tags[i].id] = {url: cfg.large_ad_tags[i].url, type: cfg.large_ad_tags[i].type ? cfg.large_ad_tags[i].type : null};
    large_tag_frequency[cfg.large_ad_tags[i].id] = large_tag_frequency[cfg.large_ad_tags[i].id] || 0;
    large_tag_frequency[cfg.large_ad_tags[i].id]++;
  }

  var tag_names = [];
  for (var id in all_tags) {
    var max_frequency = Math.max(default_tag_frequency[id] || 0, large_tag_frequency[id] || 0);
    for (var i=0;i<max_frequency;i++) tag_names.push(id);
  }

  for (var i=0;i<tag_names.length;i++) {
    var tag = tag_names[i];
    ad_players.push(new AdIMAPlayer(
      container_clientWidth(),
      container_clientHeight(),
      {
        audioMode: cfg.audio_mode,
        muted: audiomode_starts_muted[cfg.audio_mode],
        autoPlay: false,
        loop: false,
        controls: false
      },
      all_tags[tag].url,
      tag,
      ad_players.length
    ));
    players_remaining++;
    ad_players[ad_players.length - 1].setUp(document.getElementById("playerContainer"));
  }
  if (cfg.static_fallback_tag) {
    staticfallback_player = new StaticAdFrame(container_clientWidth(), container_clientHeight());
    staticfallback_player.setContent(cfg.static_fallback_tag);
  }
}

function apunit_init() {
  debug_report("apunit_init");
  if (apunit_inited || vam_jsonp_failsafe !== null || !content_player || !content_player.ready) return;
  apunit_inited = true;
  if (playlist.length < 1) playlist_build();
  
  loadingcover_hide();

  if (pii_detected && !non_adx_tags_present) {
    autoplay = false;
    disable_ads = true;
    cfg.autoplay_mode = cfg.autoplay_mode.match(/preview/) ? 'preview' : 'never';
  }

  if (autoplay) {
    tracking_fire("start");
    track_throttled("firstcontent");
  }

  if (cfg.show_nowplaying) {
    nowplaying_container_create();
  }

  if (cfg.replace_dcc) dcc_install_replacement_handler();

  ad_spots_remaining = playlist[current_playlist_item].pre_ads;


  if (autoplay) {
    has_started = true;
    ads_start();
  } else {
    content_player.resize(container_clientWidth(), container_clientHeight());
    content_player.addEventHandler("onReady", function(e) {
      debug_report("onReady3");
      loadingcover_hide();
      content_player.setControls(true);
      if (cfg.autoplay_mode !== "delayedpreview") content_player.show();
      apunit_resize();
      nowplaying_show();
    }, {fireOnce: true});
    content_player.addEventHandler("onPlay", function(e) {
      debug_report("onPlay1");
      tracking_fire("start");
      track_throttled("firstcontent");
      has_started = true;
      ad_spots_remaining = 0; // User likely clicked play. Let them play.
      content_player.setControls(false);
      apunit_resize();
    }, {fireOnce: true});

    var action, target, action_name = null;
    if (cfg.autoplay_mode === 'onfocus' || cfg.autoplay_mode === 'inviewport') {
      try {
        target = window.top;
        action_name = cfg.autoplay_mode === 'onfocus' ? 'focus' : 'scroll';
        action = function() {
          if (cfg.autoplay_mode === 'inviewport' && !apunit_isinviewport(0.5)) return;
          track_throttled((cfg.autoplay_mode === 'onfocus' ? 'focus' : 'inviewport') + 'play');
          has_started = true;
          ads_start();
        };
        listener_attach(target, action_name, action);
      } catch (e) {}
    } else if (!cookie_get("synapm") && cfg.autoplay_mode.match(/^delayed/) && cfg.autoplay_mode_delay && parseInt(cfg.autoplay_mode_delay, 10) > 0) {
      delay_timeout = window.setTimeout(function () {
        if (cfg.autoplay_mode === "delayedpreview") adloadsplash_hide();
        content_player.setControls(false);
        has_started = true;
        ads_start();
      }, parseInt(cfg.autoplay_mode_delay, 10) * 1000);
    }
    if (cfg.autoplay_mode.match(/preview/)) adloadsplash_show();
    content_player.addEventHandler("onComplete", function(e) {
      if (cfg.autoplay_mode === 'onfocus' || cfg.autoplay_mode === 'inviewport') {
        listener_remove(target, action_name, action);
      }
      if (delay_timeout !== null) {
        window.clearTimeout(delay_timeout);
        delay_timeout = null;
      }
    }, {fireOnce: true});
    apunit_playitem(current_playlist_item, false);
  }
}

function adbreak_timer_install() {
  if (disable_ads) return;
  var timer = cfg.timed_ad_break_secs;
  if (timer <= 0) return;
  if (cfg.background_ads
      && !user_interacted
      && (
           (!cfg.background_only_viewable && (apunit_hasoldfocus() === false || apunit_isinviewport(0) === false))
           || (cfg.background_only_viewable && apunit_hasoldfocus() === false && apunit_hasfocus() && apunit_isinviewport(0.5))
         )
      ) {
    timer = 1;
    background_ad = true;
  }
  if (adbreak_timer_timeout === null) {
    adbreak_timer_timeout = window.setTimeout(adbreak_fire, timer * 1000);
  }
}

function adbreak_timer_remove() {
  if (adbreak_timer_timeout) {
    window.clearTimeout(adbreak_timer_timeout);
    adbreak_timer_timeout = null;
  }
}

function adbreak_timer_resetall_if_fired() {
  // Handles the condition where the adbreak timer fired, the ads are loading, and the
  // user pauses the content or the content ends and a playlist break happens. In those
  // conditions we need to kill the adplayers so they don't take over.
  if (!ad_playing_mutex && ad_playing_break_type === 'midroll' && adbreak_timer_timeout === null) {
    ads_resetall(null, "adbreak_timer_resetall_if_fired");
    ad_loading_mutex = false;
    ad_playing_break_type = null;
  }
}

function adbreak_fire() {
  debug_report("adbreak_fire");
  adbreak_timer_timeout = null;
  ad_playing_break_type = 'midroll';
  ad_spots_remaining = 100; // Keep attempting ads until one plays.
  ads_start();
}

function ads_handlestate(state, adplayer) {
  debug_report("ads_handlestate: " + state + " - " + adplayer.id  + " instance " + (adplayer.instance || 0));
  switch (state) {
    case "loadTimeout":
    case "error":
      ads_after();
    break;
    case "impression":
      if (ad_playing_mutex) {
        return false; // discard event
      }
      ad_playing_mutex = true;
      ads_resetall(adplayer, "impression");
      if (cfg.ad_scheduling === "simultaneous") current_ad_chain = [];
      adplayer.show();
      if (ad_playing_break_type === "midroll") {
        content_player.pause(true);
        content_player.hide();
      }
      loadingcover_hide();
      adloadsplash_hide();
      staticad_hide();
      nowplaying_show();
    break;
    case "playTimeout":
    case "complete":
      ad_playing_mutex = false;
      current_ad_chain = [];
      ad_spots_remaining--;
      ads_finish(true, true);
    break;
  };
  return true; // return true when event is not discarded
}

function ads_start() {
  debug_report("ads_start");
  if (disable_ads || ad_spots_remaining < 1) {
    apunit_resumeitem(current_playlist_item);
    return;
  }
  if (ads_start_time && timestamp() - ads_start_time <= min_adslot_time_secs * 1000) {
    debug_report("ads_start: waiting");
    ads_start_timeout = window.setTimeout(function () {ads_start_timeout = null;ads_start()}, (min_adslot_time_secs * 1000) - (timestamp() - ads_start_time));
    return;
  }
  ads_start_time = null;

  adbreak_timer_remove();
  if (master_pause || ads_start_retry_timeout !== null) return;
  if (ad_loading_mutex) {
    debug_report("ads_start: ad_loading_mutex");
    if (!ad_playing_mutex) {
      adloadsplash_show();
      nowplaying_hide();
      staticad_show();
    }
    return;
  }

  if (ad_playing_break_type !== "midroll") {
    adloadsplash_show();
    nowplaying_hide();
    staticad_show();
  }

  if (browser_class === "chrome" && !apunit_hasfocus()) {
    if (focus_wait || ad_playing_break_type === "midroll") return;
    focus_wait = true;
    track_throttled("focuswait", "ads_start");
    var focuswait_method;
    focuswait_method = function () {
      if (apunit_hasfocus()) {
        focus_wait = false;
        track_throttled("focusgain", "ads_start");
        listener_remove(document, "visibilitychange", focuswait_method);
        ads_start();
      }
    }
    listener_attach(document, "visibilitychange", focuswait_method);
    return;
  }

  var one_ready = false;
  var no_tag = 0;
  for (var i=0;i<ad_players.length;i++) {
    if (ad_players[i].ready) {
      one_ready = true;
    } else if (ad_players[i].failed) {
      ad_players[i].reload();
    } else if (ad_players[i].notag) {
      no_tag++;
    }
  }
  if (no_tag >= ad_players.length) {
    ad_spots_remaining--;
    track_throttled("notags");
    ads_finish(false, false);
    return;
  }
  debug_report("ads_start: one_ready - " + (one_ready ? "true" : "false"));

  if (!one_ready) {
    ads_start_retry_timeout = window.setTimeout(function () {ads_start_retry_timeout = null;ads_start();}, 1000);
    return;
  }
  if (ad_playing_break_type === null) ad_playing_break_type = 'playlist';
  if (current_ad_chain.length < 1 && ad_spots_remaining > 0) {
    var ad_tags = cfg.ad_tags;
    // NOTE: be aware that not all ad networks start large at 500px, but we have to just pick a size for everyone.
    if (content_player.width >= 500 && cfg.large_ad_tags.length > 0) ad_tags = cfg.large_ad_tags;

    for (var i=0;i<ad_tags.length;i++) {
      current_ad_chain.push(ad_tags[i]);
    }
  }

  track_throttled("adslot");
  ad_loading_mutex = true;
  ads_start_time = timestamp();
  if (cfg.ad_scheduling === "sequential") {
    ad_load(current_ad_chain.shift(), skip_chaining);
  } else if (cfg.ad_scheduling === "simultaneous") {
    if (simultaneous_ad_loader_timeout !== null) { // just in case we're called before the last timeline finishes.
      window.clearTimeout(simultaneous_ad_loader_timeout);
      simultaneous_ad_loader_timeout = null;
    }
    ads_simultaneous_loader(current_ad_chain.slice(), 0, 0);
  }
}

function ads_simultaneous_loader(ads, current_tick, total_ticks) {
  debug_report("ads_simultaneous_loader: current_tick - " + current_tick + "; total_ticks: " + total_ticks);
  if (ad_playing_mutex || simultaneous_ad_loader_timeout !== null) return;
  var currently_busy = false;
  var next_tick_with_action = null;
  var final_tick = null;
  for (var i=0;i<ads.length;i++) {
    if (ads[i].b === current_tick) {
      ad_load(ads[i], null);
      currently_busy = true;
    }
    if (ads[i].b > current_tick &&
        (next_tick_with_action === null || ads[i].b < next_tick_with_action)) {
      next_tick_with_action = ads[i].b;
    }
    if (final_tick === null ||
        final_tick < ads[i].b + ads[i].t) {
      final_tick = ads[i].b + ads[i].t;
    }
  }
  if (current_tick === final_tick || final_tick === null || current_ad_chain.length < 1) {
    track_throttled("adtimelineend", {"total_ticks": total_ticks});
    ad_spots_remaining--;
    ads_finish(false, true);
    return;
  }
  if (!currently_busy) {
    for (var i=0;i<ad_players.length;i++) {
      if (ad_players[i].busy) {
        currently_busy = true;
        break;
      }
    }
  }
  var next_tick = current_tick + 1;
  if (!currently_busy) {
    if (next_tick_with_action !== null) {
      next_tick = next_tick_with_action;
    } else {
      track_throttled("adtimelineend", {"total_ticks": total_ticks});
      ad_spots_remaining--;
      ads_finish(false, true);
      return;
    }
  }
  simultaneous_ad_loader_timeout = window.setTimeout(function () {simultaneous_ad_loader_timeout = null;ads_simultaneous_loader(ads, next_tick, total_ticks + 1);}, 1000);
}

function ad_load(ad, should_skip_chaining) {
  if (!ad || ad_playing_mutex) return;
  var attempt_count = 0;

  var attempt_function = function() {
    attempt_count++;
    var available_players = ads_getplayersbytagid(ad.id);
    if (master_pause) return;
    if (ad_playing_break_type !== "midroll" && !content_player.isPaused()) return; // Threading issue: Sometimes this is called after the content_player starts playing back.
    if (ad_spots_remaining === 0) return; // Fires if the user clicks a playlist item.

    if (!adprovider_canplay(ad)) {
      track_throttled("skipad", {"adtag_id": ad.id});
      ads_after();
      return;
    }

    var ad_player = null;
    for (var i=0;i<available_players.length;i++) {
      if (ad_players[available_players[i]].isPrefetching) {
        ad_players[available_players[i]].isPrefetching = false;
        if (ad_players[available_players[i]].adLoaded) {
          ad_players[available_players[i]].startAd();
        }
        return;
      }
      if (ad_players[available_players[i]].notag) {
        track_throttled("skipad", {"adtag_id": ad.id});
        ads_after();
        return;
      }
      if (ad_players[available_players[i]].failed) {
        ad_player.reload();
        continue;
      }
      if (ad_players[available_players[i]].ready && !ad_players[available_players[i]].busy) {
        ad_player = ad_players[available_players[i]];
        break;
      }
    }
    if (ad_player === null && attempt_count > 10) { // Gives up to 10 attempts before stopping
      ads_after();
      return;
    } else if (ad_player === null || !ad_player.ready) {
      retry_timeouts.push(window.setTimeout(attempt_function, 1000)); // poll until the ad player is ready
      return;
    }
    state_set("attempt-" + ad.id);
    track_throttled("attempt", {"adtag_id": ad.id});
    ad_player.loadAd(false, playlist[current_playlist_item], should_skip_chaining ? cfg.firstadloadtimer_maxsecs : ad.t, cfg.adplaytimer_maxsecs);
  };
  window.setTimeout(attempt_function, 1);
  return;
}

function ads_getplayersbytagid(tag) {
  var matches = [];
  for (var i=0;i<ad_players.length;i++) {
    if (ad_players[i].id === tag) matches.push(i);
  }
  return matches;
}

function ads_resetall(keep, caller) {
  debug_report("ads_resetall: " + caller);
  while (retry_timeouts.length) {
    window.clearTimeout(retry_timeouts.pop());
  }
  if (ads_start_timeout !== null) {
    window.clearTimeout(ads_start_timeout);
    ads_start_timeout = null;
  }
  if (ads_start_retry_timeout !== null) {
    window.clearTimeout(ads_start_retry_timeout);
    ads_start_retry_timeout = null;
  }
  if (simultaneous_ad_loader_timeout !== null) {
    window.clearTimeout(simultaneous_ad_loader_timeout);
    simultaneous_ad_loader_timeout = null;
  }
  for (var i=0;i<ad_players.length;i++) {
    if (ad_players[i] === keep) continue;
    if (ad_players[i].busy) {
      ad_players[i].stopAd();
      track_throttled("adreload", {"adtag_id": ad_players[i].id, "caller": caller});
    } else {
      ad_players[i].hide();
    }
  }
}

function ads_after() {
  debug_report("ads_after");
  if (cfg.ad_scheduling === "sequential") {
    skip_chaining = false;
    if (current_ad_chain.length > 0) {
      ad_load(current_ad_chain.shift(), skip_chaining);
      return;
    }
  } else if (cfg.ad_scheduling === "simultaneous" && current_ad_chain.length > 0) {
    current_ad_chain.shift(); // we don't care which one, we only use it to manage the count
    return;
  }
  if (current_ad_chain.length > 0) return;
  ad_spots_remaining--;
  ads_finish(false, true);
}

function ads_finish(had_impression, allow_background) {
  debug_report("ads_finish");
  if (!had_impression && staticfallback_show(allow_background)) return;

  ads_resetall(null, "ads_finish");
  background_ad = false;
  ad_loading_mutex = false;
  ad_playing_mutex = false;
  current_ad_chain = [];
  if (ad_playing_break_type === 'midroll') {
    adbreak_timer_install();
    ad_spots_remaining = 0;
    ad_playing_break_type = null;
  } else if (cfg.background_ads
             && !stop_after_mode
             && allow_background
             && !user_interacted
             && ad_spots_remaining < 1
             && (
                  (!cfg.background_only_viewable && (apunit_hasoldfocus() === false || apunit_isinviewport(0) === false))
                  || (cfg.background_only_viewable && apunit_hasoldfocus() === false && apunit_hasfocus() && apunit_isinviewport(0.5))
                )
             ) {
    background_ad = true;
    ad_spots_remaining++;
  }
  total_ad_slots_attempted++;
  if (ad_spots_remaining > 0) {
    ads_start();
    return;
  }
  apunit_resumeitem(current_playlist_item);
}

function adprovider_canplay(provider) {
  var can_play = (!provider['if'] || apunit_hasfocus())  // NOTE: IE8 parse error accessing property named "if" via dot: "provider.if"
              && (!provider['iv'] || apunit_isinviewport(0.5))
              && (!provider['of'] || apunit_hasoldfocus())
              && (!provider['av'] || apunit_isaceviewable(0.5))
              && (!provider.id.match(/flash/) || (can_load_flash && flash_autoplay))
              && (!provider.id.match(/^(?:google_adex_|adx_)/) || !pii_detected);
  if (can_play || ((!background_ad || cfg.background_run_restricts) && Math.random() * 100 < provider.c)) {
    return true;
  }
  return false;
}

function content_start(e) {
  window.setTimeout(function() {content_player.setControls(true)}, 0);
  master_pause = false;
  adbreak_timer_install();
  content_player.show();
  loadingcover_hide();
  adloadsplash_hide();
  staticad_hide();
  nowplaying_show();
  if (!content_player.isPaused()) {
    nowplaying_setpause(false);
  }
  if (cfg.seen_at_end && playlist[current_playlist_item].id) {
    var cookie = cookie_get("synapms");
    var seen_arr = cookie ? cookie.split(/,/) : [];
    var found = false;
    for (var i=0;i<seen_arr.length;i++) {
      if (playlist[current_playlist_item].id === seen_arr[i]) {
        found = true;
        break;
      }
    }
    if (!found) {
      cookie_set("synapms", (cookie ? cookie + "," : "") + playlist[current_playlist_item].id, 120);
    }
  }
}

function content_pause(e) {
  adbreak_timer_resetall_if_fired();
  adbreak_timer_remove();
  nowplaying_setpause(true);
  master_pause = true;
}

function content_after(e) {
  debug_report("content_after");
  if (browser_class === "safari") {
    content_player.setControls(false);
  }
  master_pause = false;
  current_playlist_item++;
  ad_spots_remaining = Math.max(0, ad_spots_remaining) + playlist[mod(current_playlist_item, playlist.length)].pre_ads;
  debug_report("ad_spots_remaining: " + ad_spots_remaining);
  if (ad_loading_mutex && ad_spots_remaining > 0) ad_spots_remaining--; // We're playing midroll, don't double-up ads.
  if (current_playlist_item >= playlist.length) {
    current_playlist_item = 0;
  }
  if ((current_playlist_item === 0 && !cfg.loop_mode) || stop_after_mode) {
    if (stop_after_mode) stop_after_mode = false;
    loadingcover_hide();
    adloadsplash_hide();
    if (cfg.after_stopping === "static") {
      staticad_show();
    } else {
      staticad_hide();
    }
    nowplaying_show();
    content_player.setControls(true);
    window.setTimeout(function() { // set as a timeout because we're executing in the onComplete handler now and will get cleaned up after this function ends. TODO: handle this better.
      content_player.addEventHandler("onComplete", function(e) {
        ad_playing_break_type = 'playlist';
        ads_start();
      }, {fireOnce: true});
    }, 2000);
    return;
  }
  ads_start();
}

function loadingcover_show() {
  var loading_cover = document.getElementById("loadingCover");
  if (!loading_cover) {
    loading_cover = document.createElement("div");
    loading_cover.id = "loadingCover";
    var loading_text = document.createElement("h1");
    loading_text.appendChild(document.createTextNode(string_get("LOADING").toUpperCase() + "\u2026"));
    loading_cover.appendChild(loading_text);
    document.getElementById("playerContainer").appendChild(loading_cover);
  }
}

function loadingcover_hide() {
  var loading_cover = document.getElementById("loadingCover");
  if (loading_cover) loading_cover.parentNode.removeChild(loading_cover);
}

function impressioncolor_set(colors) {
  document.getElementById("adColorLeft").style.display = "block";
  document.getElementById("adColorLeft").style.backgroundColor = colors[0] ? "#" + colors[0] : "black";
  document.getElementById("adColorRight").style.display = "block";
  document.getElementById("adColorRight").style.backgroundColor = colors[1] ? "#" + colors[1] : "black";
}
function nowplaying_container_create() {
  if (document.getElementById("nowPlayingContainer")) return;
  var nowplaying_container = document.createElement("div");
  nowplaying_container.style.width = (container_clientWidth() - 72) + "px";
  nowplaying_container.id = "nowPlayingContainer";

  var ad_color_left = document.createElement("div");
  ad_color_left.className = "adColor";
  ad_color_left.id = "adColorLeft";
  nowplaying_container.appendChild(ad_color_left);

  var ad_color_right = document.createElement("div");
  ad_color_right.className = "adColor";
  ad_color_right.id = "adColorRight";
  nowplaying_container.appendChild(ad_color_right);

  if ("border_color" in cfg && cfg.border_color !== null && cfg.border_color !== "none") {
    ad_color_left.style.left = ad_color_right.style.right = "1px";
  }

  var background = document.createElement("div");
  background.id = "nowPlayingBackground";
  nowplaying_container.appendChild(background);

  var player_container = document.getElementById("playerContainer");
  player_container.appendChild(nowplaying_container);
}

function nowplaying_show() {
  if (!cfg.show_nowplaying) return;

  nowplaying_hide();

  if (document.getElementById("nowPlayingDiv")) {
    document.getElementById("nowPlayingDiv").parentNode.removeChild(document.getElementById("nowPlayingDiv"));
  }
  if (document.getElementById("upNextDiv")) {
    document.getElementById("upNextDiv").parentNode.removeChild(document.getElementById("upNextDiv"));
  }

  var container = document.getElementById("nowPlayingContainer");

  var nowplaying = document.createElement("div");
  nowplaying.id = "nowPlayingDiv";

  var controls = document.createElement("div");
  controls.id = "nowPlayingControls";

  var is_ad = has_started && ad_spots_remaining > 0;

  if (!is_ad) {
    document.getElementById("adColorLeft").style.display = "none";
    document.getElementById("adColorRight").style.display = "none";

    if (cfg.show_navbuttons) {
      var prev = document.createElement("a");
      prev.id = "prevVideo";
      prev.className = "icon iconPrevious";
      prev.onclick = function() {
        skip_ad = true;
        apunit_playitem(current_playlist_item - 1, true);
        user_interaction_event();
        track_always("back");
      }
      controls.appendChild(prev);

      var counter = document.createElement("span");
      counter.className = "counter";
      counter.appendChild(document.createTextNode((current_playlist_item + 1) + " " + string_get("XOFY") + " " + playlist.length));
      controls.appendChild(counter);

      var next = document.createElement("a");
      next.id = "nextVideo";
      next.className = "icon iconNext";
      next.onclick = function() {
        skip_ad = true;
        apunit_playitem(current_playlist_item + 1, true);
        user_interaction_event();
        track_always("fwd");
      }
      controls.appendChild(next);
    }
    var pause = document.createElement("a");
    pause.id = "pauseVideo";
    pause.className = "icon icon" + (content_player.isPaused() ? "Play" : "Pause");
    pause.onclick = function() {
      var is_paused = content_player.isPaused();
      pause.className = "icon icon" + (!is_paused ? "Play" : "Pause");
      user_interaction_event();
      content_player.pause(!is_paused);
      track_always("pause", {"event_state": is_paused ? "play" : "pause"});
    };
    controls.appendChild(pause);
  }

  var unmute = document.createElement("a");
  unmute.id = "unmuteVideo";
  unmute.className = "icon icon" + (apunit_ismuted() ? "Mute" : "Unmute");
  unmute.onclick = function() {
    var is_muted = apunit_ismuted();
    unmute.className = "icon icon" + (is_muted ? "Mute" : "Unmute");
    user_interaction_event();
    apunit_setmute(!is_muted);
    track_always("mutebtn", {"event_state": is_muted ? "unmute" : "mute"});
  };
  controls.appendChild(unmute);

  if (!is_ad) {
    if (cfg.dcc_bitrate === "maintain") {
      var hd = document.createElement("a");
      hd.className = "icon iconHD" + (content_player.isHd ? " active" : "");
      hd.onclick = function() {
        content_player.toggleHd();
        content_player.setBitrate(apunit_getidealbitrate());
        hd.className = "icon iconHD" + (content_player.isHd ? " active" : "");
        user_interaction_event();
        track_always("hd", {"event_state": content_player.isHd ? "on" : "off"});
      };
      controls.appendChild(hd);
    }
  }
  nowplaying.appendChild(controls);

  var title = document.createElement("h1");
  title.appendChild(document.createTextNode(is_ad ? (cfg.ad_text ? string_get("ADVERTISEMENT").toUpperCase() : ad_playing_break_type === 'midroll' ? string_get("SHORTLY").toUpperCase() : string_get("NEXT").toUpperCase()) : string_get("NOWPLAYING").toUpperCase()));
  nowplaying.appendChild(title);

  if (!cfg.ad_text) {
    var asset = document.createElement("span");
    asset.className = "title";
    asset.appendChild(document.createTextNode(playlist[current_playlist_item].title));
    nowplaying.appendChild(asset);
  }

  container.appendChild(nowplaying);

  var upnext = document.createElement("div");
  upnext.id = "upNextDiv";

  var upnexttitle = document.createElement("h1");
  upnexttitle.appendChild(document.createTextNode("NEXT"));
  upnext.appendChild(upnexttitle);

  var next_item = current_playlist_item+1;
  if (next_item >= playlist.length) {
    next_item = cfg.loop_mode ? 0 : null;
  }
  if (next_item !== null) {
    var upnextdesc = document.createElement("span");
    upnextdesc.className = "title";
    upnextdesc.appendChild(document.createTextNode(playlist[next_item].title));
    upnext.appendChild(upnextdesc);
  }

  container.appendChild(upnext);
  nowplaying_resize();
  container.style.visibility = 'visible';
  window.setTimeout(nowplaying_resize, 1); // have to do this again so getBoundingClientRect() calculates properly
}

function nowplaying_hide() {
  if (!cfg.show_nowplaying) return;
  var container = document.getElementById("nowPlayingContainer");
  if (container) container.style.visibility = 'hidden';
}

function nowplaying_resize() {
  if (!cfg.show_nowplaying) return;
  var nowplaying = document.getElementById("nowPlayingContainer");
  var upnext = document.getElementById("upNextDiv");

  var nowplaying_background = document.getElementById("nowPlayingBackground");
  if (nowplaying && nowplaying_background) {
    var window_height = container_clientHeight();
    var window_width = container_clientWidth();
    var new_height = window_height - (ad_playing_mutex ? container_clientHeight() : content_player.getHeight());
    new_height = Math.max(29, new_height) + 1;
    if (new_height > 30) {
      nowplaying.style.width = container_clientWidth() + "px";
      if (!nowplaying.className.match(/(?:^| )expanded(?= |$)/)) nowplaying.className += (nowplaying.className.length ? " " : "") + "expanded";
    } else {
      nowplaying.style.width = container_clientWidth() + "px";
      nowplaying.className = nowplaying.className.replace(/(?:^| )expanded(?= |$)/, '');
    }
    if (window_width / window_height >= 1.22) {
      if (!nowplaying.className.match(/(?:^| )compact(?= |$)/)) nowplaying.className += (nowplaying.className.length ? " " : "") + "compact";
    } else {
      nowplaying.className = nowplaying.className.replace(/(?:^| )compact(?= |$)/, '');
    }

    if (upnext && upnext.getBoundingClientRect && upnext.getBoundingClientRect().bottom > container_clientHeight()) {
      upnext.style.visibility = "hidden";
    } else if (upnext && upnext.getBoundingClientRect && upnext.getBoundingClientRect().bottom) {
      upnext.style.visibility = "visible";
    }

    nowplaying.style.height = nowplaying_background.style.height = new_height + "px";
    nowplaying.style.top = (window_height - new_height) + "px";
  }
}

function nowplaying_setpause(isPaused) {
  if (!cfg.show_nowplaying) return;
  var pause_control = document.getElementById("pauseVideo");
  if (pause_control) pause_control.className = "control icon icon" + (isPaused ? "Play" : "Pause");
}

function staticfallback_show(allow_background) {
  debug_report("staticfallback_show");
  if (staticfallback_player === null) return false;
  if (cfg.static_fallback_slots && cfg.static_fallback_slots > 0 && total_ad_slots_attempted % cfg.static_fallback_slots !== 0) return false;
  loadingcover_show();
  staticfallback_player.setUp(document.getElementById("playerContainer"));
  staticfallback_player.show();
  adloadsplash_hide();
  staticad_hide();
  nowplaying_show();
  window.setTimeout(function () {
    staticfallback_player.hide();
    staticfallback_player.tearDown();
    loadingcover_hide();
    ads_finish(true, allow_background);
  }, Math.max(1, cfg.static_fallback_secs) * 1000);
  return true;
}

function staticad_create() {
  debug_report("staticad_create");
  if (!cfg.static_ad_tag) return;
  if (staticad_player !== null) staticad_destroy();
  staticad_player = new StaticAdFrame(container_clientWidth(), container_clientHeight());
  staticad_player.setContent(cfg.static_ad_tag);
  staticad_player.setUp(document.getElementById("playerContainer"));

  var staticAdModal = document.getElementById("staticAdModal");
  if (!staticAdModal && container_clientWidth() > 300 && container_clientHeight() > 250) {
    staticAdModal = document.createElement("div");
    staticAdModal.id = "staticAdModal";
    var staticAdLoading = document.createElement("h1");
    staticAdLoading.appendChild(document.createTextNode(string_get("LOADING").toUpperCase() + "\u2026"));
    staticAdModal.appendChild(staticAdLoading);
    var container = document.getElementById("playerContainer");
    if (container) {
      staticAdModal.style.width = container.style.width;
      staticAdModal.style.height = container.style.height;
    }
    document.body.appendChild(staticAdModal);
  }
  staticad_refresh();
}

function staticad_destroy() {
  debug_report("staticad_destroy");
  if (staticad_refresh_timeout !== null) window.clearTimeout(staticad_refresh_timeout);
  if (staticad_player !== null) {
    staticad_player.tearDown();
    staticad_player = null;
  }
  var staticAdModal = document.getElementById("staticAdModal");
  if (staticAdModal) staticAdModal.parentNode.removeChild(staticAdModal);
}

function staticad_show() {
  debug_report("staticad_show");
  if (!cfg.static_ad_tag) return;
  if (!cfg.static_ad_in_dcc && dcc_mode) return;
  if (!show_static_ad) return;
  if (disable_ads) return;
  if (staticad_player === null) staticad_create();
  staticad_player.show();
  var staticAdModal = document.getElementById("staticAdModal");
  if (staticAdModal) staticAdModal.style.visibility = "visible";
}

function staticad_hide() {
  debug_report("staticad_hide");
  if (staticad_player !== null) {
    staticad_player.hide();
  }
  var staticAdModal = document.getElementById("staticAdModal");
  if (staticAdModal) staticAdModal.style.visibility = "hidden";
}

function staticad_refresh() {
  debug_report("staticad_refresh");
  if (staticad_player === null) return;
  if (staticad_refresh_timeout !== null) window.clearTimeout(staticad_refresh_timeout);
  if ((!cfg.static_ad_visible_secs || staticad_player.getVisibleTime() >= cfg.static_ad_visible_secs * 1000) &&
      (!cfg.static_ad_rotation_secs || staticad_player.getRotationTime() >= cfg.static_ad_rotation_secs * 1000)) {
    staticad_player.reload();
  }
  var next_check = Math.max(1000, (cfg.static_ad_visible_secs || 1) * 1000 - staticad_player.getVisibleTime(), (cfg.static_ad_rotation_secs || 1) * 1000 - staticad_player.getRotationTime());
  staticad_refresh_timeout = window.setTimeout(staticad_refresh, next_check);
}

function adloadsplash_show() {
  if (cfg.adload_splash == "comingup" || cfg.show_comingup) {
    comingup_show();
  } else if (cfg.adload_splash == "assetpreview") {
    assetpreview_show();
  }
}

function adloadsplash_hide() {
  if (cfg.adload_splash == "comingup" || cfg.show_comingup) {
   comingup_hide();
  } else if (cfg.adload_splash == "assetpreview") {
    assetpreview_hide();
  }
}

function comingup_show() {
  debug_report("comingup_show");
  if (document.getElementById("comingUpPlaylist")) return;

  var comingupDiv = document.createElement("div");
  comingupDiv.id = "comingUpPlaylist";

  var title = document.createElement("h1");
  title.appendChild(document.createTextNode(string_get("COMINGUP").toUpperCase()));
  comingupDiv.appendChild(title);

  // How many items to show in the playlist
  var show_comingup_items = 8;
  if (typeof p_item !== "number" || p_item < 0) p_item = 0;

  for (var i=0; i<show_comingup_items; i++) {
    // This is in case we want to show the previous items, increment this variable
    var show_previous = 0;
    var playlist_item = (i + current_playlist_item - show_previous) % playlist.length;

    if ((!cfg.loop_mode || playlist.length < show_comingup_items) && (i + current_playlist_item - show_previous) / playlist.length >= 1) {
      break;
    }

    if (playlist_item < 0) {
      if (cfg.loop_mode && playlist.length >= show_comingup_items) {
        playlist_item %= playlist.length;
      } else {
        continue;
      }
    }

    var asset = document.createElement("h3");
    asset.className = "thumbnails";
    var thumbnail = document.createElement("img");
    thumbnail.src = playlist[playlist_item].thumbnail;
    thumbnail.alt = "";
    thumbnail.className = "comingupThumbnail";
    var thumbnail_playicon = document.createElement("div");
    thumbnail_playicon.className = "comingupThumbnailPlayIcon";
    thumbnail_playicon.appendChild(document.createTextNode("\u27A2"));
    var thumbnail_center = document.createElement("div");
    thumbnail_center.className = "comingupThumbnailCenter";
    thumbnail_center.appendChild(thumbnail);
    thumbnail_center.appendChild(thumbnail_playicon);
    var thumbnail_container = document.createElement("div");
    thumbnail_container.className = "comingupThumbnailContainer";
    thumbnail_container.appendChild(thumbnail_center);
    asset.appendChild(thumbnail_container);

    var asset_title = document.createElement("span");
    asset_title.appendChild(document.createTextNode(playlist[playlist_item].title));
    asset.appendChild(asset_title);
    if (playlist_item === current_playlist_item) {
      asset.className += (asset.className === "" ? "" : " ") + "active";
    }

    var asset_anchor = document.createElement("a");
    asset_anchor.style.cursor = "pointer";
    asset_anchor.onclick = function () {
      var active_element = 0;
      var elements = document.getElementById("comingUpPlaylist").getElementsByTagName("a");
      for (var j=0; j<elements.length; j++) {
        if (elements[j] === this) active_element = j;
      }
      loadingcover_show();
      adloadsplash_hide();
      apunit_playitem(active_element + current_playlist_item, true);
      user_interaction_event();
      track_always("comingup", {"event_state": active_element});
    };
    asset_anchor.appendChild(asset);
    comingupDiv.appendChild(asset_anchor);
  }

  var gradientDiv = document.createElement("div");
  gradientDiv.id = "comingupGradient";
  comingupDiv.appendChild(gradientDiv);

  var container = document.getElementById("playerContainer");
  container.appendChild(comingupDiv);
}

function comingup_hide() {
  debug_report("comingup_hide");
  var comingupDiv = document.getElementById("comingUpPlaylist");
  if (comingupDiv) comingupDiv.parentNode.removeChild(comingupDiv);
}

function assetpreview_show() {
  debug_report("assetpreview_show");
  if (document.getElementById("assetPreview")) return;

  var assetPreviewDiv = document.createElement("div");
  assetPreviewDiv.id = "assetPreview";
  assetPreviewDiv.style.backgroundImage = "url(" + playlist[current_playlist_item].thumbnail + ")";

  var assetPreviewDimmer = document.createElement("div");
  assetPreviewDimmer.className = "dimmer";

  var assetPreviewText = document.createElement("div");
  assetPreviewText.className = "assetPreviewText";

  var header = document.createElement("h1");
  header.appendChild(document.createTextNode(string_get("COMING UP").toUpperCase()));
  assetPreviewText.appendChild(header);

  var assetTitle = document.createElement("h2");
  assetTitle.appendChild(document.createTextNode(playlist[current_playlist_item].title));
  assetPreviewText.appendChild(assetTitle);

  var watchNowIcon = document.createElement("span");
  watchNowIcon.className = "watchNowIcon";
  watchNowIcon.appendChild(document.createTextNode("\u27A2"));

  var watchNowAnchor = document.createElement("a");
  watchNowAnchor.style.cursor = "pointer";
  watchNowAnchor.onclick = function () {
    loadingcover_show();
    adloadsplash_hide();
    apunit_playitem(current_playlist_item, true);
    user_interaction_event();
    track_always("watchnow");
  };

  watchNowAnchor.appendChild(watchNowIcon);
  watchNowAnchor.appendChild(document.createTextNode(string_get("WATCHNOW")));

  var watchNow = document.createElement("h3");
  watchNow.appendChild(watchNowAnchor);

  assetPreviewText.appendChild(watchNow);
  assetPreviewDimmer.appendChild(assetPreviewText);
  assetPreviewDiv.appendChild(assetPreviewDimmer);
  document.getElementById("playerContainer").appendChild(assetPreviewDiv);
}

function assetpreview_hide() {
  debug_report("assetpreview_hide");
  var assetPreviewDiv = document.getElementById("assetPreview");
  if (assetPreviewDiv) assetPreviewDiv.parentNode.removeChild(assetPreviewDiv);
}

function playlist_build() {
  var playlists_remaining_in_tail = 0;
  for (var vamid in cfg.playlists) {

    var seen_obj = {};
    if (cfg.seen_at_end && cookie_get("synapms")) {
      var seen_arr = cookie_get("synapms").split(/,/);
      for (var i=0;i<seen_arr.length;i++) {
        seen_obj[seen_arr[i]] = true;
      }
      var playlist_unseen = [];
      var playlist_seen = [];
      for (var i=0;i<cfg.playlists[vamid].length;i++) {
        if (cfg.playlists[vamid][i].id && seen_obj[cfg.playlists[vamid][i].id]) {
          playlist_seen.push(cfg.playlists[vamid][i]);
        } else {
          playlist_unseen.push(cfg.playlists[vamid][i]);
        }
      }
      if (playlist_unseen.length > 0) playlist_order[cfg.order_mode](playlist_unseen);
      if (playlist_seen.length > 0)   playlist_order[cfg.order_mode](playlist_seen);
      cfg.playlists[vamid] = playlist_unseen;
      for (var i=0;i<playlist_seen.length;i++) {
        cfg.playlists[vamid].push(playlist_seen[i]);
      }
    } else {
      playlist_order[cfg.order_mode](cfg.playlists[vamid]);
    }

    for (var i=cfg.playlists[vamid].length-1; i>=0; i--) {
      for (var j=cfg.playlists[vamid][i].media.length-1; j>=0; j--) {
        if (cfg.restricted_content[vamid] && cfg.restricted_content[vamid][cfg.playlists[vamid][i].id]) continue;
        if (cfg.playlists[vamid][i].media[j].file.match(streamurl_strip_prefix) === null ||
            cfg.playlists[vamid][i].media[j].file.match(streamurl_strip_suffix) === null) {
          // this isn't a recognized url format and we won't be able to make it canonical. remove it from the list.
          cfg.playlists[vamid][i].media.splice(j, 1);
        }

        var canonical_stream_url = cfg.playlists[vamid][i].media[j].file.replace(streamurl_strip_prefix, "").replace(streamurl_strip_suffix, "");
        delete cfg.playlists[vamid][i].media[j].file;

        var stream_url = streamurl_build[cfg.streamsource](canonical_stream_url);
        var backup_stream_url = streamurl_build['edgecast_mp4'](canonical_stream_url);
        cfg.playlists[vamid][i].media[j].sources = [
          {"file": stream_url},
          {"file": backup_stream_url}
        ];
      }
      if (cfg.playlists[vamid][i].media.length < 1) {
        cfg.playlists[vamid].splice(i, 1);
        continue;
      }

      cfg.playlists[vamid][i].vamid = vamid;

      if (vamid in title_build) cfg.playlists[vamid][i].title = title_build[vamid](cfg.playlists[vamid][i].title);

      if (cfg.playlists[vamid][i].image && cfg.playlists[vamid][i].image.match(thumbnailurl_strip_prefix) !== null) {
        var canonical_thumbnail_url = cfg.playlists[vamid][i].image.replace(thumbnailurl_strip_prefix, "");
        var thumbnail_url = thumbnailurl_build[cfg.streamsource](canonical_thumbnail_url);
        cfg.playlists[vamid][i].thumbnail = thumbnail_url;
      }
    }
    if (cfg.playlists[vamid].length > 0 && playlist_spec_in_tail(vamid)) playlists_remaining_in_tail++;
  }

  playlist = [];

  var i=0;
  var remaining_ad_count = 0;
  while ((i<tail_start || playlists_remaining_in_tail > 0) && playlist_spec[i] && cfg.playlists[playlist_spec[i]]) {
    if (cfg.playlists[playlist_spec[i]].length > 0) {
      var asset = cfg.playlists[playlist_spec[i]].shift();
      asset.pre_ads = remaining_ad_count + pre_ads[i];
      playlist.push(asset);
      if (cfg.playlists[playlist_spec[i]].length === 0 && playlist_spec_in_tail(playlist_spec[i])) playlists_remaining_in_tail--;
    }
    remaining_ad_count = 0;
    if (++i >= playlist_spec.length) {
      if (pre_ads[i]) remaining_ad_count += pre_ads[i]; // handle ads at the end of the tail
      if (playlist_spec.length === tail_start) break; // No tail
      i = tail_start; // Yes tail, rewind to tail start
    }
  }
  if (cfg.seen_at_end && seen_obj ) {
    var clean_seen = []
    for (var i=0;i<playlist.length;i++) {
      if (playlist[i].id && seen_obj[playlist[i].id]) {
        clean_seen.push(playlist[i].id);
      }
    }
    if (clean_seen.length > 0) {
      cookie_set("synapms", clean_seen.join(","), 120);
    } else {
      cookie_set("synapms", "deleted", -1);
    }
  }
}

function playlist_spec_in_tail(spec) {
  for (var i=0; i<cfg.tail.length; i++) {
    if (cfg.tail[i] === spec) {
      return true;
    }
  }
  return false;
}

function playlist_reorder(first_item) {
  var new_playlist = [];
  var playlist_length = playlist.length;
  for (var i=0; i<playlist_length; i++) {
    new_playlist.push(playlist[(i+first_item) % playlist_length]);
  }
  playlist = new_playlist;
}

function mediafile_fetchbitrate(playlist_item, desired_bitrate) {
  var medias = playlist_item.media;
  for (var j = 0; j < medias.length; j++) {
    if (medias[j].bitrate < 1) medias[j].bitrate = bitrate_limit_kbps + 1;
  }
  medias.sort(function (a, b) { return a.bitrate - b.bitrate });
  var chosen_media;
  for (var j = 0; j < medias.length; j++) {
    chosen_media = medias[j];
    if (medias[j].bitrate >= desired_bitrate) {
      break;
    }
  }
  return chosen_media;
}

function user_interaction_event() {
  if (delay_timeout !== null) {
    window.clearTimeout(delay_timeout);
    delay_timeout = null;
  }
  if (!user_interacted) {
    try {
      var test_window = window;
      while (test_window) {
        if (test_window.Pandora && test_window.Pandora.pauseMusic) {
          test_window.Pandora.pauseMusic(true);
          break;
        }
        if (test_window === window.top) break;
        test_window = test_window.parent;
      }
    } catch (e) {}
    user_interacted = true;
    if (!cfg.explicit_unmute) apunit_setmute(false);
    if (!("adfree_interaction" in cfg) || cfg.adfree_interaction) {
      disable_ads = true;
      staticad_destroy();
      adbreak_timer_remove();
      // Kill any ad loading if nothing is yet playing.
      if (!ad_playing_mutex) {
        ads_resetall(null, "user_interaction_event");
        apunit_resumeitem(current_playlist_item);
      }
    }
  }
}

function apunit_resumeitem(i) {
  debug_report("apunit_resumeitem: " + i);
  if (!content_player.ready) return apunit_playitem(i, true);
  if (!content_player.isPaused()) return;
  if (current_playlist_item === loaded_playlist_item && content_player.ready) {
    var dur = content_player.getDuration();
    var pos = content_player.getPosition();
    if (pos > 0 && dur - pos > 3 && content_player.isPaused()) {
      content_player.pause(false);
      return;
    } else if (dur - pos < 3) {
      i++;
    }
  }
  apunit_playitem(i, true);
}

function apunit_playitem(i, autoPlay) {
  debug_report("apunit_playitem: " + i);
  i = mod(i, playlist.length);
  if (autoPlay) {
    ad_spots_remaining = 0;
    current_ad_chain = [];
    adbreak_timer_remove();
    ads_resetall(null, "apunit_playitem");
    ad_playing_mutex = ad_loading_mutex = false;
    ad_playing_break_type = null;
  }

  loaded_playlist_item = current_playlist_item = i;
  var attempt_function = function() {
    if (!content_player.ready) { // poll until player is ready
      window.setTimeout(attempt_function, 1000);
      return;
    }
    content_player.removeEventHandlers({perClip: true});
    content_player.addEventHandler("onPlay",     content_start, {perClip: true});
    content_player.addEventHandler("onPause",    content_pause, {perClip: true});
    content_player.addEventHandler("onComplete", content_after, {perClip: true});
    content_player.play(playlist[i], 0, apunit_getidealbitrate(), autoPlay);
    attempt_function = attempt_timeout = null;
  };
  attempt_timeout = window.setTimeout(attempt_function, 1);
}

function apunit_getidealbitrate(isHd) {
  if (saved_dcc_bitrate === null) saved_dcc_bitrate = content_player.currentBitrate;
  if (!content_player.isHd && cfg.replace_dcc && dcc_mode && cfg.dcc_bitrate !== "auto") {
    if (cfg.dcc_bitrate === "maintain") {
      return saved_dcc_bitrate;
    }
    return cfg.dcc_bitrate;
  }
  if (!cfg.resize_bitrate) return cfg.minimum_bitrate;

  var bitrate = bitrate_limit_kbps;
  var container_width = (content_player && content_player.width) || container_clientWidth();
  if (container_width <= 300) {
    bitrate = 100;
  } else if (container_width <= 480) {
    bitrate = 150;
  } else if (container_width <= 768) {
    bitrate = 200;
  }
  return Math.max(bitrate, cfg.minimum_bitrate);
}

function apunit_resize() {
  var container = document.getElementById("playerContainer");

  var width = (cfg.fill_window || dcc_mode) ? window_innerWidth(window)  : 300;
  var height = (cfg.fill_window || dcc_mode) ? window_innerHeight(window) : 250;

  if (width == 0 || height == 0) {
    width = Math.max(width, 300);
    height = Math.max(height, 250);
  }
  container.style.width  = width + "px";
  container.style.height = height + "px";

  flash_autoplay = !((browser_class === "edge" || browser_class === "chrome") &&
    // Dimensions are 398x298 or larger
    !(width >= 398 && height >= 298) &&
    // or aspect is 16:9 with less than 1% deviation and the total pixel count is 120000 or more (roughly 462x260 or larger at 16:9)
    !(width * height >= 120000 && Math.abs((width / height) - (16/9)) < 0.01));

  var staticAdModal = document.getElementById("staticAdModal");
  if (staticAdModal) {
    staticAdModal.style.width = container.style.width;
    staticAdModal.style.height = container.style.height;
  }

  for (var i=0;i<ad_players.length;i++) ad_players[i].resize(width, height);
  if (content_player && playlist[current_playlist_item]) {
    content_player.resize(width, cfg.show_nowplaying && playlist[current_playlist_item].aspect ? Math.min(Math.round(width / playlist[current_playlist_item].aspect), height) : height);
    content_player.setBitrate(apunit_getidealbitrate());
  }
  show_static_ad = !cfg.static_ad_size_match || (width <= 300 && height <= 250);
  if (staticad_player !== null) {
    if (!show_static_ad) {
      staticad_destroy();
    } else {
      staticad_player.resize(width, height);
    }
  }
  if (staticfallback_player !== null) {
    staticfallback_player.resize(width, height);
  }
  nowplaying_resize();
}

function apunit_setmute(is_muting) {
  if (is_muting) {
    if (webaudio_gain) webaudio_gain.gain.value = 0;
    content_player.mute(false);
    for (var i=0;i<ad_players.length;i++) {
      ad_players[i].mute(false);
    }
  } else {
    if (webaudio_gain) webaudio_gain.gain.value = 1;
    content_player.unmute(false);
    content_player.setControls(true);
    for (var i=0;i<ad_players.length;i++) {
      ad_players[i].unmute(false);
    }
    if (!unmute_logged) {
      unmute_logged = true;
      // if we've never unmuted before, log exactly once
      track_always("unmute"); //always, even with log throttle disabled otherwise
    }
  }
  var unmute_control = document.getElementById("unmuteVideo");
  if (unmute_control) unmute_control.className = "control icon icon" + (is_muting ? "Mute" : "Unmute");

}

function apunit_ismuted() {
  return content_player.isMuted();
}

function apunit_hasfocus() {
  // Page Visibility API
  var pageVisibilityProperty = null;
  if (typeof document.hidden !== "undefined") {
    pageVisibilityProperty = "hidden";
  } else if (typeof document.mozHidden !== "undefined") {
    pageVisibilityProperty = "mozHidden";
  } else if (typeof document.msHidden !== "undefined") {
    pageVisibilityProperty = "msHidden";
  } else if (typeof document.webkitHidden !== "undefined") {
    pageVisibilityProperty = "webkitHidden";
  }
  if (pageVisibilityProperty) return !document[pageVisibilityProperty];
  return apunit_hasoldfocus();
}

function apunit_hasoldfocus() {
  // Page Visibility API not supported
  var has_focus = false;
  try {
    window.top.document;
  } catch(e) {
    return window.document.hasFocus() || null;
  }
  iterate_selfandparents(window, function() {
    if (has_focus) return;
    if (this.document.hasFocus()) has_focus = true;
    for (var i=0;i<this.frames.length;i++) {
      try {
        if (this.frames[i].contentWindow.document.hasFocus()) {
          has_focus = true;
          break;
        }
      } catch(e) {}
    }
  });
  return has_focus;
}

function apunit_isinviewport(req_percent) {
  var frame_in_parent = null;
  var current_window = window;
  var visible_rect = {l: 0, t: 0, r: "innerWidth" in window ? window.innerWidth : window.document.documentElement.clientWidth, b: "innerHeight" in window ? window.innerHeight : window.document.documentElement.clientHeight};
  var visible_pixel_requirement = visible_rect.r * visible_rect.b * req_percent;

  var r, c;

  while (current_window !== window.top) {
    try {
      frame_in_parent = iframe_findfromwindow(current_window);
      if (frame_in_parent === null) return null;
      r = frame_in_parent.getBoundingClientRect();
      c = {
        w: "innerWidth" in current_window.parent ? current_window.parent.innerWidth : current_window.document.parent.documentElement.clientWidth,
        h: "innerHeight" in current_window.parent ? current_window.parent.innerHeight : current_window.document.parent.documentElement.clientHeight
      };
    } catch (e) {
      try {
        if (current_window &&
            current_window['$sf'] &&
            current_window['$sf'].ext &&
            current_window['$sf'].ext.inViewPercentage) {
          return current_window['$sf'].ext.inViewPercentage() >= req_percent;
        } else {
          return null;
        }
      } catch (e) {
        return null;
      }
    }
    visible_rect.l = Math.max(Math.min(visible_rect.l + r.left, c.w), 0);
    visible_rect.t = Math.max(Math.min(visible_rect.t + r.top, c.h), 0);
    visible_rect.r = Math.max(Math.min(visible_rect.r + r.left, c.w, r.right), 0);
    visible_rect.b = Math.max(Math.min(visible_rect.b + r.top, c.h, r.bottom), 0);

    var onscreen_pixels = (visible_rect.r-visible_rect.l) * (visible_rect.b-visible_rect.t);
    if (onscreen_pixels < visible_pixel_requirement) return false;

    current_window = current_window.parent;
  }
  return true
}

function apunit_isaceviewable(req_percent) {
  var frame_in_parent = null;
  var current_window = window;
  var visible_rect = {l: 0, t: 0, r: "innerWidth" in window ? window.innerWidth : window.document.documentElement.clientWidth, b: "innerHeight" in window ? window.innerHeight : window.document.documentElement.clientHeight};
  var visible_pixel_requirement = visible_rect.r * visible_rect.b * req_percent;

  var r, c;

  while (current_window !== window.top) {
    try {
      frame_in_parent = iframe_findfromwindow(current_window);
      if (frame_in_parent === null) return null;
      r = frame_in_parent.getBoundingClientRect();
      c = {
        w: "innerWidth" in current_window.parent ? current_window.parent.innerWidth : current_window.parent.document.documentElement.clientWidth,
        h: "innerHeight" in current_window.parent ? current_window.parent.innerHeight : current_window.parent.document.documentElement.clientHeight
      };
    } catch (e) {
      try {
        if (current_window &&
            current_window['$sf'] &&
            current_window['$sf'].ext &&
            current_window['$sf'].ext.inViewPercentage) {
          return current_window['$sf'].ext.inViewPercentage() >= req_percent;
        } else {
          return null;
        }
      } catch (e) {
        return null;
      }
    }
    visible_rect.l = Math.max(Math.min(visible_rect.l + r.left, c.w), 0);
    visible_rect.t = Math.max(Math.min(visible_rect.t + r.top, c.h), 0);
    visible_rect.r = Math.max(Math.min(visible_rect.r + r.left, c.w, r.right), 0);
    visible_rect.b = Math.max(Math.min(visible_rect.b + r.top, c.h, r.bottom), 0);

    var onscreen_pixels = (visible_rect.r-visible_rect.l) * (visible_rect.b-visible_rect.t);
    if (onscreen_pixels < visible_pixel_requirement) return false;
    var measurements_off_screen = 0;
    var max_measure_points = 500; // chosen arbitrarily
    var scan_tolerance = Math.max(1, Math.floor(Math.sqrt(onscreen_pixels/max_measure_points)));
    var measure_point = Math.floor(scan_tolerance/2); // measure from middle of square
    var inc_amount = Math.pow(scan_tolerance,2);
    for (var x=visible_rect.l,xm=x+measure_point; xm<visible_rect.r; x+=scan_tolerance,xm=x+measure_point) {
      for (var y=visible_rect.t,ym=y+measure_point; ym<visible_rect.b; y+=scan_tolerance,ym=y+measure_point) {
        if (current_window.parent.document.elementFromPoint(xm,ym) !== frame_in_parent) measurements_off_screen++;
      }
      if (1 - (measurements_off_screen / max_measure_points) < req_percent) return false;
    }
    current_window = current_window.parent;
  }
  return true;
}

function apunit_getcoordinates() {
  var frame_in_parent = null;
  var current_window = window;
  var rect = {l: 0, t: 0, r: "innerWidth" in window ? window.innerWidth : window.document.documentElement.clientWidth, b: "innerHeight" in window ? window.innerHeight : window.document.documentElement.clientHeight};

  var r, c;

  while (current_window !== current_window.top) {
    try {
      frame_in_parent = iframe_findfromwindow(current_window);
      if (frame_in_parent === null) return null;
      r = frame_in_parent.getBoundingClientRect();
      c = {
        w: "innerWidth" in current_window.parent ? current_window.parent.innerWidth : current_window.parent.document.documentElement.clientWidth,
        h: "innerHeight" in current_window.parent ? current_window.parent.innerHeight : current_window.parent.document.documentElement.clientHeight
      };
    } catch (e) {
      return null;
    }
    rect.l = Math.max(rect.l + r.left, 0);
    rect.t = Math.max(rect.t + r.top, 0);
    rect.r = Math.max(rect.r + r.left, 0);
    rect.b = Math.max(rect.b + r.top, 0);

    current_window = current_window.parent;
  }
  return rect;
}

function apunit_browserdimensions() {
  try {
    return {"w": window_innerWidth(window.top), "h": window_innerHeight(window.top)};
  } catch (e) {}
  return null;
}

function apunit_viewable_if_idle() {
  if (cfg.inactive_scroll_secs && parseInt(cfg.inactive_scroll_secs, 10) > 0
   && cfg.inactive_scroll_inview && parseInt(cfg.inactive_scroll_inview, 10) > 0) {
    var req_percent = Math.min(100, parseInt(cfg.inactive_scroll_inview, 10));
    var last_activity = timestamp();
    var was_code_scrolling = false;
    var track_activity = null, orig_scroll = null, current_scroll = null, inactivity_handler_interval = null, moving_timeout = null;
    var inactivity_handler = function () {

      // Check if idle
      if (timestamp() - last_activity < parseInt(cfg.inactive_scroll_secs, 10) * 1000) {
        if (moving_timeout !== null) {
          window.clearTimeout(moving_timeout);
          moving_timeout = null;
        }
        // We got activity, scroll back if we had scrolled.
        if (cfg.inactive_scroll_return && orig_scroll !== null) {
          window.top.scrollTo(orig_scroll.x, orig_scroll.y);
        }
        current_scroll = orig_scroll = null;
        return;
      }

      // We're actively scrolling
      if (current_scroll !== null) return;

      // If we're in viewport this code is irrelevant.
      if (apunit_isinviewport(req_percent / 100)) return;

      try {
        var url = window.top.location.href; // will security exception if x-domain
        var frame_in_parent = null;
        var current_window = window;
        do {
          frame_in_parent = iframe_findfromwindow(current_window);
          current_window = current_window.parent;
        } while (frame_in_parent !== null && current_window !== current_window.top);
        if (frame_in_parent !== null) {

          if (orig_scroll === null) orig_scroll = {"x": window.top.scrollX, "y": window.top.scrollY};
          if (current_scroll === null) current_scroll = {"x": window.top.scrollX, "y": window.top.scrollY};

          var move_till_visible = function () {
            moving_timeout = null;
            var location = frame_in_parent.getBoundingClientRect();

            var scroll_amounts = {
              "x1": location.left,
              "x2": location.right - window_innerWidth(window.top),
              "y1": location.top,
              "y2": location.bottom - window_innerHeight(window.top)
            };


            var scrollX_min = current_scroll.x <= window.top.scrollX ? scroll_amounts.x1 : scroll_amounts.x2,
                scrollY_min = current_scroll.y <= window.top.scrollY ? scroll_amounts.y1 : scroll_amounts.y2;

            var scrollX_inc = (scrollX_min < 0 ? -1 : 1) * Math.min(10, Math.abs(scrollX_min)),
                scrollY_inc = (scrollY_min < 0 ? -1 : 1) * Math.min(10, Math.abs(scrollY_min));

            if (!apunit_isaceviewable(req_percent / 100) && (scrollX_inc !== 0 || scrollY_inc !== 0)) {
              var prev_loc = {"x": window.top.scrollX, "y": window.top.scrollY};
              window.top.scrollBy(
                scrollX_inc,
                scrollY_inc
              );
              // Verify we actually scrolled somewhere before calling again to prevent loop from unscrollable ask.
              if (window.top.scrollX !== prev_loc.x || window.top.scrollY !== prev_loc.y) moving_timeout = window.setTimeout(move_till_visible, 10);
            } else {
              current_scroll = null;
            }
          }
          moving_timeout = window.setTimeout(move_till_visible, 10);  // waiting primarily to ensure DCC header changes.
        }
        track_activity = function() {
          last_activity = timestamp();
          inactivity_handler.call();
        }
        listener_attach(window.top, "mousemove", track_activity);//TODO: must remove on unload and closure-leak-proof
        listener_attach(window.top, "focus", track_activity);
        listener_attach(window.top, "visibilitychange", track_activity);
        listener_attach(window.top, "scroll", function () {
          if (moving_timeout === null) {
            orig_scroll = null;
            track_activity.call();
          }
        });
      } catch (e) {}
    };
    inactivity_handler_interval = window.setInterval(inactivity_handler, 1000);
  }
}

function masthead_height() {
  try {
    // gen4 vs gen2
    var masthead = window.top.document.getElementById("div-gpt-ad-masthead") || window.top.document.getElementById("div-gpt-ad-uppercut");
    return masthead.clientHeight;
  } catch (e) {}
  return null;
}

function clone_into_scope(to_clone, from_scope, dest_scope) {
  if (to_clone === null || typeof to_clone !== "object") return to_clone;
  if (to_clone.constructor === from_scope.String)   return new dest_scope.String(to_clone);
  if (to_clone.constructor === from_scope.Number)   return new dest_scope.Number(to_clone);
  if (to_clone.constructor === from_scope.Boolean)  return new dest_scope.Boolean(to_clone);
  if (to_clone.constructor === from_scope.Date)     return new dest_scope.Date(to_clone);
  if (to_clone.constructor === from_scope.RegExp)   return new dest_scope.RegExp(to_clone);
  if (to_clone.constructor === from_scope.Object) {
    var struct = new dest_scope.Object();
    for (var name in to_clone) struct[name] = clone_into_scope(to_clone[name], from_scope, dest_scope);
    return struct;
  }
  if (to_clone.constructor === from_scope.Array) {
    var arr = new dest_scope.Array();
    for (var i=0; i<to_clone.length; i++) arr[i] = clone_into_scope(to_clone[i], from_scope, dest_scope);
    return arr;
  }
  return to_clone;
}

function state_set(e) {
  debug_report("state_set - " + e);
  state = e;
  state_time = timestamp();
}

function tracking_fire(event) {
  var fired_pixels = {};
  var tags = [cfg.ad_tags, cfg.large_ad_tags];
  for (var j=0;j<tags.length;j++) {
    for (var i=tags[j].length - 1;i>=0;i--) {
      if (tags[j][i].tracking && tags[j][i].tracking[event] && !fired_pixels[tags[j][i].tracking[event]]) {
        track_pixel(tags[j][i].tracking[event]);
        fired_pixels[tags[j][i].tracking[event]] = true;
      }
    }
  }
}

function track_throttled(event,values) {
  if (debug) {
    if (console.group) {
      console.group("[" + (timestamp()/1000) + "] track_throttled - " + event);
      console.dir(values);
      console.groupEnd();
    } else {
      console.log("[" + (timestamp()/1000) + "] track_throttled - " + event);
      console.log(values);
    }
  }
  var is_full_log = values && values['adtag_id'] && values['adtag_id'].match(/^spotxchange_(.*_)?verizon$/);
  if (!should_adlog && !is_full_log) return;
  track(event, is_full_log ? 1 : cfg.logthrottle, values);
}

function track_always(event,values) {
  if (debug) {
    if (console.group) {
      console.group("[" + (timestamp()/1000) + "] track_always - " + event);
      console.dir(values);
      console.groupEnd();
    } else {
      console.log("[" + (timestamp()/1000) + "] track_always - " + event);
      console.log(values);
    }
  }
  track(event, 1, values);
}

function track(event,rate,values) {
  if (cfg.logurl === false) return;

  var url = (cfg.logurl || "//"+location.host+"/images/track/track.gif") + "?track=jwp-ad" +
    "&ts="     + encodeURIComponent(timestamp()) +
    "&rate="   + encodeURIComponent(rate) +
    "&event="  + encodeURIComponent(event) +
    "&iid="    + encodeURIComponent(instance_id) +
    "&origin=" + encodeURIComponent(origin) +
    "&size="   + encodeURIComponent(container_clientWidth() + "x" + container_clientHeight()) +
    "&sl="     + encodeURIComponent(should_adlog ? "1" : "0"); // so individual iid values that emit a certain track_always event and also have all the throttled events can easily be found.

    if (url.match(/^\/\//)) url = protocol_get() + url;

    var window_dimensions = apunit_browserdimensions();
    if (window_dimensions !== null) url += "&window=" + encodeURIComponent(window_dimensions.w + "x" + window_dimensions.h);

  if (event === "init" || event === "flash") {
    url += "&sfv="  + encodeURIComponent(flash_version);
  }
  if (event.match(/^(?:init|firstcontent|adslot|attempt|skipad|impression|unloadstate|dcc|vpaidinitad|vpaidstartad|vpaidadloaded|vpaidadstarted)$/)) {
    var mh = masthead_height();
    if (mh !== null) url += "&mh=" + encodeURIComponent(mh);
    var coords = apunit_getcoordinates();
    if (coords !== null) url += "&coords=" + encodeURIComponent(coords.l + "x" + coords.t);

    url += "&f="    + encodeURIComponent(apunit_hasfocus() ? "1" : "0");
    url += "&iv="   + encodeURIComponent(apunit_isinviewport(0.5) ? "1" : "0");
    url += "&of="    + encodeURIComponent(apunit_hasoldfocus() ? "1" : "0");
    if (log_aceview) url += "&av="    + encodeURIComponent(apunit_isaceviewable(0.5) ? "1" : "0");
  }
  if (event.match(/^(?:adslot|attempt|impression|aderror|adloadtime|adloadtimealarm|vpaidinitad|vpaidstartad|vpaidadloaded|vpaidadstarted)$/)) {
    url += "&ad_scheduling=" + encodeURIComponent(cfg.ad_scheduling);
    url += "&ba=" + encodeURIComponent(background_ad ? "1" : "0");
  }
  if (values) {
    for (value in values) {
      url += "&" + encodeURIComponent(value) + "=" + encodeURIComponent(values[value]);
    }
  }
  if ("4441804982" !== "%ea" + "id!") {
    url += "&dfp=4441804982;56494945772";
  }
  url += "&adunit=" + encodeURIComponent(dfp_adunit);

  track_pixel(url);
}

function track_pixel(url) {
  document.createElement("img").src = url.replace(/__page-url__/g, encodeURIComponent(origin))
                                         .replace(/__domain__/g, encodeURIComponent(domain))
                                         .replace(/__dfpcid__/g, encodeURIComponent('56494945772'.replace(/^[%]ecid!$/g, '')))
                                         .replace(/__dfpadunit__/g, encodeURIComponent(dfp_adunit))
                                         .replace(/__dfpclient__/g, encodeURIComponent(dfp_client))
                                         .replace(/__browser__/g, encodeURIComponent(browser_class))
                                         .replace(/__crossdomain__/g, is_in_crossdomain_frame ? "1" : "0")
                                         .replace(/__player-width__/g, encodeURIComponent(container_clientWidth()))
                                         .replace(/__player-height__/g, encodeURIComponent(container_clientHeight()))
                                         .replace(/__random-number__/g, encodeURIComponent(Math.random()));
}

function debug_report(message) {
  if (debug) console.log("[" + (timestamp()/1000) + "] " + message);
  if (debug && debug_stacktrace) {
    try {
      i.dont.exist+=0; //doesn't exist- that's the point
    } catch(e) {
      if (e.stack) {
        var callstack = [];
        var lines = e.stack.split('\n');
        for (var i=0,len=lines.length;i<len;i++) {
          var matches = lines[i].match(/^(.*?)@(.*):(\d+:\d+)$/);
          if (matches) callstack.push({method: matches[1], file: matches[2], location: matches[3]});
        }
        callstack.shift();
        console.log(callstack);
      }
    }
  }
}

function script_load(src, targetWindow) {
  if (!targetWindow) targetWindow = window;
  var new_script = targetWindow.document.createElement('script');
  new_script.src = src;
  new_script.type = 'text/javascript';
  new_script.async = true;
  targetWindow.document.body.appendChild(new_script);
}

function cookie_get(n){
  var m;
  return (
    m = (new RegExp("(?:^|\\;)\\s*" + n.replace(/(\W)/g,"\\$1") + "\\s*\\=\\s*([^\\;]+)")).exec(document.cookie)
  ) ? m[1] : null;
}

function cookie_set(n, v, d) {
  var expires = "";
  if (d) {
    var date = new Date();
    date.setTime(date.getTime()+(d*24*60*60*1000));
    expires = "; expires="+date.toGMTString();
  }
  document.cookie = n+"="+v+expires+"; path=/";
}

function apunit_forceunload() {
  while (unloaders && unloaders.length) {
    try {
      var one = unloaders.splice(0, 1);
      one[0].call(window, {});
    } catch(e) {console.log(e)}
  }
}

function string_get(token) {
  if (!(token in strings)) return "";
  if (language in strings[token]) return strings[token][language];
  for (var lang in strings[token]) {
    if (lang.replace(/\-.*$/, "") == language.replace(/\-.*$/)) return strings[token][lang];
  }
  return strings[token]["en-US"];
}

function color_from_int(int_in) {
  // Rebalancing the number by taking every bit 3 at a time to distribute across each RGB value.
  // This will cause lower overall values for each RGB value and result in darker colors.
  var binary = ("000000000000000000000000" + (int_in).toString(2)).slice(-24);
  var sections = ['','',''];
  for (var k=0;k<24;k++) {
    sections[mod(k,3)] += binary.charAt(k);
  }
  return ("00" + parseInt(sections[0], 2).toString(16)).slice(-2) +
         ("00" + parseInt(sections[1], 2).toString(16)).slice(-2) +
         ("00" + parseInt(sections[2], 2).toString(16)).slice(-2);
}

function listener_attach(element, event, method) {
  if (element === window && event === "unload") {
    unloaders.push(method);
  }
  if (element.addEventListener) {
    // For all major browsers, except IE 8 and earlier
    element.addEventListener(event, method);
  } else if (document.attachEvent) {
    // For IE 8 and earlier versions
    element.attachEvent("on" + event, method);
  }
}

function listener_remove(element, event, method) {
  if (element === window && event === "unload" && unloaders) {
    for (var i=unloaders.length-1;i>=0;i--) {
      if (unloaders[i] === method) unloaders.splice(i,1);
    }
  }
  if (element.removeEventListener) {
    // For all major browsers, except IE 8 and earlier
    element.removeEventListener(event, method);
  } else if (document.attachEvent) {
    // For IE 8 and earlier versions
    element.detachEvent("on" + event, method);
  }
}

function mod(a,b){ return ((a%b)+b)%b; }
function timestamp() { return (new Date()).getTime(); }

function container_clientWidth() { return (document.getElementById("playerContainer").clientWidth); }
function container_clientHeight() { return (document.getElementById("playerContainer").clientHeight); }

function window_innerWidth(w) { return ("innerWidth" in w ? w.innerWidth : w.document.documentElement.clientWidth); }
function window_innerHeight(w) { return ("innerHeight" in w ? w.innerHeight : w.document.documentElement.clientHeight); }

function version_compare(a, b) {
  if (typeof a === "string") a = a.match(/\d+/g);
  if (typeof b === "string") b = b.match(/\d+/g);
  if (!(a.length > 0 && b.length > 0)) return undefined;
  var n_a = parseInt(a.shift(), 10), n_b = parseInt(b.shift(), 10);
  if (n_a !== n_b) return n_a < n_b ? -1 : 1;
  if (a.length > 0 && b.length > 0) return version_compare(a,b);
  if (a.length == 0 && b.length == 0) return 0;
  return a.length == 0 ? -1 : 1;
}

function object_mergedeeply(dest, from) {
  for (var x in from) {
    if (!from.hasOwnProperty(x)) continue;
    if (x in dest && typeof dest[x] === "object" && typeof from[x] === "object") {
      object_mergedeeply(dest[x], from[x]);
    } else {
      dest[x] = from[x];
    }
  }
}

function dcc_install_replacement_handler() {
  if (dcc_handler_installed) return;
  if (dcc_handler_install_count > 10) {
    track_always("dccgaveup");
    return;
  }
  var rotations_until_move = null;
  var dcc_type = null;
  var dcc = null;
  var slides = null;
  var slideshow = null;
  var num_slides = 0;
  var viewed_slides = 1;
  var dcc_replace = null;
  var position_handler = null;
  var position_check_interval = null;
  var handlers_installed = false;
  var should_handle = true;
  var zindex = 799;
  var slideshow_methods = {};
  var fallback_timer = null;

  // replace DCC at 1 rotation minimum, or after 20 slides
  var max_slides = 20;

  try {
    // Try to access parent page and identify as Synacor-hosted page.
    if (!window.parent
      || window.parent === window.self
      || !window.parent.$
      || !window.parent.Syn
      || !window.parent.Syn.ComponentMgr) return;
  } catch (e) {
    return;
  }

  var $ = window.parent.$;

  var dcc_rotation_handler = function () {
    if (dcc_mode) return;
    if (++viewed_slides > Math.min(Math.max(num_slides, max_slides), num_slides * rotations_until_move)) {
      viewed_slides = 1;
      if (!handlers_installed) {
        $(window.parent).resize(position_handler);
        $(window.parent).scroll(position_handler);
        if (position_check_interval === null) position_check_interval = window.parent.setInterval(position_handler, 1000);
      }
      dcc_replace();
    }
  };


  // GEN4 v3 DCC
  if ((($('section.dcc.slick-slider').length && $('section.dcc.slick-slider').slick) ||
       ($('section.stream-carousel.slick-slider').length && $('section.stream-carousel.slick-slider').slick))
      && window.parent.Syn.ComponentMgr.getInstancesByClass
      && (window.parent.Syn.ComponentMgr.getInstancesByClass("Syn.Dcc").length ||
          window.parent.Syn.ComponentMgr.getInstancesByClass("Syn.StreamCarousel").length ||
          window.parent.Syn.ComponentMgr.getInstancesByClass("Syn.StreamSlide").length)) {
    dcc_type = 'gen4-Slick';
    rotations_until_move = cfg.dcc_rotations_gen4;
    dcc = $('section.dcc.slick-slider').length
        ? $('section.dcc.slick-slider')
        : $('section.stream-carousel.slick-slider');
    var dcc_instance = null;
    for (var id in window.parent.Syn.ComponentMgr.instancesByClass) {
      if (id.match(/^Syn\.(?:Dcc|StreamCarousel(?:\..*)?)$/) && window.parent.Syn.ComponentMgr.instancesByClass[id] && window.parent.Syn.ComponentMgr.instancesByClass[id].length) {
        dcc_instance = window.parent.Syn.ComponentMgr.instancesByClass[id][0];
        break;
      }
    }
    var dcc_tabs = $('section.dcc-tabs.slick-slider');
    num_slides = dcc.find('.dcc-slide').length - dcc.find('.dcc-slide.slick-cloned').length;
    var old_height = dcc.outerHeight(); // This DCC has a fixed height
    var old_parent_height = dcc.parent().outerHeight();
    slideshow_methods = {
      pause: function () {
        if (dcc_instance) {
          dcc_instance.pause();
        }
        dcc.find('button.slick-arrow').hide();
        dcc.find('.counter').hide();
        if (dcc_tabs.length) dcc_tabs.hide();
      },
      play: function () {
        dcc.find('button.slick-arrow').show();
        dcc.find('.counter').show();
        if (dcc_instance) {
          dcc_instance.unpause();
        }
        if (dcc_tabs.length) dcc_tabs.show();
      },
      add: function () {
        dcc.on('afterChange', dcc_rotation_handler);
      },
      remove: function () {
        dcc.off('afterChange', dcc_rotation_handler);
        dcc.outerHeight(old_height);
        dcc.parent().outerHeight(old_parent_height);
      }
    };
    zindex = 0;

  // GEN4 v2 DCC
  } else if ($('section.dcc.flickity-enabled').length
             && $('section.dcc.flickity-enabled').data('flickity')
             && window.parent.Syn.ComponentMgr.getInstancesByClass
             && window.parent.Syn.ComponentMgr.getInstancesByClass("Syn.Dcc").length) {
    dcc_type = 'gen4-Flickity';
    rotations_until_move = cfg.dcc_rotations_gen4;
    dcc = $('section.dcc.flickity-enabled');
    var dcc_instance =  window.parent.Syn.ComponentMgr.getInstancesByClass("Syn.Dcc")[0];
    var dcc_tabs = $('section.dcc-tabs.flickity-enabled');
    num_slides = dcc.find('.dcc-slide').length;
    var old_height = dcc.outerHeight(); // This DCC has a fixed height
    slideshow_methods = {
      pause: function () {
        dcc_instance.pause();
        dcc.find('button').hide();
        dcc.find('.counter').hide();
        if (dcc_tabs.length) dcc_tabs.hide();
      },
      play: function () {
        dcc.find('button').show();
        dcc.find('.counter').show();
        dcc_instance.unpause();
        if (dcc_tabs.length) dcc_tabs.show();
      },
      add: function () {
        dcc.data('flickity').on('cellSelect', dcc_rotation_handler);
      },
      remove: function () {
        dcc.outerHeight(old_height);
        dcc.data('flickity').off('cellSelect', dcc_rotation_handler);
      }
    };
    zindex = 999;

  // GEN4 v1 DCC
  } else if ($('section.dcc.carousel.slide').length) {
    dcc_type = 'gen4-Bootstrap';
    rotations_until_move = cfg.dcc_rotations_gen4;
    dcc = $('section.dcc.carousel.slide');
    num_slides = $('section.dcc.carousel.slide .item').length;
    slideshow_methods = {
      pause: function () {
        window.setTimeout(function () { dcc.carousel("pause"); }, 1); // pause cannot be called from same thread as the 'slide.bs.carousel' handler or it gets ignored.
        dcc.find('.carousel-control').hide();
      },
      play: function () {
        dcc.find('.carousel-control').show();
        dcc.carousel("cycle");
      },
      add: function () {
        dcc.on('slide.bs.carousel', dcc_rotation_handler);
      },
      remove: function () {
        dcc.off('slide.bs.carousel', dcc_rotation_handler);
      }
    };
    zindex = 999;

  // GEN2 DCC
  } else if ($('div.dcc.slideshow').length
             && window.parent.Syn.ComponentMgr.getInstanceByUid) {
    dcc_type = 'gen2-Syn.FwSlideshow';
    rotations_until_move = cfg.dcc_rotations_gen2;
    dcc = $('div.dcc.slideshow');
    var dcc_instance = window.parent.Syn.ComponentMgr.getInstanceByUid(dcc.attr('id'));
    num_slides = dcc_instance.num_slides;
    var old_method = dcc_instance.setActiveSlide;
    var old_height = dcc.height(); // This DCC has a fixed height
    var old_margin = {
      'top': dcc.css('margin-top'),
      'bottom': dcc.css('margin-bottom')
    };
    var old_border = {
      'top': dcc.css('border-bottom-top'),
      'bottom': dcc.css('border-bottom-width')
    };
    var rotation_handler_sub = function (activeSlide) {
      dcc_rotation_handler();
      return $.proxy(old_method, this)(activeSlide);
    };
    slideshow_methods = {
      pause: function () {
        dcc_instance.pause.apply(dcc_instance);
        dcc.css('margin-top', '0');
        dcc.css('margin-bottom', '0');
        dcc.css('border-top-width', '0');
        dcc.css('border-bottom-width', '0');
      },
      play: function () {
        dcc.height(old_height);
        dcc.css('margin-top', old_margin.top);
        dcc.css('margin-bottom', old_margin.bottom);
        dcc.css('border-top-width', old_border.top);
        dcc.css('border-bottom-width', old_border.bottom);
        dcc_instance.play.apply(dcc_instance);
      },
      add: function () {
        dcc_instance.setActiveSlide = rotation_handler_sub;
      },
      remove: function () {
        if (dcc_instance.setActiveSlide === rotation_handler_sub) {
          dcc_instance.setActiveSlide = old_method;
        } else {
          rotation_handler_sub = function () {
            return $.proxy(old_method, this)(activeSlide);
          };
        }
      }
    };
    var node = $('#div-gpt-ad-home_mtf');
    while (node.length) {
      if (node.css("overflow") !== "visible") node.css("overflow", "visible");
      try {
        if (node.attr("id").match(/^body_col_\d+$/)) break;
      } catch (e) {
        // Do nothing. This failed because the element didn't have an "id" attr.
      }
      node = node.parent();
    }
    zindex = 1;
  } else {
    // Can't identify DCC. DCC might not be loaded yet. Try again.
    dcc_handler_install_count++;
    window.setTimeout(dcc_install_replacement_handler, 1000);
    track_always("dccnotready");
    return;
  }
  if (slideshow_methods.add) slideshow_methods.add();
  if (cfg.dcc_immediate_inc && !is_inc0) rotations_until_move = 0;

  if (rotations_until_move === null || rotations_until_move < 0) return;

  var mtf = $('#div-gpt-ad-home_mtf');
  var iframe_selector = $('#div-gpt-ad-home_mtf iframe');
  var orig_mtf_width  = mtf.width(),
      orig_mtf_height = mtf.height(),
      orig_iframe_width  = iframe_selector.width(),
      orig_iframe_height = iframe_selector.height();

  var position_handler = function () {
    var dcc_pos = dcc.offset(),
        mtf_pos = mtf.offset();
    var dcc_top    = Math.round(dcc_pos.top),
        dcc_left   = Math.round(dcc_pos.left),
        dcc_width  = Math.round(dcc.outerWidth()),
        dcc_height = Math.round(dcc_type === 'gen2-Syn.FwSlideshow' ? dcc.height() : dcc.outerHeight());
    var mtf_top    = Math.round(mtf_pos.top),
        mtf_left   = Math.round(mtf_pos.left),
        mtf_width  = Math.round(mtf.outerWidth()),
        mtf_height = Math.round(mtf.outerHeight());
    var aspect_height = dcc_type !== 'gen4-Bootstrap' ? Math.round(dcc_width * 9 / 16) : dcc_height;

    if (dcc_mode && (mtf_top   !== dcc_top   || mtf_left   !== dcc_left ||
                     mtf_width !== dcc_width || mtf_height !== aspect_height ||
                     dcc_height !== aspect_height)) {
      dcc_type === 'gen2-Syn.FwSlideshow' ? dcc.height(aspect_height) : dcc.parent().outerHeight(aspect_height);
      mtf.width(dcc_width);
      mtf.height(aspect_height);
      iframe_selector.width(dcc_width);
      iframe_selector.height(aspect_height);
      mtf.offset({top: dcc_top, left: dcc_left});
      apunit_resize();
    }
  };

  var dcc_remove = function () {
    if (!dcc_mode) return;
    dcc_mode = false;
    if (!cfg.dcc_again_after_close) {
      if (slideshow_methods.remove) slideshow_methods.remove();
    }
    $('#div-gpt-ad-home_mtf-close').remove();
    mtf.css('position', 'static');
    mtf.width(orig_mtf_width);
    mtf.height(orig_mtf_height);
    iframe_selector.width(orig_iframe_width);
    iframe_selector.height(orig_iframe_height);
    mtf.css('zIndex', 'auto');
    mtf.parent().height('auto');
    last_top = last_left = last_width = last_height = null;
    should_handle = false;
    if ($(window.parent).off) {
      handlers_installed = false;
      $(window.parent).off('resize', position_handler);
      $(window.parent).off('scroll', position_handler);
    }
    if (position_check_interval !== null) window.parent.clearInterval(position_check_interval);
    position_check_interval = null;
    apunit_resize();
    slideshow_methods.play();
  }

  var closure_cleanup = function closure_cleanup() {
    dcc_remove();
    listener_remove(window, "unload", closure_cleanup);
    closure_cleanup = dcc_remove = rotations_until_move = dcc_type = dcc = slides = slideshow = num_slides =
    viewed_slides = dcc_replace = position_handler = position_check_interval = handlers_installed = should_handle = slideshow_methods = null;
  }
  listener_attach(window, "unload", closure_cleanup);

  dcc_replace = function () {
    if (dcc_mode) return;
    if (!should_handle) return;
    dcc_mode = true;

    try {
      slideshow_methods.pause();
    } catch (e) {
      track_always("dccpauseerror", {"message": e.message});
    }

    window.clearTimeout(fallback_timer);
    fallback_timer = null;

    if (!cfg.static_ad_in_dcc) staticad_destroy();

    position_handler();
    mtf.css('zIndex', zindex);
    mtf.parent().height(0);

    var btn = document.createElement('a');
    btn.style.position = 'absolute';
    btn.style.fontSize = '1.5em';
    btn.style.top = "0";
    btn.style.right = "0";
    btn.style.margin = '0';
    btn.style.width = '1.6em';
    btn.style.background = 'white';
    btn.style.color = '#666';
    btn.style.fontFamily = 'sans-serif';
    btn.style.cursor = 'pointer';
    btn.style.padding = '2px';
    btn.style.textAlign = 'center';
    btn.style.opacity = 0.7;
    btn.style.textDecoration = "none";
    btn.onclick = function() {
      dcc_remove();
      track_always("dccclose");
    };
    btn.onmouseover = function () {
      btn.style.background = 'gray';
    };
    btn.onmouseout = function () {
      btn.style.background = 'white';
    };
    var close_widget = null;
    if (dcc_type.match(/^gen4-/)) {
      close_widget = document.createElement("span");
      close_widget.className = "ss-icon ss-delete";
    } else {
      close_widget = document.createTextNode('x');
    }
    btn.appendChild(close_widget);
    btn.id = 'div-gpt-ad-home_mtf-close';
    $('#div-gpt-ad-home_mtf').append(btn);
    track_throttled("dcc");

    if (cfg.autoplay_mode === 'inviewport' && !has_started) {
      content_player.pause(false);
    }
  };

  // 4.5s is the amount of time it takes the DCC to rotate a slide on Gen4. If we're in the
  // background tab, the slides don't rotate, so we ensure it still happens at max slides.
  fallback_timer = window.setTimeout(dcc_replace, cfg.dcc_immediate_inc && !is_inc0 ? 5000 : max_slides * 4500);
  dcc_handler_installed = true;
}

function eventlistener_override(subject_window, subject) {
  var old_add = subject.prototype.addEventListener;
  if (!old_add) return;
  var disable = false; // In case someone else overrides addEventListener after we do such that we cannot re-install the old handler.
  var new_add = function() {
    var args = Array.prototype.slice.call(arguments);
    var obj = (typeof this === "object" && this.constructor === Window) ? subject_window : this;
    var res = old_add.apply(obj, args);
    if (disable) return res;
    if (!args[0].match(/unload$/i) && typeof args[1] === "function" && args[1].constructor !== subject_window.Function) {
      debug_report("AddEventListener: " + args[0]);
      var that = this;
      var cleanup_method = function() {
        try {
          if (args[1].constructor === this.Function) {
            var actual_window = this;
            // TODO: don't use closures for cleanup. Save in window and add removeEventListener with one unload event for cleanup.
            var closure_cleanup = function closure_cleanup() {
              debug_report("removing eventListener: " + args[0]);
              listener_remove(that, args[0], args[1]);
              listener_remove(actual_window, "unload", closure_cleanup);
              closure_cleanup = actual_window = that = args = res = null;
            };
            listener_attach(this, "unload", closure_cleanup);
            return true;
          }
        } catch(e) {}
      };
      if (iterate_childframes(subject_window, cleanup_method)) return;
      iterate_selfandparents(subject_window, cleanup_method);
    }
    return res;
  };
  subject.prototype.addEventListener = new_add;
  var subject_inscope = subject;
  var cleanup = function cleanup() {
    debug_report("removing overridden addEventListener handler");
    disable = true;
    if (subject_inscope.prototype.addEventListener === new_add) {
      debug_report("removing overridden addEventListener handler: success");
      subject_inscope.prototype.addEventListener = old_add;
    }
    listener_remove(window, "unload", cleanup);
    cleanup = subject_window = subject = new_add = old_add = subject_inscope = null;
  }
  listener_attach(window, "unload", cleanup);
}

function timeouts_override(subject_window, method) {
  if (subject_window['synap_timeouts_' + method]) return;
  subject_window['synap_timeouts_' + method] = true;
  var old_set = subject_window["set" + method];
  if (!old_set) return;
  var disable = false; // In case someone else overrides our method after we do such that we cannot re-install the old handler.
  var new_set = function() {
    var args = Array.prototype.slice.call(arguments);
    var res = old_set.apply(subject_window, arguments);
    if (disable) return res;
    if ((typeof args[0] === "function" && args[0].constructor !== subject_window.Function)
      || (typeof args[0] === "string" && args[0].constructor.constructor !== subject_window.Function)
      || subject_window.synap_adframe_timeouts) {
      //debug_report("set" + method + " #" + res);
      var that = this;
      var cleanup_method = function() {
        try {
          if ((typeof args[0] === "function" && args[0].constructor === this.Function)
            || (typeof args[0] === "string" && args[0].constructor.constructor === this.Function)) {
            if (this.synap_adframe_timeouts) {
              if (!this.synap_adframe_timeouts[method]) this.synap_adframe_timeouts[method] = {};
              this.synap_adframe_timeouts[method][res] = subject_window;
            } else {
              var actual_window = this;
              var closure_cleanup = function closure_cleanup() {
                debug_report("removing " + method + " #" + res);
                subject_window["clear" + method].call(subject_window, res);
                listener_remove(actual_window, "unload", closure_cleanup);
                closure_cleanup = actual_window = that = args = res = null;
              };
              listener_attach(actual_window, "unload", closure_cleanup);
            }
            return true;
          }
        } catch(e) {}
      };
      if (subject_window.synap_adframe_timeouts) {
        // it's our frame
        cleanup_method.call(subject_window);
      } else {
        // gotta find the frame
        if (iterate_childframes(subject_window, cleanup_method)) return;
        iterate_selfandparents(subject_window, cleanup_method);
      }
    }
    return res;
  };
  subject_window["set" + method] = new_set;
  var saved_autoplay_window = window;
  var unload_handler = function unload_handler() {
    if (disable) return; // somehow this still gets called.
    debug_report("removing overridden set" + method + " handler");
    disable = true;
    if (subject_window["set" + method] === new_set) {
      debug_report("removing overridden set" + method + " handler: success");
      delete subject_window['synap_timeouts_' + method];
      subject_window["set" + method] = old_set;
    }
    listener_remove(saved_autoplay_window, "unload", unload_handler);
    if (subject_window !== saved_autoplay_window) listener_remove(subject_window, "unload", unload_handler);
    unload_handler = subject_window = method = new_set = old_set = saved_autoplay_window = null;
  }
  listener_attach(saved_autoplay_window, "unload", unload_handler);
  if (subject_window !== saved_autoplay_window) listener_attach(subject_window, "unload", unload_handler);
}

function references_clean(subject, source_window) {
  debug_report("references_clean");
  for (var k in subject) {
    try {
      if (subject[k].constructor === source_window.Function || subject[k].constructor.constructor === source_window.Function) {
        debug_report("cleaning reference: " + k);
        subject[k] = null;
      }
    } catch(e) {}
  }
}

function iterate_childframes(current_window, method) {
  try {
    if (current_window && current_window.frames && current_window.frames.length > 0) {
      for (var i=0;i<current_window.frames.length;i++) {
        if (method.call(current_window.frames[i])) return;
        iterate_childframes(current_window.frames[i], method);
      }
    }
  } catch(e) {}
}

function iterate_selfandparents(current, method) {
  do {
    try {
      if (current) {
        if (method.call(current)) return true;
      }
    } catch(e) {}
  } while (current && current.parent && current !== current.parent && (current = current.parent));
}

function iterate_selfandparentnodes(current, method) {
  do {
    try {
      if (current) {
        if (method.call(current)) return true;
      }
    } catch(e) {}
  } while (current && current.parentNode && current !== current.parentNode && (current = current.parentNode));
}

function adtag_updateurls(tags) {
  for (var i=0;i<tags.length;i++) {
    if (typeof tags[i].url === "object") {
      for (var size_class in tags[i].url) {
        tags[i]['url'][size_class] = adtag_replace(tags[i]['url'][size_class]);
      }
    } else {
      tags[i].url = adtag_replace(tags[i].url);
    }
  }
}

function adtag_replace(tag) {
  return tag.replace(/__page-url__/g, encodeURIComponent(origin))
            .replace(/__domain__/g, encodeURIComponent(domain))
            .replace(/__dfpcid__/g, encodeURIComponent('56494945772'.replace(/^[%]ecid!$/g, '')))
            .replace(/__dfpadunit__/g, encodeURIComponent(dfp_adunit))
            .replace(/__dfpclient__/g, encodeURIComponent(dfp_client))
            .replace(/__browser__/g, encodeURIComponent(browser_class))
            .replace(/__crossdomain__/g, is_in_crossdomain_frame ? "1" : "0")
            .replace(/__flash__/g, "__item-flashstate__")
            .replace(/__player-width__/g, "__item-playerwidth__")
            .replace(/__player-height__/g, "__item-playerheight__");
}

function protocol_get() {
  try {
    if (window.location.protocol.match(/^https?:$/)) return window.location.protocol;
  } catch (e) {}
  return origin.match(/^https:/) ? "https:" : "http:";
}

function iframe_findfromwindow(current_window) {
  try {return current_window.frameElement} catch(e) {}
  return null;
}

function framestate_fix() {
  try {
    // Ensure we're in a real friendly frame
    if (browser_class === "chrome" && window.location.protocol !== "http:" && window.location.protocol !== "https:") {
      track_throttled("badframe", {"url": window.location.href});
      var cur_window = window;
      var container;
      while (cur_window.location.protocol !== "http:" && cur_window.location.protocol !== "https:") {
        container = iframe_findfromwindow(cur_window);
        if (container === null) return false;
        cur_window = cur_window.parent;
      }
      if (container !== null && container.width && container.height && (!container.className || container.className !== "apReplacementFrame")) {
        var content = window.document.documentElement.outerHTML;
        cur_window.setTimeout(function () {
          var new_frame = window.document.createElement("iframe");
          new_frame.width = container.width;
          new_frame.height = container.height;
          new_frame.className = "apReplacementFrame"; // prevents recursion
          container.parentNode.insertBefore(new_frame, container);
          new_frame.contentWindow.document.open("text/html", "replace");
          new_frame.contentWindow.document.write(content);
          new_frame.contentWindow.document.close();
          container.parentNode.removeChild(container);
        }, 1);
        return true;
      } else if (container !== null && container.className && container.className === "apReplacementFrame") {
        track_throttled("unfixedframe", {"url": window.location.href});
      }
    }
  } catch (e) {}
  return false;
}

function adunit_refresh_remove() {
  var current_window = window.parent;
  do {
    var iframe = iframe_findfromwindow(current_window);
    if (iframe === null) return;
    iterate_selfandparentnodes(iframe, function() {
      if (this.id && (this.id.match(/^google_ads_iframe_\//) || this.id.match(/^div-gpt-ad-/))) this.id = "_" + this.id;
      if (this.name && this.name.match(/^google_ads_iframe_\//)) this.name = "_" + this.name;
    });
    if (current_window === window.top) {
      current_window = null;
    } else {
      current_window = current_window.parent;
    }
  } while (current_window !== null);
  return;
}

function node_hasparent(node, parent) {
  if (node === null) return false;
  if (node === parent) return true;
  return node_hasparent(node.parentNode, parent);
}

function gptcompanion_remove(target_window, target_node) {
  if (!target_window.googletag
    || !target_window.googletag.companionAds
    || "function" !== typeof target_window.googletag.companionAds
    || !target_window.googletag.companionAds().ca
    || !target_window.googletag.companionAds().ca.length) return;
  var companions = target_window.googletag.companionAds().ca;
  for (var i=companions.length-1;i>=0;i--) {
    if (companions[i] && companions[i].l && companions[i].l.m) {
      if (node_hasparent(target_node, target_window.document.getElementById(companions[i].l.m))) {
        target_window.googletag.companionAds().ca.splice(i,1);
        debug_report("gptcompanion_remove: removed " + companions[i].l.m);
      }
    }
  }
}

function topdomad_show() {
  if (is_in_crossdomain_frame) return;
  if (topdomad_shown) return;
  topdomad_shown = true;
  var adx_tags = [];
  // Various re-publish-required tag fixes
  var tags = [cfg.ad_tags];
  for (var j=0;j<tags.length;j++) {
    for (var i=tags[j].length - 1;i>=0;i--) {
      if (tags[j][i].id.match(/^google_adex_/)) {
        adx_tags.push(tags[j][i]);
      }
    }
  }
  if (!adx_tags.length > 0) return;
  adx_tags.sort(function (a,b) { return a.id.match(/_backfill$/) ? 1 : b.id.match(/_backfill$/) ? -1 : 0; });
  var cur_window = window;
  var frame = null;
  while (cur_window !== window.top) {
    frame = iframe_findfromwindow(cur_window);
    cur_window = cur_window.parent;
  }
  if (!frame) return;
  var frame_pos = frame.getBoundingClientRect();
  var marker_pos = null;
  var marker = frame;
  do {
    marker_pos = marker.parentNode.getBoundingClientRect();
  } while (frame_pos.top == marker_pos.top && frame_pos.left == marker_pos.left && (marker = marker.parentNode));

  // remove our place from the GPT companion ads slots so IMA doesn't refresh us after out own googima ad attempts.
  gptcompanion_remove(window.top, frame);

  var display_player = function() {
    var container = window.top.document.createElement("div");
    container.id = "synap_c_" + instance_id;
    container.style.position = "absolute";
    container.style.top = marker.offsetTop + "px";
    container.style.left = marker.offsetLeft + "px";
    container.style.height = frame.clientHeight + "px";
    container.style.width = frame.clientWidth + "px";
    var sub_container = window.top.document.createElement("div");
    sub_container.id = "synap_sc_" + instance_id;
    container.appendChild(sub_container);
    marker.parentNode.insertBefore(container, marker);

    //TODO: this all needs redoing
  }
}

function portalcolumn_resizeinstall() {
  if (is_in_crossdomain_frame
    || !window.parent.Syn
    || !window.parent.Syn.ComponentMgr
    || !window.parent.Syn.ComponentMgr.getInstancesByClass) return;

  var units = window.parent.Syn.ComponentMgr.getInstancesByClass("Syn.Ad_Component_Gpt_Unit");
  if (!units) return;
  var frame = iframe_findfromwindow(window);
  if (!frame) return;
  var unit = null;
  for (var i=0;i<units.length;i++) {
    iterate_selfandparentnodes(frame, function() {
      if (this === units[i].el) {
        unit = units[i];
        return true;
      }
    });
    if (unit) break;
  }
  if (!unit) return;

  var sizes = unit.config.tag_configuration.slot;
  // no need to do anything if there is only one slot size
  if (!sizes || !sizes.length || sizes.length < 2) return;
  // order by size
  sizes.sort(function (a,b) {return a[0] < b[0] ? -1 : a[0] > b[0] ? 1 : a[1] < b[1] ? -1 : a[1] > b[1] ? 1 : 0});

  var parent_width = unit.el.clientWidth;
  var resizer = function resizer() {
    if (dcc_mode || parent_width == unit.el.clientWidth) return;
    parent_width = unit.el.clientWidth;
    var target_width, target_height;
    for (var i=0;i<sizes.length;i++) {
      if (sizes[i][0] <= parent_width) {
        target_width = sizes[i][0];
        target_height = sizes[i][1];
      }
      else {
        break;
      }
    }
    frame.width = target_width;
    frame.height = target_height;
    frame.parentNode.parentNode.style.width = frame.style.width = frame.width + "px";
    frame.parentNode.parentNode.style.height = frame.style.height = frame.height + "px";
  };
  listener_attach(window.parent, "resize", resizer);
  var closure_cleanup = function closure_cleanup() {
    listener_remove(window.parent, "resize", resizer);
    listener_remove(window, "unload", closure_cleanup);
    closure_cleanup = resizer = units = frame = unit = sizes = null;
  }
  listener_attach(window, "unload", closure_cleanup);
}

function gpt_resizeinstall() {
  if (window.parent === window.top) return;
  var resizer = function resizer() {
    var gptframe = iframe_findfromwindow(window);
    if (!gptframe) return;
    var parentframe = iframe_findfromwindow(window.parent);
    if (!parentframe) return;
    gptframe.width = parentframe.clientWidth;
    gptframe.height = parentframe.clientHeight;
  }
  var closure_cleanup = function closure_cleanup() {
    listener_remove(window.parent, "resize", resizer);
    listener_remove(window, "unload", closure_cleanup);
    closure_cleanup = resizer = null;
  }
  listener_attach(window.parent, "resize", resizer);
  resizer();
}

function border_create() {
  var top = document.createElement("div"),
      bot = document.createElement("div"),
      lft = document.createElement("div"),
      rgt = document.createElement("div");
  top.id = "topBorder";
  bot.id = "botBorder";
  lft.id = "lftBorder";
  rgt.id = "rgtBorder";
  top.style.backgroundColor = bot.style.backgroundColor = lft.style.backgroundColor = rgt.style.backgroundColor = cfg.border_color;
  var cont = document.getElementById("playerContainer");
  cont.parentNode.insertBefore(top, cont);
  cont.parentNode.insertBefore(bot, cont);
  cont.parentNode.insertBefore(lft, cont);
  cont.parentNode.insertBefore(rgt, cont);
}

function startup() {
  if ("border_color" in cfg && cfg.border_color !== null && cfg.border_color !== "none") {
    border_create();
  }
  if (cfg.stop_after_mins > 0) {
    window.setTimeout(function() { stop_after_mode = true; }, cfg.stop_after_mins * 60000);
  }
  if (cfg.resize_gpt) gpt_resizeinstall();
  if (browser_features.ie || browser_class === "edge") {
    cfg.background_ads = false;
    if (cfg.timed_ad_break_secs > 0) cfg.timed_ad_break_secs = Math.max(15, cfg.timed_ad_break_secs);
  }
  if (browser_features.supportsWebAudio) {
    webaudio_context = new (window.AudioContext || window.webkitAudioContext)();
    if (webaudio_context) {
      webaudio_gain = webaudio_context.createGain();
      webaudio_gain.connect(webaudio_context.destination);
      webaudio_gain.gain.value = audiomode_starts_muted[cfg.audio_mode] ? 0 : 1;
    }
  }

  portalcolumn_resizeinstall();

  // Various re-publish-required tag fixes
  var tags = [cfg.ad_tags, cfg.large_ad_tags];
  for (var j=0;j<tags.length;j++) {
    for (var i=tags[j].length - 1;i>=0;i--) {
      if (tags[j][i].id.match(/^liverail/) || tags[j][i].id.match(/^rockyou_4$/)) {
        tags[j].splice(i,1);
      } else if (tags[j][i].id.match(/^rockyou_5$/)) {
        tags[j][i].id = "springserve_rockyou_flash";
        tags[j][i].url = "//vid.springserve.com/vast/43117?w=__player-width__&h=__player-height__&cb=__random-number__&mute=1&ap=1&vid=__item-id__&vt=__item-title__&kwds=__item-keywords__&zid=__dfpcid__&sid=__dfpadunit__&url=__page-url__&v_url=__item-srcurl__&prefetch=__item-isprefetch__&browser=__browser__&flash=__flash__&vpaid=__item-vpaid__&autoplay=__item-flashautoplay__&adunit=__dfpadunit__&flashok=__item-flashok__&crossdomain=__crossdomain__&client=__dfpclient__&dur=__item-realduration__&sizebucket=__item-sizebucket__&dfpcid=__dfpcid__&testbucket=__item-bucket__&inview=__item-viewable__"
;
      } else if (tags[j][i].id.match(/^adx_/) && !tags[j][i].id.match(/^adx_(?:tds|toshiba)/)) {
        var is_backfill = tags[j][i].id.match(/_backfill$/);
        tags[j][i].id = "google_adex_syndication" + (is_backfill ? "_backfill" : "");
        tags[j][i].url = is_backfill ? {
   "default": "//pubads.g.doubleclick.net/gampad/ads?sz=640x383&iu=/5284/syn.synacorsyndication/video_adex_backfill&ciu_szs=300x250&impl=s&gdfp_req=1&env=vp&output=xml_vast3&unviewed_position_start=1&url=__domain__&description_url=__page-url__&correlator=__timestamp__&cust_params=dfpcid%3D__dfpcid__%26dfpadunit%3D__dfpadunit__%26sizebucket%3D__item-sizebucket__%26dfpclient%3D__dfpclient__%26autoplaydomain%3D__domain__%26browserclass%3D__browser__%26autoplaybucket%3D__item-bucket__"
}
 : {
   "default": "//pubads.g.doubleclick.net/gampad/ads?sz=640x383&iu=/5284/syn.synacorsyndication/video_adex&ciu_szs=300x250&impl=s&gdfp_req=1&env=vp&output=xml_vast3&unviewed_position_start=1&url=__domain__&description_url=__page-url__&correlator=__timestamp__&cust_params=dfpcid%3D__dfpcid__%26dfpadunit%3D__dfpadunit__%26sizebucket%3D__item-sizebucket__%26dfpclient%3D__dfpclient__%26autoplaydomain%3D__domain__%26browserclass%3D__browser__%26autoplaybucket%3D__item-bucket__"
}
;
      } else if (tags[j][i].id.match(/^google_adex_/)) {
        if (typeof tags[j][i].url === "string") {
          if (!tags[j][i].url.match(/cust_params=/))      tags[j][i].url += "&cust_params=dfpcid%3D__dfpcid__%26dfpadunit%3D__dfpadunit__";
          if (!tags[j][i].url.match(/sizebucket%3D/))     tags[j][i].url += "%26sizebucket%3D__item-sizebucket__";
          if (!tags[j][i].url.match(/dfpclient%3D/))      tags[j][i].url += "%26dfpclient%3D__dfpclient__";
          if (!tags[j][i].url.match(/autoplaydomain%3D/)) tags[j][i].url += "%26autoplaydomain%3D__domain__";
          if (!tags[j][i].url.match(/browserclass%3D/))   tags[j][i].url += "%26browserclass%3D__browser__";
          if (!tags[j][i].url.match(/autoplaybucket%3D/)) tags[j][i].url += "%26autoplaybucket%3D__item-bucket__";
          tags[j][i].url.replace(/output=xml_vast2/, "output=xml_vast3");
        } else if (typeof tags[j][i].url === "object") {
          for (var type in tags[j][i].url) {
            if (!tags[j][i].url[type].match(/cust_params=/))      tags[j][i].url[type] += "&cust_params=dfpcid%3D__dfpcid__%26dfpadunit%3D__dfpadunit__";
            if (!tags[j][i].url[type].match(/sizebucket%3D/))     tags[j][i].url[type] += "%26sizebucket%3D__item-sizebucket__";
            if (!tags[j][i].url[type].match(/dfpclient%3D/))      tags[j][i].url[type] += "%26dfpclient%3D__dfpclient__";
            if (!tags[j][i].url[type].match(/autoplaydomain%3D/)) tags[j][i].url[type] += "%26autoplaydomain%3D__domain__";
            if (!tags[j][i].url[type].match(/browserclass%3D/))   tags[j][i].url[type] += "%26browserclass%3D__browser__";
            if (!tags[j][i].url[type].match(/autoplaybucket%3D/)) tags[j][i].url[type] += "%26autoplaybucket%3D__item-bucket__";
            tags[j][i].url[type].replace(/output=xml_vast2/, "output=xml_vast3");
          }
        }
      } else if (tags[j][i].id.match(/^spotxchange_/)) {
        ""; // needs to be in output or template won't save
        if ("synacorsyndication" === "" || "177135" === "") {
          tags[j].splice(i,1); // remove spotx if template params exist, but are empty
          continue;
        }
        if (typeof tags[j][i].url === "string") {
          if (!tags[j][i].url.match(/content_id=/))      tags[j][i].url += "&content_id=__dfpcid__&custom[cid]=__domain__&custom[dfpadunit]=__dfpadunit__";
          if (!tags[j][i].url.match(/custom\[flash\]=/)) tags[j][i].url += "&custom[flash]=__item-allowflashonly__&custom[prefetch]=__item-isprefetch__";
        } else if (typeof tags[j][i].url === "object") {
          for (var type in tags[j][i].url) {
            if (!tags[j][i].url[type].match(/content_id=/))      tags[j][i].url[type] += "&content_id=__dfpcid__&custom[cid]=__domain__&custom[dfpadunit]=__dfpadunit__";
            if (!tags[j][i].url[type].match(/custom\[flash\]=/)) tags[j][i].url[type] += "&custom[flash]=__item-allowflashonly__&custom[prefetch]=__item-isprefetch__";
          }
        }
      }
    }
  }
  // Various re-publish-required tag fixes (pass 2)
  var tags = [cfg.ad_tags, cfg.large_ad_tags];
  for (var j=0;j<tags.length;j++) {
    for (var i=tags[j].length - 1;i>=0;i--) {
      if (!tags[j][i].id.match(/^(?:google_adex_|adx_)/)) {
        non_adx_tags_present = true;
      }
      if (tags[j][i].id.match(/^springserve_/)) {
        if (typeof tags[j][i].url === "string") {
          if (!tags[j][i].url.match(/prefetch=/))    tags[j][i].url += "&prefetch=__item-isprefetch__&browser=__browser__&flash=__flash__&vpaid=__item-vpaid__&autoplay=__item-flashautoplay__&adunit=__dfpadunit__&flashok=__item-flashok__&crossdomain=__crossdomain__&client=__dfpclient__&dur=__item-realduration__";
          if (!tags[j][i].url.match(/adunit=/))      tags[j][i].url += "&adunit=__dfpadunit__&flashok=__item-flashok__";
          if (!tags[j][i].url.match(/flashok=/))     tags[j][i].url += "&flashok=__item-flashok__";
          if (!tags[j][i].url.match(/crossdomain=/)) tags[j][i].url += "&crossdomain=__crossdomain__";
          if (!tags[j][i].url.match(/client=/))      tags[j][i].url += "&client=__dfpclient__";
          if (!tags[j][i].url.match(/dur=/))         tags[j][i].url += "&dur=__item-realduration__";
          if (!tags[j][i].url.match(/sizebucket=/))  tags[j][i].url += "&sizebucket=__item-sizebucket__";
          if (!tags[j][i].url.match(/dfpcid=/))      tags[j][i].url += "&dfpcid=__dfpcid__";
          if (!tags[j][i].url.match(/testbucket=/))  tags[j][i].url += "&testbucket=__item-bucket__";
          if (!tags[j][i].url.match(/inview=/))      tags[j][i].url += "&inview=__item-viewable__";
        } else if (typeof tags[j][i].url === "object") {
          for (var type in tags[j][i].url) {
            if (!tags[j][i].url[type].match(/prefetch=/))    tags[j][i].url[type] += "&prefetch=__item-isprefetch__&browser=__browser__&flash=__flash__&vpaid=__item-vpaid__&autoplay=__item-flashautoplay__&adunit=__dfpadunit__&flashok=__item-flashok__&crossdomain=__crossdomain__&client=__dfpclient__&dur=__item-realduration__";
            if (!tags[j][i].url[type].match(/adunit=/))      tags[j][i].url[type] += "&adunit=__dfpadunit__&flashok=__item-flashok__";
            if (!tags[j][i].url[type].match(/flashok=/))     tags[j][i].url[type] += "&flashok=__item-flashok__";
            if (!tags[j][i].url[type].match(/crossdomain=/)) tags[j][i].url[type] += "&crossdomain=__crossdomain__";
            if (!tags[j][i].url[type].match(/client=/))      tags[j][i].url[type] += "&client=__dfpclient__";
            if (!tags[j][i].url[type].match(/dur=/))         tags[j][i].url[type] += "&dur=__item-realduration__";
            if (!tags[j][i].url[type].match(/sizebucket=/))  tags[j][i].url[type] += "&sizebucket=__item-sizebucket__";
            if (!tags[j][i].url[type].match(/dfpcid=/))      tags[j][i].url[type] += "&dfpcid=__dfpcid__";
            if (!tags[j][i].url[type].match(/testbucket=/))  tags[j][i].url[type] += "&testbucket=__item-bucket__";
            if (!tags[j][i].url[type].match(/inview=/))      tags[j][i].url[type] += "&inview=__item-viewable__";
          }
        }
      }
    }
  }

  // remove static ad if template params exist, but are empty
  if ("/00/87/39/uat_73987" === "" && cfg.static_ad_tag && cfg.static_ad_tag.match(/contango_tag_path/)) {
    cfg.static_ad_tag = null;
  } else if ("/00/87/39/uat_73987" !== "") {
    cfg.static_ad_tag = "<!-- BEGIN TECHNORATI MEDIA TAG --><scri" + "pt type='text/javascript'>document.write('<scri' + 'pt type=\"text/javascript\" src=\"' + (document.location.protocol == 'https:' ? 'https://uat-secure.technoratimedia.com' : ('http:' + '//ad-cdn.technoratimedia.com')) + '/00/87/39/uat_73987.js?ad_size=300x250&pub_code=56494945772\"></scri' + 'pt>');</scri" + "pt><!-- END TECHNORATI MEDIA TAG -->";
  }

  if (framestate_fix()) return;

  if (cfg.anti_refresh) adunit_refresh_remove();

  apunit_viewable_if_idle();

  iterate_selfandparents(window, function() {
    if (this.Window      && this.Window.prototype.hasOwnProperty("addEventListener"))      eventlistener_override(this, this.Window);
    if (this.Element     && this.Element.prototype.hasOwnProperty("addEventListener"))     eventlistener_override(this, this.Element);
    if (this.Node        && this.Node.prototype.hasOwnProperty("addEventListener"))        eventlistener_override(this, this.Node);
    if (this.EventTarget && this.EventTarget.prototype.hasOwnProperty("addEventListener")) eventlistener_override(this, this.EventTarget);
    timeouts_override(this, "Timeout");
    timeouts_override(this, "Interval");
  });

  for (var i=0; i<cfg.prefix.length; i++) {
    if (cfg.prefix[i] === "a") {
      pread_num++;
    } else {
      tail_start++;
      pre_ads.push(pread_num);
      playlist_spec.push(cfg.prefix[i]);
      pread_num = 0;
    }
  }
  for (var i=0; i<cfg.tail.length; i++) {
    if (cfg.tail[i] === "a") {
      pread_num++;
    } else {
      pre_ads.push(pread_num);
      playlist_spec.push(cfg.tail[i]);
      pread_num = 0;
    }
  }
  if (pread_num) pre_ads.push(pread_num);

  adtag_updateurls(cfg.ad_tags);
  adtag_updateurls(cfg.large_ad_tags);

  for (var i=0;i<cfg.ad_tags.length;i++) {
    if (cfg.log_aceview && cfg.ad_tags[i].av) log_aceview = true;
  }
  for (var i=0;i<cfg.large_ad_tags.length;i++) {
    if (cfg.log_aceview && cfg.large_ad_tags[i].av) log_aceview = true;
  }

  if (cfg.fill_window) document.getElementById("playerContainer").style.height = window_innerHeight(window) + "px";
  loadingcover_show();
  staticad_show();

  var vam_callbacks = [];
  if (cfg.dynamiccontent && protocol_get() !== "https:") { // For now, dynamic content doesn't work on https
    for (var vamid in cfg.vamurls) {
      vam_jsonp_requests_pending++;
      var vam_jsonp_fn_name = "vam_jsonp_recv_"+vamid;
      vam_callbacks.push(vam_jsonp_fn_name);
      window[vam_jsonp_fn_name] = (function(vamid){ return function(data){ vam_jsonp_recv(vamid, data); }; })(vamid);
      var jsonp = document.createElement("script");
      jsonp.src = (cfg.vamurls[vamid].match(/^\/\//) ? protocol_get() : "") + cfg.vamurls[vamid] + (cfg.vamurls[vamid].match(/\?/) ? "&" : "?") + "callback="+vam_jsonp_fn_name;
      var head = document.getElementsByTagName("head")[0];
      head.appendChild(jsonp);
    }
    var timeout_ms = vam_jsonp_requests_pending * 2000;
    vam_jsonp_failsafe = setTimeout(function() {
      window.clearTimeout(vam_jsonp_failsafe);
      vam_jsonp_failsafe = null;
      track_throttled("vamtimeout", {"timeoutms": timeout_ms});
      apunit_init();
    }, timeout_ms);
  }

  var closure_cleanup = function () {
    listener_remove(window, "unload", closure_cleanup);
    listener_remove(window, "resize", apunit_resize);
    closure_cleanup = tags = null;
    while (retry_timeouts.length) {
      window.clearTimeout(retry_timeouts.pop());
    }
    if (ads_start_timeout !== null) {
      window.clearTimeout(ads_start_timeout);
      ads_start_timeout = null;
    }
    if (ads_start_retry_timeout !== null) {
      window.clearTimeout(ads_start_retry_timeout);
      ads_start_retry_timeout = null;
    }
    if (simultaneous_ad_loader_timeout !== null) {
      window.clearTimeout(simultaneous_ad_loader_timeout);
      simultaneous_ad_loader_timeout = null;
    }
    if (attempt_timeout !== null) {
      window.clearTimeout(attempt_timeout);
      attempt_timeout = null;
    }
    debug_report("unloading all players");
    content_player.tearDown();
    while (ad_players.length) {
      ad_players.pop().destroy();
    }
    track_throttled("unloadstate", {time_on_page_ms: timestamp() - load_time, state:state, state_duration_ms:Math.floor(timestamp() - state_time)});
    staticad_destroy();

    if (staticfallback_player !== null) {
      staticfallback_player.destroy();
      staticfallback_player = null;
    }

    content_player.destroy();
    content_player = null;
    // break circular reference
    DisplayFrame.prototype.constructor = StaticAdFrame.prototype.constructor = null;
    DisplayFrame = StaticAdFrame = null;
    while (vam_callbacks.length) {
      window[vam_callbacks.pop()] = null;
    }
  }
  listener_attach(window, "unload", closure_cleanup);
  listener_attach(window, "resize", apunit_resize);

  if (browser_class === "chrome" && !apunit_hasfocus()) {
    if (focus_wait) return;
    focus_wait = true;
    track_throttled("focuswait", "startup");
    var focuswait_method;
    focuswait_method = function () {
      if (apunit_hasfocus()) {
        focus_wait = false;
        track_throttled("focusgain", "startup");
        listener_remove(document, "visibilitychange", focuswait_method);
        players_create();
      }
    }
    listener_attach(document, "visibilitychange", focuswait_method);
    return;
  }
  players_create();
}

function flash_test() {
  if (cfg.disable_flash) {
    can_load_flash = false;
    return;
  }
  var started = false;
  var timeout = null;
  var callback = "flashnotify-" + instance_id;
  listener_remove(window, "load", flash_test);
  var test = document.createElement("object");
  var param1 = document.createElement("param");
  param1.name = "flashvars";
  param1.value = "callback=" + callback;
  var param2 = document.createElement("param");
  param2.name = "allowScriptAccess";
  param2.value = "always";
  test.appendChild(param1);
  test.appendChild(param2);
  test.data = protocol_get() + "//synacor.autoplay-plugins.static-origin.syn-cdn.com/FlashDetect.swf";
  test.type = "application/x-shockwave-flash";
  var error, load, timeout, proceed;
  proceed = function proceed(entry) {
    if (started) return;
    started = true;
    delete window[callback];
    window.clearTimeout(timeout);
    listener_remove(test, "error", error);
    listener_remove(test, "load", load);
    timeout = error = load = timeout = null;
    test.parentNode.removeChild(test);
    if (entry === "load") {
      can_load_flash = true;
      track_throttled("flash");
    } else if (entry === "error") {
      can_load_flash = false;
      track_throttled("noflash");
    } else {
      track_throttled("flashtimeout");
    }
  }
  error = function error(e) {
    proceed("error");
  };
  load = function load(e) {
    proceed("load");
  };
  window[callback] = function(version) {flash_version = version;proceed("load");};
  listener_attach(test, "error", error);
  timeout = window.setTimeout(proceed, 15000);
  document.body.appendChild(test);
}

if (!blacklisted()) {
  flash_test();
  startup();
} else if (window.parent && window.parent.$) {
  try {
    window.parent.$('#div-gpt-ad-home_mtf').hide();
  } catch (e) {}
}
</script>


<script src="https://tpc.googlesyndication.com/pagead/js/r20171129/r20110914/activeview/osd_listener.js"></script><script type="text/javascript">osdlfm(-1,'','B1cOkbE8oWoSvBpeAigOqn7zABAAAAAAQATgByAEJwAIC4AIA4AQBoAYf0ggFCIBhEAE','',1336704916,true,'ud\x3d1\x26la\x3d0\x26alp\x3dxai\x26alh\x3d957202545\x26',3,'CAASEuRoCNwbMDNG4zb9z3JFsCSekA','https://pagead2.googlesyndication.com/pcs/activeview?xai\x3dAKAOjsusolULBuMpWJvpBH80SjoIG4fu-vwblJ9miBIjQo4BI1hn_cvtMeUjvT1MtE2IPx5cVJVeBMtwVFmMmBT5Gvq_Yhs_O4wL57Y\x26sig\x3dCg0ArKJSzMR6pOPawI4DEAE');</script><script>if (window.top && window.top.postMessage) {window.top.postMessage('{"googMsgType":"adpnt"}','*');}</script><div style="bottom:0;right:0;width:300px;height:250px;background:initial !important;position:absolute !important;max-width:100% !important;max-height:100% !important;pointer-events:none !important;image-rendering:pixelated !important;z-index:2147483647;background-image:url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACsAAAAWBAMAAACrl3iAAAAABlBMVEUAAAD+AciWmZzWAAAAAnRSTlMAApidrBQAAAB+SURBVBjTdZEBDsAgCAPLD/r/1xqkBUw2tkSJtTs64LuiCvlOB/Cesp/qUidh3nWXCkp11+p8XvqtHu/pmgTSisTFrM1driFsMQmhvOnvaMA2xnhfsZxJXVqZPGI0eQ2a+iF1inindBzEzsxIgXgS9JDl7QSHOv4SXP+yt7k/P7oFlJyjmfcAAAAASUVORK5CYII=') !important"></div></body></html>